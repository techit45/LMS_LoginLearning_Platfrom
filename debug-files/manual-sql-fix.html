<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual SQL Fix - Time Format</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 1000px;
            margin: 30px auto;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover { background: #2563eb; }
        .btn.danger { background: #dc2626; }
        .btn.danger:hover { background: #b91c1c; }
        .sql-box {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 15px 0;
            white-space: pre;
        }
        .log {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .success { color: #16a34a; }
        .error { color: #dc2626; }
        .warning { color: #ea580c; }
        .info { color: #0ea5e9; }
        .step { 
            background: #f0f9ff; 
            border-left: 4px solid #0ea5e9; 
            padding: 15px; 
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è Manual SQL Fix - Time Format Issues</h1>
        <p>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ SQL commands ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</p>
        
        <div class="step">
            <h3>Step 1: Execute Raw SQL</h3>
            <p>‡πÉ‡∏ä‡πâ rpc() function ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å SQL ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏ú‡πà‡∏≤‡∏ô Supabase</p>
            <button id="step1Btn" class="btn">üöÄ Execute Raw SQL Fix</button>
        </div>
        
        <div class="step">
            <h3>Step 2: Force Insert New Records</h3>
            <p>‡∏™‡∏£‡πâ‡∏≤‡∏á records ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ time format ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
            <button id="step2Btn" class="btn">‚ûï Insert Fixed Records</button>
        </div>
        
        <div class="step">
            <h3>Step 3: Cleanup Old Records</h3>
            <p>‡∏•‡∏ö records ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å insert ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)</p>
            <button id="step3Btn" class="btn danger">üóëÔ∏è Delete Old Records</button>
        </div>
        
        <div class="step">
            <h3>Step 4: Verify Results</h3>
            <button id="verifyBtn" class="btn">‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</button>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://vuitwzisazvikrhtfthh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1aXR3emlzYXp2aWtyaHRmdGhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzOTU4ODIsImV4cCI6MjA2Njk3MTg4Mn0.VXCqythCUualJ7S9jVvnQUYe9BKnfMvbihtZT5c3qyE';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);
        
        const logElement = document.getElementById('log');
        let originalData = {};
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('th-TH');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        async function step1_RawSQLFix() {
            log('üöÄ Step 1: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏ä‡πâ Raw SQL...', 'info');
            
            try {
                // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ rpc function (‡∏´‡∏≤‡∏Å‡∏°‡∏µ)
                const { data, error } = await supabaseClient.rpc('fix_time_format_records');
                
                if (error) {
                    log(`‚ùå RPC Error: ${error.message}`, 'error');
                    log('üí° RPC function ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏°‡∏µ - ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ Step 2', 'warning');
                } else {
                    log(`‚úÖ RPC Success: ${JSON.stringify(data)}`, 'success');
                }
                
            } catch (error) {
                log(`‚ùå Step 1 Failed: ${error.message}`, 'error');
                log('üí° ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ Step 2 - Force Insert', 'info');
            }
        }
        
        async function step2_ForceInsert() {
            log('‚ûï Step 2: ‡∏™‡∏£‡πâ‡∏≤‡∏á records ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ time format ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á...', 'info');
            
            try {
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô
                const { data: oldRecords, error: fetchError } = await supabaseClient
                    .from('weekly_schedules')
                    .select('*')
                    .in('id', [79, 83]);
                
                if (fetchError) {
                    log(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ: ${fetchError.message}`, 'error');
                    return;
                }
                
                originalData.records = oldRecords;
                log(`üìä ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° ${oldRecords.length} records`, 'info');
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á records ‡πÉ‡∏´‡∏°‡πà
                for (const oldRecord of oldRecords) {
                    const newRecord = {
                        year: oldRecord.year,
                        week_number: oldRecord.week_number,
                        schedule_type: oldRecord.schedule_type,
                        instructor_id: oldRecord.instructor_id,
                        course_id: oldRecord.course_id,
                        day_of_week: oldRecord.day_of_week,
                        time_slot: '08:00', // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô format ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                        start_time: '08:00',
                        end_time: oldRecord.id === 79 ? '09:00' : '12:00',
                        duration: oldRecord.duration,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString(),
                        created_by: oldRecord.created_by
                    };
                    
                    log(`‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á record ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ID ${oldRecord.id}...`, 'info');
                    
                    const { data: insertResult, error: insertError } = await supabaseClient
                        .from('weekly_schedules')
                        .insert(newRecord)
                        .select()
                        .single();
                    
                    if (insertError) {
                        log(`‚ùå Insert failed: ${insertError.message}`, 'error');
                    } else {
                        log(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á record ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ID ${insertResult.id}`, 'success');
                        log(`   ‡πÄ‡∏ß‡∏•‡∏≤: ${insertResult.time_slot} ‚Üí ${insertResult.start_time} ‚Üí ${insertResult.end_time}`, 'success');
                        
                        // ‡πÄ‡∏Å‡πá‡∏ö mapping ‡∏Ç‡∏≠‡∏á record ‡πÄ‡∏Å‡πà‡∏≤ -> ‡πÉ‡∏´‡∏°‡πà
                        if (!originalData.mapping) originalData.mapping = {};
                        originalData.mapping[oldRecord.id] = insertResult.id;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                log('üéâ Step 2 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!', 'success');
                
            } catch (error) {
                log(`üí• Step 2 Error: ${error.message}`, 'error');
            }
        }
        
        async function step3_CleanupOld() {
            log('üóëÔ∏è Step 3: ‡∏•‡∏ö records ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤...', 'warning');
            
            if (!originalData.mapping || Object.keys(originalData.mapping).length === 0) {
                log('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• mapping - ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ', 'error');
                return;
            }
            
            try {
                for (const oldId of [79, 83]) {
                    log(`üóëÔ∏è ‡∏•‡∏ö record ID ${oldId}...`, 'warning');
                    
                    const { error: deleteError } = await supabaseClient
                        .from('weekly_schedules')
                        .delete()
                        .eq('id', oldId);
                    
                    if (deleteError) {
                        log(`‚ùå ‡∏•‡∏ö ID ${oldId} ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${deleteError.message}`, 'error');
                    } else {
                        log(`‚úÖ ‡∏•‡∏ö ID ${oldId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                log('üéâ Step 3 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!', 'success');
                
            } catch (error) {
                log(`üí• Step 3 Error: ${error.message}`, 'error');
            }
        }
        
        async function verifyResults() {
            log('‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢...', 'info');
            
            try {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ records ‡πÄ‡∏Å‡πà‡∏≤‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏´‡∏°
                const { data: oldCheck, error: oldError } = await supabaseClient
                    .from('weekly_schedules')
                    .select('id, time_slot, start_time')
                    .in('id', [79, 83]);
                
                if (oldError) {
                    log(`‚ùå Error checking old records: ${oldError.message}`, 'error');
                } else {
                    log(`üîç Records ‡πÄ‡∏î‡∏¥‡∏° (ID 79, 83): ${oldCheck.length} records found`, oldCheck.length > 0 ? 'warning' : 'success');
                    oldCheck.forEach(record => {
                        log(`   ID ${record.id}: ${record.time_slot} ‚Üí ${record.start_time}`, 'warning');
                    });
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö records ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ time format ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                const { data: newRecords, error: newError } = await supabaseClient
                    .from('weekly_schedules')
                    .select('id, time_slot, start_time, end_time, day_of_week, course_id')
                    .eq('time_slot', '08:00')
                    .eq('day_of_week', 1)
                    .order('id', { ascending: false })
                    .limit(5);
                
                if (newError) {
                    log(`‚ùå Error checking new records: ${newError.message}`, 'error');
                } else {
                    log(`‚úÖ Records ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ time format ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ${newRecords.length} records`, 'success');
                    newRecords.forEach(record => {
                        log(`   ID ${record.id}: ${record.time_slot} ‚Üí ${record.start_time} ‚Üí ${record.end_time} ‚úÖ`, 'success');
                    });
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö records ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ time format
                const { data: allRecords, error: allError } = await supabaseClient
                    .from('weekly_schedules')
                    .select('id, time_slot, start_time')
                    .limit(100);
                
                if (allError) {
                    log(`‚ùå Error checking all records: ${allError.message}`, 'error');
                } else {
                    const problematicRecords = allRecords.filter(record => 
                        !record.time_slot.match(/^[0-9]{2}:[0-9]{2}$/) || 
                        !record.start_time.match(/^[0-9]{2}:[0-9]{2}$/)
                    );
                    
                    if (problematicRecords.length > 0) {
                        log(`‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡∏°‡∏µ records ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ time format: ${problematicRecords.length} records`, 'warning');
                        problematicRecords.slice(0, 5).forEach(record => {
                            log(`   ID ${record.id}: ${record.time_slot} ‚Üí ${record.start_time}`, 'warning');
                        });
                    } else {
                        log('üéâ ‡πÑ‡∏°‡πà‡∏°‡∏µ records ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ time format ‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                    }
                }
                
            } catch (error) {
                log(`üí• Verify Error: ${error.message}`, 'error');
            }
        }
        
        // Event listeners
        document.getElementById('step1Btn').addEventListener('click', step1_RawSQLFix);
        document.getElementById('step2Btn').addEventListener('click', step2_ForceInsert);
        document.getElementById('step3Btn').addEventListener('click', step3_CleanupOld);
        document.getElementById('verifyBtn').addEventListener('click', verifyResults);
        
        // Auto start
        log('üõ†Ô∏è Manual SQL Fix Tool ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'info');
        log('üí° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å Step 2: Force Insert ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å UPDATE ‡∏ñ‡∏π‡∏Å RLS ‡∏ö‡∏•‡πá‡∏≠‡∏Å', 'info');
    </script>
</body>
</html>