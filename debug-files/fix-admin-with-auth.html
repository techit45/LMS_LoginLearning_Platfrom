<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Login-Learning Admin ‡∏î‡πâ‡∏ß‡∏¢ Auth</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: #f9f9f9; padding: 20px; margin: 10px 0; border-radius: 8px; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #45a049; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .warning { background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .info { background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 4px; margin: 10px 0; }
        input { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
    </style>
</head>
<body>
    <h1>üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Login-Learning Admin (‡∏ï‡πâ‡∏≠‡∏á Login)</h1>
    
    <div class="warning">
        <h3>‚ö†Ô∏è ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</h3>
        <ol>
            <li>‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ account ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</li>
            <li>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Login-Learning Admin</li>
            <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</li>
        </ol>
    </div>

    <div id="auth-section" class="card">
        <h3>üîê ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</h3>
        <input type="email" id="email" placeholder="email@example.com" value="techit.y@login-learning.com">
        <input type="password" id="password" placeholder="password" value="">
        <br>
        <button onclick="login()">üö™ ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</button>
        <button onclick="checkAuth()">üë§ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
        <button onclick="logout()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="card">
        <button onclick="checkAdmin()">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Admin</button>
        <button onclick="fixAdmin()">üöÄ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Admin</button>
        <button onclick="checkAllInstructors()">üë• ‡∏î‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <div id="result"></div>

    <script>
        const supabase = window.supabase.createClient(
            'https://vuitwzisazvikrhtfthh.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1aXR3emlzYXp2aWtyaHRmdGhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzOTU4ODIsImV4cCI6MjA2Njk3MTg4Mn0.VXCqythCUualJ7S9jVvnQUYe9BKnfMvbihtZT5c3qyE'
        )

        const targetUserId = '033e1583-465a-4734-b637-53ce3023370c'

        async function login() {
            const result = document.getElementById('result')
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            
            if (!email || !password) {
                result.innerHTML = '<div class="error">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà email ‡πÅ‡∏•‡∏∞ password</div>'
                return
            }

            result.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô...'

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                })

                if (error) throw error

                result.innerHTML = `
                    <div class="success">
                        ‚úÖ ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br>
                        User: ${data.user.email}<br>
                        ID: ${data.user.id}
                    </div>
                `
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Login Error: ${error.message}</div>`
            }
        }

        async function checkAuth() {
            const result = document.getElementById('result')
            result.innerHTML = '‚è≥ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô...'

            try {
                const { data: { user } } = await supabase.auth.getUser()

                if (user) {
                    result.innerHTML = `
                        <div class="info">
                            üë§ ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß<br>
                            Email: ${user.email}<br>
                            ID: ${user.id}
                        </div>
                    `
                } else {
                    result.innerHTML = '<div class="warning">‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</div>'
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`
            }
        }

        async function logout() {
            const result = document.getElementById('result')
            result.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...'

            try {
                const { error } = await supabase.auth.signOut()
                if (error) throw error

                result.innerHTML = '<div class="success">‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß</div>'
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`
            }
        }

        async function checkAdmin() {
            const result = document.getElementById('result')
            result.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...'

            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('user_id, email, full_name, role, is_active')
                    .eq('user_id', targetUserId)

                if (error) throw error

                if (data.length === 0) {
                    result.innerHTML = '<div class="error">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Login-Learning Admin</div>'
                    return
                }

                const admin = data[0]
                const needsFix = admin.full_name !== 'Login-Learning Admin' || !admin.is_active

                result.innerHTML = `
                    <div class="${needsFix ? 'warning' : 'success'}">
                        <h3>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</h3>
                        <ul>
                            <li><strong>ID:</strong> ${admin.user_id}</li>
                            <li><strong>Email:</strong> ${admin.email}</li>
                            <li><strong>Name:</strong> ${admin.full_name} ${admin.full_name !== 'Login-Learning Admin' ? '‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ' : '‚úÖ'}</li>
                            <li><strong>Role:</strong> ${admin.role}</li>
                            <li><strong>Active:</strong> ${admin.is_active} ${!admin.is_active ? '‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ' : '‚úÖ'}</li>
                        </ul>
                        ${needsFix ? '<p><strong>‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç!</strong></p>' : '<p><strong>‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß!</strong></p>'}
                    </div>
                `
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`
            }
        }

        async function fixAdmin() {
            const result = document.getElementById('result')
            result.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...'

            try {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const { data: { user } } = await supabase.auth.getUser()
                if (!user) {
                    result.innerHTML = '<div class="error">‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô!</div>'
                    return
                }

                const { data, error } = await supabase
                    .from('user_profiles')
                    .update({
                        full_name: 'Login-Learning Admin',
                        is_active: true
                    })
                    .eq('user_id', targetUserId)
                    .select()

                if (error) throw error

                result.innerHTML = `
                    <div class="success">
                        <h3>üéâ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
                        <p>‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô full_name ‡πÄ‡∏õ‡πá‡∏ô "Login-Learning Admin"</p>
                        <p>‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô is_active ‡πÄ‡∏õ‡πá‡∏ô true</p>
                        <div class="warning">
                            <strong>üöÄ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ:</strong>
                            <ol>
                                <li>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô</li>
                                <li>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤ (F5)</li>
                                <li>‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô Login-Learning Admin ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß!</li>
                            </ol>
                        </div>
                    </div>
                `

                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                setTimeout(() => {
                    checkAdmin()
                }, 2000)

            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`
            }
        }

        async function checkAllInstructors() {
            const result = document.getElementById('result')
            result.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...'

            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('user_id, email, full_name, role, is_active')
                    .neq('role', 'student')
                    .order('full_name')

                if (error) throw error

                let html = `
                    <div class="info">
                        <h3>üë• ‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (${data.length} ‡∏Ñ‡∏ô):</h3>
                        <ul>
                `

                data.forEach((person, i) => {
                    const status = person.is_active ? 'üü¢' : 'üî¥'
                    html += `<li>${status} <strong>${person.full_name || person.email}</strong> - ${person.role} - ID: ${person.user_id.substring(0, 8)}...</li>`
                })

                html += `
                        </ul>
                        <p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> üü¢ = ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á, üî¥ = ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á</p>
                    </div>
                `

                result.innerHTML = html

            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`
            }
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.onload = () => {
            checkAuth()
        }
    </script>
</body>
</html>