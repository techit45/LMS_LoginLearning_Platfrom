<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Comprehensive Folder Creation Flow Testing</title>
    <script type="module" crossorigin src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 20px; line-height: 1.6; }
        .test-section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .code-block { background-color: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; }
        button { margin: 10px; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .result-container { margin-top: 15px; }
        .company-test { margin: 15px 0; padding: 15px; border-left: 4px solid #007bff; background-color: #f8f9fa; }
        .test-step { margin: 10px 0; padding: 10px; background-color: white; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üß™ Comprehensive Folder Creation Flow Testing</h1>
    <p><strong>Testing Platform:</strong> Login Learning Platform<br>
    <strong>Focus:</strong> Course and Project Google Drive Folder Creation<br>
    <strong>Date:</strong> <span id="test-date"></span></p>

    <div class="test-section info">
        <h2>üîç Test Overview</h2>
        <p>This comprehensive test will verify:</p>
        <ul>
            <li><strong>Course Folder Creation:</strong> Database-driven vs hardcoded approach</li>
            <li><strong>Project Folder Creation:</strong> Direct API calls and authentication</li>
            <li><strong>Authentication Issues:</strong> Import problems and session management</li>
            <li><strong>Company-Specific Flows:</strong> All 5 companies (LOGIN, Meta, Med, EdTech, W2D)</li>
            <li><strong>Error Handling:</strong> Network failures, invalid IDs, missing auth</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>üîß Authentication Setup</h2>
        <button class="btn-primary" onclick="initializeAuth()">Initialize Supabase Connection</button>
        <button class="btn-warning" onclick="testAuthStatus()">Check Authentication Status</button>
        <div id="auth-status" class="result-container"></div>
    </div>

    <div class="test-section">
        <h2>üìö Course Folder Creation Tests</h2>
        <p><strong>Testing Method:</strong> Uses <code>ensureCourseFolderExists()</code> from courseFolderService.js</p>
        
        <div class="company-test">
            <h3>Company-Specific Course Tests</h3>
            <button class="btn-primary" onclick="testCourseFolderCreation('login')">Test LOGIN Company</button>
            <button class="btn-primary" onclick="testCourseFolderCreation('meta')">Test Meta Company</button>
            <button class="btn-primary" onclick="testCourseFolderCreation('med')">Test Med Company</button>
            <button class="btn-primary" onclick="testCourseFolderCreation('edtech')">Test EdTech Company</button>
            <button class="btn-primary" onclick="testCourseFolderCreation('w2d')">Test W2D Company</button>
        </div>
        <div id="course-test-results" class="result-container"></div>
    </div>

    <div class="test-section">
        <h2>üöÄ Project Folder Creation Tests</h2>
        <p><strong>Testing Method:</strong> Direct Edge Function calls with hardcoded folder IDs</p>
        
        <div class="company-test">
            <h3>Company-Specific Project Tests</h3>
            <button class="btn-primary" onclick="testProjectFolderCreation('login')">Test LOGIN Projects</button>
            <button class="btn-primary" onclick="testProjectFolderCreation('meta')">Test Meta Projects</button>
            <button class="btn-primary" onclick="testProjectFolderCreation('med')">Test Med Projects</button>
            <button class="btn-primary" onclick="testProjectFolderCreation('edtech')">Test EdTech Projects</button>
            <button class="btn-primary" onclick="testProjectFolderCreation('w2d')">Test W2D Projects</button>
        </div>
        <div id="project-test-results" class="result-container"></div>
    </div>

    <div class="test-section">
        <h2>üîí Authentication & Import Issues Test</h2>
        <button class="btn-warning" onclick="testImportIssues()">Test Import Problems</button>
        <button class="btn-warning" onclick="testAuthenticationFlows()">Test Authentication Flows</button>
        <div id="auth-test-results" class="result-container"></div>
    </div>

    <div class="test-section">
        <h2>‚ùå Error Scenario Tests</h2>
        <button class="btn-danger" onclick="testInvalidCompany()">Test Invalid Company</button>
        <button class="btn-danger" onclick="testNoAuth()">Test No Authentication</button>
        <button class="btn-danger" onclick="testInvalidFolderIds()">Test Invalid Folder IDs</button>
        <button class="btn-danger" onclick="testNetworkFailure()">Test Network Failure</button>
        <div id="error-test-results" class="result-container"></div>
    </div>

    <div class="test-section">
        <h2>üìä Consistency Analysis</h2>
        <button class="btn-primary" onclick="analyzeConsistency()">Analyze Course vs Project Patterns</button>
        <div id="consistency-results" class="result-container"></div>
    </div>

    <div class="test-section">
        <h2>üèÜ Final Test Report</h2>
        <button class="btn-primary" onclick="generateFinalReport()">Generate Comprehensive Report</button>
        <div id="final-report" class="result-container"></div>
    </div>

    <script>
        // Global test state
        let supabaseClient = null;
        let testResults = {
            auth: {},
            courses: {},
            projects: {},
            errors: {},
            consistency: {}
        };

        // Set current date
        document.getElementById('test-date').textContent = new Date().toLocaleDateString('th-TH');

        // ==========================================
        // üîß AUTHENTICATION FUNCTIONS
        // ==========================================

        async function initializeAuth() {
            const resultDiv = document.getElementById('auth-status');
            try {
                resultDiv.innerHTML = '<div class="info">Initializing Supabase connection...</div>';
                
                // Initialize Supabase client
                const { createClient } = window.supabase;
                supabaseClient = createClient(
                    'https://vuitwzisazvikrhtfthh.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1aXR3emlzYXp2aWtyaHRmdGhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE5MjYzNjUsImV4cCI6MjA0NzUwMjM2NX0.ZLQH7mJR1rYWL9NkGKC4kN9wv3mZF8WoGRzKZ2bQ2xI'
                );

                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    throw new Error(`Auth initialization failed: ${error.message}`);
                }

                if (session) {
                    testResults.auth.initialized = true;
                    testResults.auth.hasSession = true;
                    testResults.auth.userId = session.user.id;
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>‚úÖ Supabase Initialized Successfully</strong><br>
                            User ID: ${session.user.id}<br>
                            Email: ${session.user.email}<br>
                            Session expires: ${new Date(session.expires_at * 1000).toLocaleString('th-TH')}
                        </div>
                    `;
                } else {
                    testResults.auth.initialized = true;
                    testResults.auth.hasSession = false;
                    
                    resultDiv.innerHTML = `
                        <div class="warning">
                            <strong>‚ö†Ô∏è Supabase Initialized but No Active Session</strong><br>
                            You may need to log in to test folder creation functions.
                        </div>
                    `;
                }
            } catch (error) {
                testResults.auth.initialized = false;
                testResults.auth.error = error.message;
                
                resultDiv.innerHTML = `
                    <div class="error">
                        <strong>‚ùå Authentication Initialization Failed</strong><br>
                        Error: ${error.message}
                    </div>
                `;
            }
        }

        async function testAuthStatus() {
            const resultDiv = document.getElementById('auth-status');
            
            if (!supabaseClient) {
                resultDiv.innerHTML = '<div class="warning">Please initialize Supabase connection first.</div>';
                return;
            }

            try {
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();

                let statusHtml = '<div class="test-step"><strong>Authentication Status Check:</strong><br>';
                
                if (sessionError) {
                    statusHtml += `‚ùå Session Error: ${sessionError.message}<br>`;
                }
                
                if (userError) {
                    statusHtml += `‚ùå User Error: ${userError.message}<br>`;
                }

                if (session) {
                    statusHtml += `‚úÖ Active Session Found<br>`;
                    statusHtml += `‚úÖ Access Token Present: ${session.access_token ? 'Yes' : 'No'}<br>`;
                    statusHtml += `‚úÖ User ID: ${session.user.id}<br>`;
                } else {
                    statusHtml += `‚ùå No Active Session<br>`;
                }

                if (user) {
                    statusHtml += `‚úÖ User Object Available<br>`;
                } else {
                    statusHtml += `‚ùå No User Object<br>`;
                }

                statusHtml += '</div>';
                
                resultDiv.innerHTML = statusHtml;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <strong>‚ùå Auth Status Check Failed</strong><br>
                        Error: ${error.message}
                    </div>
                `;
            }
        }

        // ==========================================
        // üìö COURSE FOLDER CREATION TESTS
        // ==========================================

        async function testCourseFolderCreation(company) {
            const resultDiv = document.getElementById('course-test-results');
            
            if (!supabaseClient) {
                resultDiv.innerHTML = '<div class="warning">Please initialize Supabase connection first.</div>';
                return;
            }

            try {
                const testCourseData = {
                    company: company,
                    title: `Test Course ${company.toUpperCase()} - ${Date.now()}`,
                    description: `Test course for ${company} company folder creation`,
                    id: `test-course-${company}-${Date.now()}`
                };

                resultDiv.innerHTML += `
                    <div class="test-step info">
                        <strong>üß™ Testing Course Folder Creation for ${company.toUpperCase()}</strong><br>
                        Course: ${testCourseData.title}<br>
                        Testing database-driven approach via courseFolderService...
                    </div>
                `;

                // Test the company folder configuration retrieval first
                const { data, error } = await supabaseClient.rpc('get_company_drive_folders', {
                    p_company_slug: company
                });

                if (error) {
                    throw new Error(`Database function error: ${error.message}`);
                }

                if (!data?.success) {
                    throw new Error(data?.error || 'Failed to get company folder configuration');
                }

                const folderConfig = {
                    name: data.companyName,
                    root: data.folderIds.main,
                    courses: data.folderIds.courses,
                    projects: data.folderIds.projects
                };

                resultDiv.innerHTML += `
                    <div class="test-step success">
                        <strong>‚úÖ Company Folder Configuration Retrieved</strong><br>
                        Company: ${folderConfig.name}<br>
                        Root Folder ID: ${folderConfig.root}<br>
                        Courses Folder ID: ${folderConfig.courses}<br>
                        Projects Folder ID: ${folderConfig.projects}
                    </div>
                `;

                // Test folder creation API call
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                if (sessionError || !session?.access_token) {
                    throw new Error('Authentication required for folder creation');
                }

                const API_BASE = 'https://vuitwzisazvikrhtfthh.supabase.co/functions/v1/google-drive';
                const response = await fetch(`${API_BASE}/create-topic-folder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`,
                    },
                    body: JSON.stringify({
                        parentFolderId: folderConfig.courses,
                        topicName: testCourseData.title,
                        topicType: 'course'
                    }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API call failed: ${response.status} - ${errorText}`);
                }

                const result = await response.json();

                testResults.courses[company] = {
                    success: true,
                    folderConfig,
                    apiResult: result,
                    testCourseData
                };

                resultDiv.innerHTML += `
                    <div class="test-step success">
                        <strong>‚úÖ Course Folder Created Successfully for ${company.toUpperCase()}</strong><br>
                        Folder Name: ${result.folderName}<br>
                        Folder ID: ${result.topicFolderId}<br>
                        Parent Folder ID: ${folderConfig.courses}<br>
                        API Response: ${JSON.stringify(result, null, 2)}
                    </div>
                `;

            } catch (error) {
                testResults.courses[company] = {
                    success: false,
                    error: error.message
                };

                resultDiv.innerHTML += `
                    <div class="test-step error">
                        <strong>‚ùå Course Folder Creation Failed for ${company.toUpperCase()}</strong><br>
                        Error: ${error.message}
                    </div>
                `;
            }
        }

        // ==========================================
        // üöÄ PROJECT FOLDER CREATION TESTS
        // ==========================================

        async function testProjectFolderCreation(company) {
            const resultDiv = document.getElementById('project-test-results');
            
            if (!supabaseClient) {
                resultDiv.innerHTML = '<div class="warning">Please initialize Supabase connection first.</div>';
                return;
            }

            try {
                resultDiv.innerHTML += `
                    <div class="test-step info">
                        <strong>üß™ Testing Project Folder Creation for ${company.toUpperCase()}</strong><br>
                        Testing hardcoded folder ID approach via direct Edge Function call...
                    </div>
                `;

                // First, test getting company folder config (should be from hardcoded values)
                const { data, error } = await supabaseClient.rpc('get_company_drive_folders', {
                    p_company_slug: company
                });

                if (error) {
                    throw new Error(`Database function error: ${error.message}`);
                }

                if (!data?.success) {
                    throw new Error(data?.error || 'Failed to get company folder configuration');
                }

                const projectsFolderId = data.folderIds.projects;

                if (!projectsFolderId) {
                    throw new Error(`No projects folder configured for company: ${company}`);
                }

                // Test authentication (simulating the CreateProjectForm.jsx pattern)
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                if (sessionError || !session?.access_token) {
                    throw new Error('Authentication required for project folder creation');
                }

                // Test the direct API call pattern
                const testProjectData = {
                    title: `Test Project ${company.toUpperCase()} - ${Date.now()}`,
                    company: company,
                    id: `test-project-${company}-${Date.now()}`
                };

                const API_BASE = 'https://vuitwzisazvikrhtfthh.supabase.co/functions/v1/google-drive';
                const response = await fetch(`${API_BASE}/create-topic-folder`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        parentFolderId: projectsFolderId,
                        topicName: testProjectData.title,
                        topicType: 'project'
                    }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to create project folder: ${errorText}`);
                }

                const result = await response.json();

                testResults.projects[company] = {
                    success: true,
                    projectsFolderId,
                    apiResult: result,
                    testProjectData
                };

                resultDiv.innerHTML += `
                    <div class="test-step success">
                        <strong>‚úÖ Project Folder Created Successfully for ${company.toUpperCase()}</strong><br>
                        Folder Name: ${result.folderName}<br>
                        Folder ID: ${result.topicFolderId}<br>
                        Parent Projects Folder ID: ${projectsFolderId}<br>
                        API Response: ${JSON.stringify(result, null, 2)}
                    </div>
                `;

            } catch (error) {
                testResults.projects[company] = {
                    success: false,
                    error: error.message
                };

                resultDiv.innerHTML += `
                    <div class="test-step error">
                        <strong>‚ùå Project Folder Creation Failed for ${company.toUpperCase()}</strong><br>
                        Error: ${error.message}
                    </div>
                `;
            }
        }

        // ==========================================
        // üîí AUTHENTICATION & IMPORT TESTS
        // ==========================================

        async function testImportIssues() {
            const resultDiv = document.getElementById('auth-test-results');
            
            resultDiv.innerHTML += `
                <div class="test-step info">
                    <strong>üß™ Testing Import Patterns</strong><br>
                    Analyzing the differences between course and project creation imports...
                </div>
            `;

            // Test 1: Course Creation Import Pattern
            resultDiv.innerHTML += `
                <div class="test-step">
                    <strong>üìö Course Creation Import Analysis:</strong><br>
                    ‚Ä¢ Uses: <code>import { createCourse } from '../lib/courseService'</code><br>
                    ‚Ä¢ CourseService uses: <code>import { ensureCourseFolderExists } from './courseFolderService'</code><br>
                    ‚Ä¢ CourseFolderService uses: <code>import { supabase } from './supabaseClient'</code><br>
                    ‚Ä¢ Pattern: ‚úÖ Clean, proper imports at module level
                </div>
            `;

            // Test 2: Project Creation Import Pattern Analysis
            resultDiv.innerHTML += `
                <div class="test-step warning">
                    <strong>üöÄ Project Creation Import Analysis:</strong><br>
                    ‚Ä¢ Has: <code>import { getCompanyFolder } from "../lib/courseFolderService"</code><br>
                    ‚Ä¢ Uses: <code>const { supabase } = await import('../lib/supabaseClient')</code><br>
                    ‚Ä¢ Also calls: <code>await supabase.auth.getSession()</code> directly<br>
                    ‚Ä¢ Pattern: ‚ö†Ô∏è Mixed - top-level import + dynamic import + direct usage
                </div>
            `;

            // Test 3: Authentication Call Issue
            const authIssueFound = await testAuthenticationCallIssue();
            
            if (authIssueFound) {
                resultDiv.innerHTML += `
                    <div class="test-step error">
                        <strong>‚ùå Authentication Issue Found:</strong><br>
                        In CreateProjectForm.jsx line 201, there's a call to:<br>
                        <code>await supabase.auth.getSession()</code><br>
                        But 'supabase' is imported dynamically later at line 227.<br>
                        This should cause a runtime error!
                    </div>
                `;
            } else {
                resultDiv.innerHTML += `
                    <div class="test-step success">
                        <strong>‚úÖ Authentication Issue Resolved:</strong><br>
                        The supabase import appears to be correctly handled.
                    </div>
                `;
            }

            testResults.auth.importAnalysis = {
                coursePattern: 'clean_module_imports',
                projectPattern: 'mixed_imports',
                authIssue: authIssueFound,
                recommendation: 'Standardize import patterns'
            };
        }

        async function testAuthenticationCallIssue() {
            // Simulate the CreateProjectForm.jsx authentication call issue
            try {
                // This simulates what happens in CreateProjectForm.jsx line 201
                // where supabase is called before being imported
                
                // Check if this would work in the current environment
                if (typeof supabase === 'undefined' && !supabaseClient) {
                    return true; // Issue exists
                }
                return false; // No issue
            } catch (error) {
                return true; // Issue found
            }
        }

        async function testAuthenticationFlows() {
            const resultDiv = document.getElementById('auth-test-results');
            
            if (!supabaseClient) {
                resultDiv.innerHTML += '<div class="warning">Please initialize Supabase connection first.</div>';
                return;
            }

            resultDiv.innerHTML += `
                <div class="test-step info">
                    <strong>üîê Testing Authentication Flows</strong>
                </div>
            `;

            // Test 1: Session Retrieval
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    resultDiv.innerHTML += `
                        <div class="test-step error">
                            <strong>‚ùå Session Retrieval Failed:</strong><br>
                            Error: ${error.message}
                        </div>
                    `;
                } else if (session) {
                    resultDiv.innerHTML += `
                        <div class="test-step success">
                            <strong>‚úÖ Session Retrieved Successfully:</strong><br>
                            Access Token Present: ${session.access_token ? 'Yes' : 'No'}<br>
                            User ID: ${session.user.id}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML += `
                        <div class="test-step warning">
                            <strong>‚ö†Ô∏è No Active Session:</strong><br>
                            User needs to log in for folder operations
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML += `
                    <div class="test-step error">
                        <strong>‚ùå Authentication Flow Test Failed:</strong><br>
                        Error: ${error.message}
                    </div>
                `;
            }

            testResults.auth.flowTest = {
                completed: true,
                timestamp: new Date().toISOString()
            };
        }

        // ==========================================
        // ‚ùå ERROR SCENARIO TESTS
        // ==========================================

        async function testInvalidCompany() {
            const resultDiv = document.getElementById('error-test-results');
            
            resultDiv.innerHTML += `
                <div class="test-step info">
                    <strong>üß™ Testing Invalid Company Scenario</strong>
                </div>
            `;

            try {
                if (!supabaseClient) throw new Error('Supabase not initialized');

                // Test with invalid company slug
                const { data, error } = await supabaseClient.rpc('get_company_drive_folders', {
                    p_company_slug: 'invalid-company-xyz'
                });

                if (error) {
                    resultDiv.innerHTML += `
                        <div class="test-step success">
                            <strong>‚úÖ Invalid Company Properly Rejected:</strong><br>
                            Database correctly returned error: ${error.message}
                        </div>
                    `;
                    testResults.errors.invalidCompany = { handled: true, error: error.message };
                } else if (!data?.success) {
                    resultDiv.innerHTML += `
                        <div class="test-step success">
                            <strong>‚úÖ Invalid Company Properly Handled:</strong><br>
                            Database returned failure: ${data.error || 'Company not found'}
                        </div>
                    `;
                    testResults.errors.invalidCompany = { handled: true, error: data.error };
                } else {
                    resultDiv.innerHTML += `
                        <div class="test-step warning">
                            <strong>‚ö†Ô∏è Invalid Company Not Rejected:</strong><br>
                            Database unexpectedly returned success for invalid company
                        </div>
                    `;
                    testResults.errors.invalidCompany = { handled: false, unexpected: true };
                }
            } catch (error) {
                resultDiv.innerHTML += `
                    <div class="test-step error">
                        <strong>‚ùå Error Scenario Test Failed:</strong><br>
                        Error: ${error.message}
                    </div>
                `;
                testResults.errors.invalidCompany = { handled: false, testError: error.message };
            }
        }

        async function testNoAuth() {
            const resultDiv = document.getElementById('error-test-results');
            
            resultDiv.innerHTML += `
                <div class="test-step info">
                    <strong>üß™ Testing No Authentication Scenario</strong>
                </div>
            `;

            try {
                // Test API call without authentication
                const API_BASE = 'https://vuitwzisazvikrhtfthh.supabase.co/functions/v1/google-drive';
                const response = await fetch(`${API_BASE}/create-topic-folder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Intentionally omit Authorization header
                    },
                    body: JSON.stringify({
                        parentFolderId: 'test-folder-id',
                        topicName: 'Test Topic',
                        topicType: 'test'
                    }),
                });

                if (!response.ok) {
                    resultDiv.innerHTML += `
                        <div class="test-step success">
                            <strong>‚úÖ No Authentication Properly Rejected:</strong><br>
                            API correctly returned ${response.status}: ${response.statusText}
                        </div>
                    `;
                    testResults.errors.noAuth = { handled: true, status: response.status };
                } else {
                    resultDiv.innerHTML += `
                        <div class="test-step error">
                            <strong>‚ùå No Authentication Not Rejected:</strong><br>
                            API unexpectedly allowed access without authentication
                        </div>
                    `;
                    testResults.errors.noAuth = { handled: false, unexpected: true };
                }
            } catch (error) {
                resultDiv.innerHTML += `
                    <div class="test-step success">
                        <strong>‚úÖ Network/Auth Error Properly Caught:</strong><br>
                        Error: ${error.message}
                    </div>
                `;
                testResults.errors.noAuth = { handled: true, networkError: error.message };
            }
        }

        async function testInvalidFolderIds() {
            const resultDiv = document.getElementById('error-test-results');
            
            if (!supabaseClient) {
                resultDiv.innerHTML += '<div class="warning">Please initialize Supabase connection first.</div>';
                return;
            }

            resultDiv.innerHTML += `
                <div class="test-step info">
                    <strong>üß™ Testing Invalid Folder IDs</strong>
                </div>
            `;

            try {
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                if (sessionError || !session?.access_token) {
                    throw new Error('Authentication required for this test');
                }

                // Test with invalid folder ID
                const API_BASE = 'https://vuitwzisazvikrhtfthh.supabase.co/functions/v1/google-drive';
                const response = await fetch(`${API_BASE}/create-topic-folder`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        parentFolderId: 'invalid-folder-id-xyz123',
                        topicName: 'Test Topic',
                        topicType: 'test'
                    }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    resultDiv.innerHTML += `
                        <div class="test-step success">
                            <strong>‚úÖ Invalid Folder ID Properly Rejected:</strong><br>
                            API returned ${response.status}: ${errorText}
                        </div>
                    `;
                    testResults.errors.invalidFolderId = { handled: true, status: response.status, error: errorText };
                } else {
                    resultDiv.innerHTML += `
                        <div class="test-step warning">
                            <strong>‚ö†Ô∏è Invalid Folder ID Not Rejected:</strong><br>
                            API unexpectedly accepted invalid folder ID
                        </div>
                    `;
                    testResults.errors.invalidFolderId = { handled: false, unexpected: true };
                }
            } catch (error) {
                resultDiv.innerHTML += `
                    <div class="test-step error">
                        <strong>‚ùå Invalid Folder ID Test Failed:</strong><br>
                        Error: ${error.message}
                    </div>
                `;
                testResults.errors.invalidFolderId = { handled: false, testError: error.message };
            }
        }

        async function testNetworkFailure() {
            const resultDiv = document.getElementById('error-test-results');
            
            resultDiv.innerHTML += `
                <div class="test-step info">
                    <strong>üß™ Testing Network Failure Scenario</strong>
                </div>
            `;

            try {
                // Test with invalid API endpoint to simulate network failure
                const response = await fetch('https://invalid-api-endpoint-that-does-not-exist.com/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: 'data' }),
                });

                resultDiv.innerHTML += `
                    <div class="test-step warning">
                        <strong>‚ö†Ô∏è Network Request Unexpectedly Succeeded:</strong><br>
                        This should not happen with an invalid endpoint
                    </div>
                `;
                testResults.errors.networkFailure = { handled: false, unexpected: true };
            } catch (error) {
                resultDiv.innerHTML += `
                    <div class="test-step success">
                        <strong>‚úÖ Network Failure Properly Caught:</strong><br>
                        Error type: ${error.name}<br>
                        Error message: ${error.message}
                    </div>
                `;
                testResults.errors.networkFailure = { handled: true, error: error.message, type: error.name };
            }
        }

        // ==========================================
        // üìä CONSISTENCY ANALYSIS
        // ==========================================

        async function analyzeConsistency() {
            const resultDiv = document.getElementById('consistency-results');
            
            resultDiv.innerHTML = `
                <div class="test-step info">
                    <strong>üìä Analyzing Course vs Project Creation Consistency</strong>
                </div>
            `;

            const analysis = {
                authenticationPattern: {},
                apiCallPattern: {},
                errorHandling: {},
                dataStorage: {},
                folderConfiguration: {}
            };

            // Authentication Pattern Analysis
            analysis.authenticationPattern = {
                course: {
                    method: 'Service-layer authentication',
                    location: 'courseFolderService.js',
                    pattern: 'await supabase.auth.getSession() in service'
                },
                project: {
                    method: 'Component-level authentication',
                    location: 'CreateProjectForm.jsx',
                    pattern: 'await supabase.auth.getSession() in component',
                    issue: 'Import timing issue possible'
                },
                consistency: 'INCONSISTENT'
            };

            // API Call Pattern Analysis
            analysis.apiCallPattern = {
                course: {
                    method: 'Service wrapper function',
                    function: 'ensureCourseFolderExists()',
                    abstraction: 'High - hides API details'
                },
                project: {
                    method: 'Direct API call',
                    function: 'fetch() to Edge Function',
                    abstraction: 'Low - exposes API details'
                },
                consistency: 'INCONSISTENT'
            };

            // Error Handling Analysis
            analysis.errorHandling = {
                course: {
                    pattern: 'Service-level error wrapping',
                    userFeedback: 'Structured success/error messages',
                    gracefulDegradation: 'Course created even if folder fails'
                },
                project: {
                    pattern: 'Component-level try/catch',
                    userFeedback: 'Direct error display',
                    gracefulDegradation: 'Similar pattern to courses'
                },
                consistency: 'PARTIALLY_CONSISTENT'
            };

            // Data Storage Analysis
            analysis.dataStorage = {
                course: {
                    folderIdStorage: 'Automatic via service',
                    updateMethod: 'Service handles database updates'
                },
                project: {
                    folderIdStorage: 'Manual database update',
                    updateMethod: 'Direct supabase.from().update()'
                },
                consistency: 'INCONSISTENT'
            };

            // Folder Configuration Analysis
            analysis.folderConfiguration = {
                course: {
                    source: 'Database-driven via RPC function',
                    security: 'No hardcoded folder IDs'
                },
                project: {
                    source: 'Same database RPC function',
                    security: 'No hardcoded folder IDs'
                },
                consistency: 'CONSISTENT'
            };

            testResults.consistency = analysis;

            // Display results
            resultDiv.innerHTML += `
                <div class="test-step">
                    <strong>üîê Authentication Pattern:</strong><br>
                    ‚Ä¢ Courses: ${analysis.authenticationPattern.course.method}<br>
                    ‚Ä¢ Projects: ${analysis.authenticationPattern.project.method}<br>
                    ‚Ä¢ Consistency: <span class="text-warning">${analysis.authenticationPattern.consistency}</span>
                </div>
            `;

            resultDiv.innerHTML += `
                <div class="test-step">
                    <strong>üîå API Call Pattern:</strong><br>
                    ‚Ä¢ Courses: ${analysis.apiCallPattern.course.method} (${analysis.apiCallPattern.course.abstraction})<br>
                    ‚Ä¢ Projects: ${analysis.apiCallPattern.project.method} (${analysis.apiCallPattern.project.abstraction})<br>
                    ‚Ä¢ Consistency: <span class="text-warning">${analysis.apiCallPattern.consistency}</span>
                </div>
            `;

            resultDiv.innerHTML += `
                <div class="test-step">
                    <strong>‚ùå Error Handling Pattern:</strong><br>
                    ‚Ä¢ Courses: ${analysis.errorHandling.course.pattern}<br>
                    ‚Ä¢ Projects: ${analysis.errorHandling.project.pattern}<br>
                    ‚Ä¢ Consistency: <span class="text-success">${analysis.errorHandling.consistency}</span>
                </div>
            `;

            resultDiv.innerHTML += `
                <div class="test-step">
                    <strong>üíæ Data Storage Pattern:</strong><br>
                    ‚Ä¢ Courses: ${analysis.dataStorage.course.folderIdStorage}<br>
                    ‚Ä¢ Projects: ${analysis.dataStorage.project.folderIdStorage}<br>
                    ‚Ä¢ Consistency: <span class="text-warning">${analysis.dataStorage.consistency}</span>
                </div>
            `;

            resultDiv.innerHTML += `
                <div class="test-step success">
                    <strong>üìÅ Folder Configuration:</strong><br>
                    ‚Ä¢ Both use: ${analysis.folderConfiguration.course.source}<br>
                    ‚Ä¢ Security: ${analysis.folderConfiguration.course.security}<br>
                    ‚Ä¢ Consistency: <span class="text-success">${analysis.folderConfiguration.consistency}</span>
                </div>
            `;
        }

        // ==========================================
        // üèÜ FINAL REPORT GENERATION
        // ==========================================

        async function generateFinalReport() {
            const resultDiv = document.getElementById('final-report');
            
            const report = {
                timestamp: new Date().toISOString(),
                platform: 'Login Learning Platform',
                testType: 'Google Drive Folder Creation Flow Analysis',
                summary: {
                    totalTests: 0,
                    passed: 0,
                    failed: 0,
                    issues: []
                },
                findings: {},
                recommendations: []
            };

            // Count test results
            Object.values(testResults.courses).forEach(result => {
                report.summary.totalTests++;
                if (result.success) report.summary.passed++;
                else report.summary.failed++;
            });

            Object.values(testResults.projects).forEach(result => {
                report.summary.totalTests++;
                if (result.success) report.summary.passed++;
                else report.summary.failed++;
            });

            // Compile findings
            report.findings = {
                criticalIssues: [],
                securityConcerns: [],
                consistencyIssues: [],
                technicalDebt: [],
                positiveFindings: []
            };

            // Critical Issues
            if (testResults.auth.importAnalysis?.authIssue) {
                report.findings.criticalIssues.push(
                    'Runtime error risk in CreateProjectForm.jsx: supabase.auth.getSession() called before import'
                );
            }

            // Security Analysis
            report.findings.securityConcerns.push(
                'RESOLVED: No hardcoded folder IDs found in current implementation'
            );
            report.findings.securityConcerns.push(
                'GOOD: Both course and project creation use proper authentication'
            );

            // Consistency Issues
            if (testResults.consistency?.authenticationPattern?.consistency === 'INCONSISTENT') {
                report.findings.consistencyIssues.push(
                    'Authentication patterns differ between courses and projects'
                );
            }
            if (testResults.consistency?.apiCallPattern?.consistency === 'INCONSISTENT') {
                report.findings.consistencyIssues.push(
                    'API call patterns differ - courses use service wrapper, projects use direct calls'
                );
            }

            // Technical Debt
            report.findings.technicalDebt.push(
                'Mixed import patterns in project creation (dynamic + static imports)'
            );
            report.findings.technicalDebt.push(
                'Duplicate code between course and project folder creation logic'
            );

            // Positive Findings
            report.findings.positiveFindings.push(
                'Database-driven folder configuration eliminates hardcoded security risks'
            );
            report.findings.positiveFindings.push(
                'Proper error handling with graceful degradation'
            );
            report.findings.positiveFindings.push(
                'Consistent folder structure across all companies'
            );

            // Generate Recommendations
            report.recommendations = [
                {
                    priority: 'HIGH',
                    category: 'Bug Fix',
                    issue: 'Import timing in CreateProjectForm.jsx',
                    solution: 'Move supabase import to top-level imports or use consistent dynamic import pattern'
                },
                {
                    priority: 'MEDIUM',
                    category: 'Code Consistency',
                    issue: 'Different patterns for course vs project creation',
                    solution: 'Create unified folder creation service that both courses and projects use'
                },
                {
                    priority: 'MEDIUM',
                    category: 'Architecture',
                    issue: 'Direct API calls in components',
                    solution: 'Move all Google Drive operations to service layer for better maintainability'
                },
                {
                    priority: 'LOW',
                    category: 'Code Quality',
                    issue: 'Mixed import patterns',
                    solution: 'Standardize on either static or dynamic imports throughout the application'
                }
            ];

            // Display comprehensive report
            resultDiv.innerHTML = `
                <div class="test-step success">
                    <h3>üèÜ Comprehensive Test Report</h3>
                    <strong>Test Summary:</strong><br>
                    ‚Ä¢ Total Tests: ${report.summary.totalTests}<br>
                    ‚Ä¢ Passed: ${report.summary.passed}<br>
                    ‚Ä¢ Failed: ${report.summary.failed}<br>
                    ‚Ä¢ Success Rate: ${Math.round((report.summary.passed/report.summary.totalTests)*100)}%
                </div>

                <div class="test-step error">
                    <h4>‚ùå Critical Issues Found:</h4>
                    ${report.findings.criticalIssues.map(issue => `‚Ä¢ ${issue}`).join('<br>')}
                </div>

                <div class="test-step warning">
                    <h4>‚ö†Ô∏è Consistency Issues:</h4>
                    ${report.findings.consistencyIssues.map(issue => `‚Ä¢ ${issue}`).join('<br>')}
                </div>

                <div class="test-step info">
                    <h4>üîß Technical Debt:</h4>
                    ${report.findings.technicalDebt.map(issue => `‚Ä¢ ${issue}`).join('<br>')}
                </div>

                <div class="test-step success">
                    <h4>‚úÖ Positive Findings:</h4>
                    ${report.findings.positiveFindings.map(finding => `‚Ä¢ ${finding}`).join('<br>')}
                </div>

                <div class="test-step info">
                    <h4>üéØ Priority Recommendations:</h4>
                    ${report.recommendations.map(rec => 
                        `<strong>${rec.priority}</strong> - ${rec.category}: ${rec.issue}<br>
                         <em>Solution: ${rec.solution}</em><br><br>`
                    ).join('')}
                </div>

                <div class="test-step">
                    <h4>üìã Detailed Test Results:</h4>
                    <pre>${JSON.stringify(testResults, null, 2)}</pre>
                </div>
            `;

            // Store final report
            window.finalTestReport = report;
            console.log('Final Test Report:', report);
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ Folder Creation Flow Testing Interface Ready');
        });
    </script>
</body>
</html>