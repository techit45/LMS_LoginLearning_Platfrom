<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Course Creation with Folder Auto-Creation</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px;
        }
        .success { 
            background-color: #d4edda; 
            border-color: #c3e6cb; 
            color: #155724; 
        }
        .error { 
            background-color: #f8d7da; 
            border-color: #f5c6cb; 
            color: #721c24; 
        }
        .warning { 
            background-color: #fff3cd; 
            border-color: #ffeaa7; 
            color: #856404; 
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .loading { opacity: 0.6; cursor: not-allowed; }
        input, textarea, select { 
            width: 100%; 
            padding: 8px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            box-sizing: border-box;
        }
        label { 
            font-weight: bold; 
            display: block; 
            margin-top: 10px; 
        }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 5px; 
            overflow: auto; 
            max-height: 300px;
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-weight: bold;
        }
        .test-results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .step {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .step.success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .step.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h1>
        
        <div class="form-section">
            <h2>üìã ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>
            
            <div>
                <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™:</label>
                <input type="text" id="courseTitle" value="Test Course Auto Folder Creation" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö">
                
                <label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</label>
                <textarea id="courseDescription" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏£‡πå‡∏™">‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</textarea>
                
                <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</label>
                <select id="courseCategory">
                    <option value="test">Test</option>
                    <option value="programming">Programming</option>
                    <option value="design">Design</option>
                    <option value="engineering">Engineering</option>
                </select>
                
                <label>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:</label>
                <select id="courseCompany">
                    <option value="login">LOGIN</option>
                    <option value="meta">Meta</option>
                    <option value="med">Med</option>
                    <option value="edtech">Ed-tech</option>
                    <option value="w2d">W2D</option>
                </select>
                
                <label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á):</label>
                <input type="number" id="courseDuration" value="10" min="1">
                
                <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:</label>
                <input type="number" id="courseMaxStudents" value="30" min="1">
                
                <br><br>
                <button onclick="runFullTest()" id="testBtn">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
                <button onclick="clearResults()" id="clearBtn">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</button>
            </div>
        </div>

        <div id="authStatus" class="status" style="display: none;"></div>
        <div id="testResults" style="display: none;"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://vuitwzisazvikrhtfthh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1aXR3emlzYXJ2aWtyaHRmdGhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzOTU4ODIsImV4cCI6MjA2Njk3MTg4Mn0.VXCqythCUualJ7S9jVvnQUYe9BKnfMvbihtZT5c3qyE';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let testData = {
            courseId: null,
            folderId: null,
            fileId: null
        };

        // Check authentication status on load
        window.onload = async function() {
            await checkAuthStatus();
        };

        async function checkAuthStatus() {
            const authDiv = document.getElementById('authStatus');
            authDiv.style.display = 'block';
            
            try {
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error || !user) {
                    authDiv.className = 'status error';
                    authDiv.innerHTML = '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö';
                    document.getElementById('testBtn').disabled = true;
                    return false;
                }
                
                // Check user profile
                const { data: profile } = await supabaseClient
                    .from('user_profiles')
                    .select('role, full_name')
                    .eq('user_id', user.id)
                    .single();
                
                const canCreateCourse = profile && ['admin', 'instructor'].includes(profile.role);
                
                if (!canCreateCourse) {
                    authDiv.className = 'status warning';
                    authDiv.innerHTML = `‚ö†Ô∏è ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß (${user.email}) ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏™<br>‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô admin ‡∏´‡∏£‡∏∑‡∏≠ instructor ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô`;
                    document.getElementById('testBtn').disabled = true;
                    return false;
                }
                
                authDiv.className = 'status success';
                authDiv.innerHTML = `‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß: ${user.email}<br>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ${profile.role} (${profile.full_name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'})`;
                document.getElementById('testBtn').disabled = false;
                return true;
                
            } catch (error) {
                authDiv.className = 'status error';
                authDiv.innerHTML = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
                document.getElementById('testBtn').disabled = true;
                return false;
            }
        }

        function clearResults() {
            document.getElementById('testResults').style.display = 'none';
            testData = { courseId: null, folderId: null, fileId: null };
        }

        function showStep(stepNum, title, status, message, data = null) {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.style.display = 'block';
            
            const stepDiv = document.createElement('div');
            stepDiv.className = `step ${status}`;
            stepDiv.innerHTML = `
                <strong>${stepNum}. ${title}</strong><br>
                ${message}
                ${data ? `<pre style="margin-top: 10px; font-size: 12px;">${JSON.stringify(data, null, 2)}</pre>` : ''}
            `;
            
            resultsDiv.appendChild(stepDiv);
            
            // Scroll to bottom
            stepDiv.scrollIntoView({ behavior: 'smooth' });
        }

        async function createTestCourse(courseData) {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                const { data: profile } = await supabaseClient
                    .from('user_profiles')
                    .select('user_id, full_name, email, role')
                    .eq('user_id', user.id)
                    .single();

                const courseDataWithInstructor = {
                    title: courseData.title,
                    description: courseData.description,
                    category: courseData.category,
                    level: 'beginner',
                    duration_hours: parseInt(courseData.duration_hours) || 0,
                    price: 0,
                    max_students: parseInt(courseData.max_students) || 50,
                    is_active: true,
                    is_featured: false,
                    thumbnail_url: null,
                    company: courseData.company || 'login',
                    instructor_id: user.id,
                    instructor_name: profile.full_name || user.email?.split('@')[0] || 'Instructor',
                    instructor_email: profile.email || user.email
                };

                const { data, error } = await supabaseClient
                    .from('courses')
                    .insert([courseDataWithInstructor])
                    .select()
                    .single();

                if (error) throw error;
                return { data, error: null };
                
            } catch (error) {
                return { data: null, error };
            }
        }

        async function createCourseFolder(courseId, courseTitle, company) {
            try {
                const COMPANY_FOLDERS = {
                    'login': { courses: '12lk0wPhyd6RvoEiQaQwXPBEeI07zB9nT' },
                    'meta': { courses: '1CI-73CLESxWCVevYaDeSKGikLy2Tccg' },
                    'med': { courses: '1yfN_Kw80H5xuF1IVZPZYuszyDZc7q0vZ' },
                    'edtech': { courses: '1cItGoQdXOyTflUnzZBLiLUiC8BMZ8G0C' },
                    'w2d': { courses: '1yA0vhAH7TrgCSsPGy3HpM05Wlz07HD8A' }
                };

                const parentFolderId = COMPANY_FOLDERS[company]?.courses;
                if (!parentFolderId) {
                    throw new Error(`No folder configuration for company: ${company}`);
                }

                const response = await fetch('https://vuitwzisazvikrhtfthh.supabase.co/functions/v1/google-drive/create-topic-folder', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        parentFolderId: parentFolderId,
                        topicName: courseTitle,
                        topicType: 'course'
                    }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API error: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                const folderId = result.topicFolderId;

                if (!folderId) {
                    throw new Error('No folder ID returned');
                }

                // Update course with folder ID
                const { error: updateError } = await supabaseClient
                    .from('courses')
                    .update({ google_drive_folder_id: folderId })
                    .eq('id', courseId);

                if (updateError) throw updateError;

                return { folderId, folderName: courseTitle, folderUrl: `https://drive.google.com/drive/folders/${folderId}` };
                
            } catch (error) {
                throw error;
            }
        }

        async function uploadTestFile(folderId, courseTitle) {
            try {
                const testContent = `Test file for course: ${courseTitle}\nCreated: ${new Date().toISOString()}\nFolder ID: ${folderId}`;
                const testFile = new Blob([testContent], { type: 'text/plain' });
                
                const formData = new FormData();
                formData.append('file', testFile, `test-${Date.now()}.txt`);
                formData.append('folderId', folderId);

                const response = await fetch('https://vuitwzisazvikrhtfthh.supabase.co/functions/v1/google-drive/simple-upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    },
                    body: formData,
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Upload failed: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                return result;
                
            } catch (error) {
                throw error;
            }
        }

        async function cleanupTestData() {
            let cleaned = 0;
            const cleanupResults = [];

            // Delete file
            if (testData.fileId) {
                try {
                    const response = await fetch(`https://vuitwzisazvikrhtfthh.supabase.co/functions/v1/google-drive/delete?fileId=${testData.fileId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                    });
                    
                    if (response.ok) {
                        cleanupResults.push('‚úÖ Test file deleted');
                        cleaned++;
                    } else {
                        cleanupResults.push('‚ö†Ô∏è Could not delete test file');
                    }
                } catch (error) {
                    cleanupResults.push(`‚ö†Ô∏è File deletion error: ${error.message}`);
                }
            }

            // Delete folder
            if (testData.folderId) {
                try {
                    const response = await fetch(`https://vuitwzisazvikrhtfthh.supabase.co/functions/v1/google-drive/delete?fileId=${testData.folderId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                    });
                    
                    if (response.ok) {
                        cleanupResults.push('‚úÖ Test folder deleted');
                        cleaned++;
                    } else {
                        cleanupResults.push('‚ö†Ô∏è Could not delete test folder');
                    }
                } catch (error) {
                    cleanupResults.push(`‚ö†Ô∏è Folder deletion error: ${error.message}`);
                }
            }

            // Delete course
            if (testData.courseId) {
                try {
                    const { error } = await supabaseClient
                        .from('courses')
                        .delete()
                        .eq('id', testData.courseId);

                    if (!error) {
                        cleanupResults.push('‚úÖ Test course deleted');
                        cleaned++;
                    } else {
                        cleanupResults.push(`‚ö†Ô∏è Could not delete test course: ${error.message}`);
                    }
                } catch (error) {
                    cleanupResults.push(`‚ö†Ô∏è Course deletion error: ${error.message}`);
                }
            }

            return { cleaned, results: cleanupResults };
        }

        async function runFullTest() {
            const startTime = Date.now();
            
            // Clear previous results
            clearResults();
            
            // Disable test button
            document.getElementById('testBtn').disabled = true;
            document.getElementById('testBtn').textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...';

            try {
                // Get form data
                const courseData = {
                    title: document.getElementById('courseTitle').value || `Test Course ${Date.now()}`,
                    description: document.getElementById('courseDescription').value || 'Test course description',
                    category: document.getElementById('courseCategory').value,
                    company: document.getElementById('courseCompany').value,
                    duration_hours: document.getElementById('courseDuration').value,
                    max_students: document.getElementById('courseMaxStudents').value
                };

                showStep(1, '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 'success', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥', courseData);

                // Step 1: Create course
                showStep(2, '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÉ‡∏´‡∏°‡πà...');
                const courseResult = await createTestCourse(courseData);
                
                if (courseResult.error) {
                    throw new Error(`Course creation failed: ${courseResult.error.message}`);
                }

                testData.courseId = courseResult.data.id;
                showStep(2, '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'success', 
                    `‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 
                    { courseId: testData.courseId, title: courseResult.data.title });

                // Step 2: Create folder
                showStep(3, '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Google Drive', '', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏£‡πå‡∏™...');
                const folderResult = await createCourseFolder(testData.courseId, courseData.title, courseData.company);
                
                testData.folderId = folderResult.folderId;
                showStep(3, '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Google Drive', 'success', 
                    `‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß<br><a href="${folderResult.folderUrl}" target="_blank">üîó ‡∏î‡∏π‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô Google Drive</a>`, 
                    { folderId: testData.folderId, folderName: folderResult.folderName });

                // Step 3: Upload test file
                showStep(4, '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå', '', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏î‡∏™‡∏≠‡∏ö...');
                const uploadResult = await uploadTestFile(testData.folderId, courseData.title);
                
                testData.fileId = uploadResult.fileId || uploadResult.id;
                showStep(4, '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå', 'success', 
                    `‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß<br><a href="${uploadResult.webViewLink}" target="_blank">üîó ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Google Drive</a>`, 
                    { fileId: testData.fileId });

                // Step 4: Summary
                const endTime = Date.now();
                const duration = (endTime - startTime) / 1000;
                
                showStep(5, '‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 'success', 
                    `‚úÖ ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br>
                    ‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ: ${duration.toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ<br>
                    üìÅ ‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞<br>
                    üìÑ ‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ<br><br>
                    <button onclick="cleanupAfterTest()">üßπ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
                    <button onclick="keepTestData()">üíæ ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏ß‡πâ</button>`);

            } catch (error) {
                showStep('‚ùå', '‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error', 
                    `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}<br><br>
                    <button onclick="cleanupAfterTest()">üßπ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</button>`, 
                    { error: error.message, testData });
            }

            // Re-enable test button
            document.getElementById('testBtn').disabled = false;
            document.getElementById('testBtn').textContent = 'üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö';
        }

        async function cleanupAfterTest() {
            showStep('üßπ', '‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î', '', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö...');
            
            const cleanup = await cleanupTestData();
            
            showStep('üßπ', '‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'success', 
                `‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß: ${cleanup.cleaned} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>
                ${cleanup.results.join('<br>')}`,
                cleanup);
                
            testData = { courseId: null, folderId: null, fileId: null };
        }

        function keepTestData() {
            showStep('üíæ', '‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 'success', 
                `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß<br>
                üìÅ Course ID: ${testData.courseId}<br>
                üìÅ Folder ID: ${testData.folderId}<br>
                üìÑ File ID: ${testData.fileId}<br><br>
                ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô Google Drive ‡πÅ‡∏•‡∏∞‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`);
        }
    </script>
</body>
</html>