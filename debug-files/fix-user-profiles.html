<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç User Profiles</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: #f9f9f9; padding: 20px; margin: 10px 0; border-radius: 8px; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #45a049; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .warning { background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç User Profiles</h1>
    
    <div class="card">
        <h2>‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö:</h2>
        <ul>
            <li><strong>Login-Learning Admin:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡πÅ‡∏•‡∏∞ is_active = false (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</li>
            <li><strong>pethj02:</strong> role = student ‡∏ñ‡∏π‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ</li>
        </ul>
    </div>

    <div class="card">
        <button onclick="checkProfiles()">üìã ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
        <button onclick="fixProfiles()">üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <div id="result"></div>

    <script>
        const supabase = window.supabase.createClient(
            'https://vuitwzisazvikrhtfthh.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1aXR3emlzYXp2aWtyaHRmdGhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzOTU4ODIsImV4cCI6MjA2Njk3MTg4Mn0.VXCqythCUualJ7S9jVvnQUYe9BKnfMvbihtZT5c3qyE'
        )

        async function checkProfiles() {
            const result = document.getElementById('result')
            result.innerHTML = '‚è≥ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö profiles...'

            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('user_id, email, full_name, role, is_active')
                    .order('full_name')

                if (error) {
                    result.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`
                } else {
                    let html = `<div class="card"><h3>üìä Profiles ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (${data.length} ‡∏Ñ‡∏ô):</h3><ul>`
                    
                    data.forEach(p => {
                        let status = '‚úÖ'
                        if (p.email === 'techit.y@login-learning.com' && (p.full_name !== 'Login-Learning Admin' || !p.is_active)) {
                            status = '‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (is_active = false)'
                        }
                        
                        html += `<li>${status} <strong>${p.full_name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'}</strong> (${p.email}) - Role: ${p.role} - Active: ${p.is_active}</li>`
                    })
                    
                    html += '</ul></div>'
                    result.innerHTML = html
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Unexpected error: ${error.message}</div>`
            }
        }

        async function fixProfiles() {
            const result = document.getElementById('result')
            result.innerHTML = '‚è≥ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç profiles...'

            try {
                const fixes = []
                
                // 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Login-Learning Admin
                const fix1 = await supabase
                    .from('user_profiles')
                    .update({
                        full_name: 'Login-Learning Admin',
                        role: 'admin',
                        is_active: true
                    })
                    .eq('email', 'techit.y@login-learning.com')
                
                fixes.push({ name: 'Login-Learning Admin', result: fix1 })

                // ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•
                let html = '<div class="success"><h3>üéâ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!</h3><ul>'
                fixes.forEach(fix => {
                    if (fix.result.error) {
                        html += `<li>‚ùå ${fix.name}: ${fix.result.error.message}</li>`
                    } else {
                        html += `<li>‚úÖ ${fix.name}: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</li>`
                    }
                })
                html += '</ul></div>'
                
                html += `<div class="warning">
                    <strong>‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô Login-Learning Admin ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏•‡πâ‡∏ß!
                </div>`
                
                result.innerHTML = html
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                setTimeout(() => {
                    checkProfiles()
                }, 1000)

            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Unexpected error: ${error.message}</div>`
            }
        }
    </script>
</body>
</html>