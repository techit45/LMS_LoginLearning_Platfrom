<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin: Cleanup Company Locations</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            background: linear-gradient(135deg, #dc3545 0%, #6c757d 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .admin-section { 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 10px; 
            border-left: 5px solid #dc3545;
            background: #f8f9fa;
        }
        .success { border-left-color: #28a745; background: #d4f6d4; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .info { border-left-color: #17a2b8; background: #d1ecf1; }
        
        h1 { 
            text-align: center; 
            color: #dc3545;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 18px;
        }
        
        button { 
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220,53,69,0.4);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .location-card {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .location-info {
            flex-grow: 1;
        }
        
        .location-actions button {
            margin: 2px;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .keep { background: #28a745; }
        .deactivate { background: #ffc107; color: #000; }
        .delete { background: #dc3545; }
        
        .auth-section {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        input[type="email"], input[type="password"] {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® Admin: Cleanup Company Locations</h1>
        <p class="subtitle">‡∏•‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î</p>

        <!-- Authentication Section -->
        <div class="auth-section">
            <h3>üîê Admin Authentication Required</h3>
            <input type="email" id="admin-email" placeholder="Admin Email" value="">
            <input type="password" id="admin-password" placeholder="Admin Password" value="">
            <button onclick="adminLogin()">üîì Login as Admin</button>
            <div id="auth-status"></div>
        </div>

        <!-- Current Locations -->
        <div id="locations-section" class="admin-section info">
            <h3>üìç Current Company Locations</h3>
            <button onclick="loadLocations()">üîÑ Refresh Locations</button>
            <div id="locations-list"></div>
        </div>

        <!-- Cleanup Actions -->
        <div id="cleanup-section" class="admin-section error">
            <h3>üßπ Cleanup Actions</h3>
            <p><strong>‚ö†Ô∏è Warning:</strong> ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞ <strong>‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î</strong></p>
            <button onclick="performCleanup()" id="cleanup-btn" disabled>üóëÔ∏è Keep Only ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î</button>
            <div id="cleanup-results"></div>
        </div>

        <!-- Results -->
        <div id="results-section" class="admin-section">
            <h3>üìä Results</h3>
            <div id="results-content">
                <p>Please login and load locations first</p>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://vuitwzisazvikrhtfthh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1aXR3emlzYXp2aWtyaHRmdGhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzOTU4ODIsImV4cCI6MjA2Njk3MTg4Mn0.VXCqythCUualJ7S9jVvnQUYe9BKnfMvbihtZT5c3qyE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let allLocations = [];

        // Admin Login
        async function adminLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const statusDiv = document.getElementById('auth-status');
            
            if (!email || !password) {
                statusDiv.innerHTML = '<div style="color: #dc3545;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà email ‡πÅ‡∏•‡∏∞ password</div>';
                return;
            }
            
            try {
                statusDiv.innerHTML = '<div style="color: #007bff;">üîÑ Logging in...</div>';
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                if (data.user) {
                    currentUser = data.user;
                    statusDiv.innerHTML = `
                        <div style="color: #28a745;">
                            ‚úÖ Logged in as: ${data.user.email}<br>
                            User ID: ${data.user.id}
                        </div>
                    `;
                    
                    document.getElementById('cleanup-btn').disabled = false;
                    await loadLocations();
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div style="color: #dc3545;">‚ùå Login Error: ${error.message}</div>`;
                console.error('Login Error:', error);
            }
        }

        // Load Current Locations
        async function loadLocations() {
            const listDiv = document.getElementById('locations-list');
            listDiv.innerHTML = '<div style="color: #666;">üîÑ Loading locations...</div>';

            try {
                const { data: locations, error } = await supabase
                    .from('company_locations')
                    .select('*')
                    .order('company')
                    .order('location_name');

                if (error) throw error;

                allLocations = locations || [];
                
                if (locations && locations.length > 0) {
                    const activeLocations = locations.filter(loc => loc.is_active);
                    const inactiveLocations = locations.filter(loc => !loc.is_active);
                    
                    let locationCards = '';
                    
                    if (activeLocations.length > 0) {
                        locationCards += '<h4 style="color: #28a745;">‚úÖ Active Locations (' + activeLocations.length + ')</h4>';
                        activeLocations.forEach(loc => {
                            const isTarget = loc.location_name === '‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î';
                            locationCards += `
                                <div class="location-card" style="border-left: 5px solid ${isTarget ? '#28a745' : '#dc3545'};">
                                    <div class="location-info">
                                        <strong>${loc.location_name}</strong> (${loc.company})<br>
                                        üìç ${loc.address}<br>
                                        ${loc.is_main_office ? 'üè† Main Office' : 'üìç Branch'} ‚Ä¢ 
                                        üìê ${loc.radius_meters}m
                                        ${isTarget ? '<br><span style="color: #28a745; font-weight: bold;">üéØ TARGET: Keep This Location</span>' : ''}
                                    </div>
                                    <div class="location-actions">
                                        ${isTarget ? 
                                            '<button class="keep">‚úÖ KEEP</button>' : 
                                            '<button class="deactivate" onclick="deactivateLocation(\'' + loc.id + '\')">‚ùå Remove</button>'
                                        }
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    if (inactiveLocations.length > 0) {
                        locationCards += '<h4 style="color: #6c757d; margin-top: 20px;">üí§ Inactive Locations (' + inactiveLocations.length + ')</h4>';
                        inactiveLocations.forEach(loc => {
                            locationCards += `
                                <div class="location-card" style="opacity: 0.6; border-left: 5px solid #6c757d;">
                                    <div class="location-info">
                                        <strong>${loc.location_name}</strong> (${loc.company})<br>
                                        üìç ${loc.address}<br>
                                        üí§ Inactive
                                    </div>
                                </div>
                            `;
                        });
                    }

                    listDiv.innerHTML = locationCards;
                } else {
                    listDiv.innerHTML = '<div style="color: #ffc107;">‚ö†Ô∏è No locations found</div>';
                }

            } catch (error) {
                listDiv.innerHTML = `<div style="color: #dc3545;">‚ùå Error: ${error.message}</div>`;
                console.error('Load Locations Error:', error);
            }
        }

        // Deactivate Individual Location
        async function deactivateLocation(locationId) {
            if (!currentUser) {
                alert('Please login first');
                return;
            }
            
            if (!confirm('Are you sure you want to deactivate this location?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('company_locations')
                    .update({ 
                        is_active: false,
                        updated_at: new Date().toISOString(),
                        updated_by: currentUser.id
                    })
                    .eq('id', locationId);
                
                if (error) throw error;
                
                await loadLocations(); // Refresh
                
            } catch (error) {
                alert('Error deactivating location: ' + error.message);
                console.error('Deactivate Error:', error);
            }
        }

        // Perform Complete Cleanup
        async function performCleanup() {
            if (!currentUser) {
                alert('Please login as admin first');
                return;
            }
            
            const confirmText = 'CONFIRM CLEANUP';
            const userInput = prompt(`‚ö†Ô∏è DANGER: This will deactivate ALL locations except ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î\n\nType "${confirmText}" to confirm:`);
            
            if (userInput !== confirmText) {
                alert('Cleanup cancelled');
                return;
            }
            
            const resultsDiv = document.getElementById('cleanup-results');
            resultsDiv.innerHTML = '<div style="color: #007bff;">üîÑ Performing cleanup...</div>';
            
            try {
                // Find ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î
                const bangPladLocation = allLocations.find(loc => loc.location_name === '‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î');
                
                if (!bangPladLocation) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î');
                }
                
                let results = [];
                results.push('‚úÖ Found ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î: ' + bangPladLocation.id);
                
                // Update ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î to be main office
                const { error: updateError } = await supabase
                    .from('company_locations')
                    .update({
                        is_main_office: true,
                        is_active: true,
                        company: 'login',
                        description: '‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ Login Learning Platform',
                        updated_at: new Date().toISOString(),
                        updated_by: currentUser.id
                    })
                    .eq('id', bangPladLocation.id);
                
                if (updateError) throw updateError;
                results.push('‚úÖ Updated ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î to main office');
                
                // Deactivate all other locations
                const locationsToDeactivate = allLocations.filter(loc => 
                    loc.location_name !== '‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î' && loc.is_active
                );
                
                let deactivatedCount = 0;
                for (const location of locationsToDeactivate) {
                    const { error } = await supabase
                        .from('company_locations')
                        .update({ 
                            is_active: false,
                            updated_at: new Date().toISOString(),
                            updated_by: currentUser.id
                        })
                        .eq('id', location.id);
                    
                    if (error) {
                        results.push(`‚ùå Failed to deactivate ${location.location_name}: ${error.message}`);
                    } else {
                        results.push(`‚úÖ Deactivated ${location.location_name} (${location.company})`);
                        deactivatedCount++;
                    }
                }
                
                results.push(`\nüéâ Cleanup completed! Deactivated ${deactivatedCount} locations`);
                
                resultsDiv.innerHTML = `
                    <div style="background: #d4f6d4; padding: 15px; border-radius: 8px;">
                        <h4>‚úÖ Cleanup Results:</h4>
                        <pre>${results.join('\n')}</pre>
                    </div>
                `;
                
                // Refresh locations
                await loadLocations();
                
                document.getElementById('results-content').innerHTML = `
                    <div style="background: #d4f6d4; padding: 15px; border-radius: 8px;">
                        <h4>üéØ Final Result:</h4>
                        <p><strong>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î ‡πÄ‡∏õ‡πá‡∏ô active location ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</strong></p>
                        <p>Deactivated: ${deactivatedCount} other locations</p>
                        <p>Time: ${new Date().toLocaleString('th-TH')}</p>
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px;">
                        <h4>‚ùå Cleanup Error:</h4>
                        <p>${error.message}</p>
                    </div>
                `;
                console.error('Cleanup Error:', error);
            }
        }

        // Initialize
        console.log('üö® Admin Cleanup Tool Loaded');
        console.log('‚ö†Ô∏è This tool will deactivate all company locations except ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î');
    </script>
</body>
</html>