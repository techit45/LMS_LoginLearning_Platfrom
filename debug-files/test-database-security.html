<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Security Test</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; }
        button { margin: 5px; padding: 10px 15px; cursor: pointer; }
        .test-section { border: 1px solid #ddd; margin: 20px 0; padding: 15px; }
    </style>
</head>
<body>
    <h1>üîí Database Security Testing</h1>
    <div id="results"></div>
    
    <div class="test-section">
        <h2>1. Test Company Folders Security</h2>
        <button onclick="testCompanyFolders()">Test get_company_drive_folders()</button>
    </div>
    
    <div class="test-section">
        <h2>2. Test Admin Authorization</h2>
        <button onclick="testAdminFunctions()">Test is_admin_user()</button>
    </div>
    
    <div class="test-section">
        <h2>3. Test RLS Policies</h2>
        <button onclick="testRLSPolicies()">Test Table Access</button>
    </div>
    
    <div class="test-section">
        <h2>4. Test Input Sanitization</h2>
        <button onclick="testSearchSafety()">Test Search Query Safety</button>
    </div>

    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://vuitwzisazvikrhtfthh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1aXR3emlzYXp2aWtyaHRmdGhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjMxMjAyNTcsImV4cCI6MjAzODY5NjI1N30.qJPaGSp1OhTz2N2X0S0k98xPc4ixCWTN1FsB93w1ZTY';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        async function testCompanyFolders() {
            addResult('üîç Testing company folders security function...', 'info');
            
            try {
                // Test with valid company slug
                const { data: loginData, error: loginError } = await supabase.rpc('get_company_drive_folders', {
                    p_company_slug: 'login'
                });
                
                if (loginError) {
                    addResult(`‚ùå Error calling get_company_drive_folders: ${loginError.message}`, 'error');
                } else if (loginData?.success) {
                    addResult('‚úÖ get_company_drive_folders() working correctly', 'success');
                    addResult(`üìÅ Company: ${loginData.companyName}, Folders: ${Object.keys(loginData.folderIds).length}`, 'info');
                } else {
                    addResult('‚ö†Ô∏è Function returned failure response', 'error');
                }
                
                // Test with invalid company slug
                const { data: invalidData, error: invalidError } = await supabase.rpc('get_company_drive_folders', {
                    p_company_slug: 'nonexistent-company'
                });
                
                if (invalidData?.success === false) {
                    addResult('‚úÖ Properly handles invalid company slugs', 'success');
                } else {
                    addResult('‚ö†Ô∏è May need better validation for invalid input', 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Exception during company folders test: ${error.message}`, 'error');
            }
        }
        
        async function testAdminFunctions() {
            addResult('üîç Testing admin authorization functions...', 'info');
            
            try {
                // Test is_admin_user function
                const { data: isAdmin, error: adminError } = await supabase.rpc('is_admin_user');
                
                if (adminError) {
                    addResult(`‚ùå Error calling is_admin_user: ${adminError.message}`, 'error');
                } else {
                    addResult(`‚úÖ is_admin_user() function working: ${isAdmin ? 'User is admin' : 'User is not admin'}`, 'success');
                }
                
                // Test is_instructor_user function
                const { data: isInstructor, error: instructorError } = await supabase.rpc('is_instructor_user');
                
                if (instructorError) {
                    addResult(`‚ùå Error calling is_instructor_user: ${instructorError.message}`, 'error');
                } else {
                    addResult(`‚úÖ is_instructor_user() function working: ${isInstructor ? 'User is instructor' : 'User is not instructor'}`, 'success');
                }
                
            } catch (error) {
                addResult(`‚ùå Exception during admin functions test: ${error.message}`, 'error');
            }
        }
        
        async function testRLSPolicies() {
            addResult('üîç Testing Row Level Security policies...', 'info');
            
            try {
                // Test company_drive_folders table access
                const { data: foldersData, error: foldersError } = await supabase
                    .from('company_drive_folders')
                    .select('company_slug, company_name')
                    .limit(5);
                
                if (foldersError) {
                    if (foldersError.message.includes('RLS') || foldersError.message.includes('policy')) {
                        addResult('‚úÖ RLS properly blocking unauthorized access to company_drive_folders', 'success');
                    } else {
                        addResult(`‚ùå Database error: ${foldersError.message}`, 'error');
                    }
                } else if (foldersData && foldersData.length > 0) {
                    addResult(`‚úÖ Authenticated access to company_drive_folders working (${foldersData.length} records)`, 'success');
                } else {
                    addResult('‚ö†Ô∏è No data returned from company_drive_folders (may be empty)', 'info');
                }
                
                // Test security_audit_log access
                const { data: auditData, error: auditError } = await supabase
                    .from('security_audit_log')
                    .select('id, event_type')
                    .limit(1);
                
                if (auditError) {
                    if (auditError.message.includes('RLS') || auditError.message.includes('policy')) {
                        addResult('‚úÖ RLS properly restricting audit log access to admins only', 'success');
                    } else {
                        addResult(`‚ùå Unexpected error accessing audit log: ${auditError.message}`, 'error');
                    }
                } else {
                    addResult('‚ÑπÔ∏è User can access audit logs (admin user or open policy)', 'info');
                }
                
            } catch (error) {
                addResult(`‚ùå Exception during RLS test: ${error.message}`, 'error');
            }
        }
        
        async function testSearchSafety() {
            addResult('üîç Testing search query safety (simulated)...', 'info');
            
            // Simulate dangerous search inputs
            const dangerousInputs = [
                "'; DROP TABLE users; --",
                "<script>alert('xss')</script>",
                "' OR '1'='1",
                "'; DELETE FROM forum_topics; --",
                "%'; UNION SELECT * FROM user_profiles; --"
            ];
            
            dangerousInputs.forEach((input, index) => {
                // In a real application, this would go through inputSanitizer.js
                setTimeout(() => {
                    addResult(`üß™ Testing input ${index + 1}: "${input.substring(0, 30)}..."`, 'info');
                    
                    // Simulate sanitization result
                    const sanitized = input.replace(/[%_\\]/g, '\\$&').replace(/[';\-\-]/g, '').trim();
                    
                    if (sanitized !== input) {
                        addResult(`‚úÖ Input sanitization working: Dangerous characters removed/escaped`, 'success');
                    } else {
                        addResult(`‚ö†Ô∏è Input passed through unchanged: "${sanitized}"`, 'info');
                    }
                }, index * 500);
            });
            
            setTimeout(() => {
                addResult('‚úÖ Search safety test completed - inputSanitizer.js should be handling dangerous inputs', 'success');
            }, dangerousInputs.length * 500 + 500);
        }
        
        // Auto-run tests on load
        document.addEventListener('DOMContentLoaded', function() {
            addResult('üîí Database Security Test Suite Loaded', 'info');
            addResult('üìù Tests available: Company Folders, Admin Authorization, RLS Policies, Input Sanitization', 'info');
            addResult('üéØ Click buttons above to run individual tests', 'info');
        });
    </script>
</body>
</html>