import{r as f,j as e,H as Pe,y as rs,n as te,B as as,U as Le,h as re,J as K,R as Ve,aa as je,af as Ne,ag as oe,s as J,ah as is,z as ls,d as Te,ai as ns,aj as he,E as ie,ak as _e,a as Oe,V as pe,x as ce,al as os,am as cs,an as He,M as be,ao as ds,w as De,X as we,Q as ve,A as $e,ap as ms,ab as ge,e as ye,a0 as We,P as ke,c as us,aq as xs,ar as hs,ae as Ae,as as Ue,at as ps,au as gs,av as fs,aw as js,ax as bs,ay as vs,a7 as ws,az as qe,aA as ys,aB as Ns,F as ee,aC as _s,i as Fe,a6 as ks,$ as Cs,I as Ss,Y as Es,Z as zs,_ as Ps,a9 as Me,a8 as me,m as le,aD as ne,aE as Ls}from"./vendor-a7f5a9e8.js";import{u as X,g as Ts,I as $s,B as _,s as y,a as Ge,b as Ye,c as Ce,d as Ds,e as Re,f as Be,h as Qe,i as As,j as Us,k as qs}from"./admin-0e30eae8.js";import{m as Q,A as se}from"./ui-b0ca5b02.js";const Fs=()=>{const{toast:s}=X(),[t,a]=f.useState([]),[i,r]=f.useState(!0),[l,n]=f.useState(""),[g,m]=f.useState("ทั้งหมด"),v=d=>d?d.split(`
`).map((h,D)=>e.jsxs(Ve.Fragment,{children:[h,D<d.split(`
`).length-1&&e.jsx("br",{})]},D)):"ไม่มีคำอธิบาย",j=f.useCallback(async()=>{r(!0);const{data:d,error:h}=await Ts();h?s({title:"ข้อผิดพลาดในการโหลดข้อมูล",description:h.message,variant:"destructive"}):a(d||[]),r(!1)},[s]);f.useEffect(()=>{j()},[j]);const c=["ทั้งหมด",...new Set(t.map(d=>d.category).filter(Boolean))],o=t.filter(d=>{var $;const h=d.title.toLowerCase().includes(l.toLowerCase())||(($=d.description)==null?void 0:$.toLowerCase().includes(l.toLowerCase())),D=g==="ทั้งหมด"||d.category===g;return h&&D}),b={initial:{opacity:0,y:20},in:{opacity:1,y:0},out:{opacity:0,y:-20}},x={type:"tween",ease:"anticipate",duration:.5};return e.jsxs(Q.div,{initial:"initial",animate:"in",exit:"out",variants:b,transition:x,className:"pt-24 pb-16 px-6",children:[e.jsxs(Pe,{children:[e.jsx("title",{children:"คอร์สเรียนทั้งหมด - Login Learning"}),e.jsx("meta",{name:"description",content:"เลือกดูคอร์สเรียนวิศวกรรมที่หลากหลายของเรา ออกแบบมาเพื่อน้องๆ มัธยมโดยเฉพาะ"})]}),e.jsx("section",{className:"pt-8 mb-12",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs(Q.div,{initial:{y:-50,opacity:0},animate:{y:0,opacity:1},transition:{duration:.7,delay:.2},className:"text-center mb-10",children:[e.jsxs("h1",{className:"text-5xl lg:text-6xl font-bold text-blue-900 mb-4",children:["คอร์สเรียน ",e.jsx("span",{className:"gradient-text",children:"ทั้งหมด"})]}),e.jsx("p",{className:"text-xl text-blue-800 max-w-2xl mx-auto",children:"ค้นหาคอร์สที่ใช่ จุดประกายแรงบันดาลใจสู่เส้นทางวิศวะฯ กับ Login Learning"})]}),e.jsxs(Q.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{duration:.5,delay:.4},className:"flex flex-col md:flex-row gap-4 mb-8 p-4 glass-effect rounded-lg",children:[e.jsxs("div",{className:"relative flex-grow",children:[e.jsx($s,{type:"text",placeholder:"ค้นหาคอร์สเรียน...",className:"pl-10 text-black bg-white/90 focus:bg-white",value:l,onChange:d=>n(d.target.value)}),e.jsx(rs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"})]}),e.jsx("select",{className:"px-4 py-2 rounded-lg bg-white/90 text-black border border-white/30 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500",value:g,onChange:d=>m(d.target.value),children:c.map(d=>e.jsx("option",{value:d,children:d},d))})]}),i?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-[#667eea] mx-auto mb-4"}),e.jsx("p",{className:"text-blue-700",children:"กำลังโหลดคอร์สเรียน..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6 text-blue-700",children:["พบ ",o.length," คอร์สเรียน",l&&` สำหรับ "${l}"`,g!=="ทั้งหมด"&&` ในหมวดหมู่ "${g}"`]}),e.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8",children:o.map((d,h)=>e.jsx(Q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:h*.05+.5},className:"course-card rounded-xl overflow-hidden hover:scale-105 transition-transform duration-300",children:e.jsxs(te,{to:`/courses/${d.id}`,className:"block",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{className:"w-full h-48 object-cover",alt:`ภาพปกคอร์ส ${d.title}`,src:d.image_url||"https://images.unsplash.com/photo-1635251595512-dc52146d5ae8"}),e.jsx("div",{className:"absolute top-3 right-3 bg-blue-300/80 backdrop-blur-sm rounded-full px-3 py-1 text-xs font-medium text-white-300",children:d.level==="beginner"?"ระดับเริ่มต้น":d.level==="intermediate"?"ระดับกลาง":d.level==="advanced"?"ระดับสูง":"ไม่ระบุ"}),e.jsx("div",{className:"absolute bottom-3 left-3 bg-gradient-to-r from-yellow-300 to-red-200 text-white-300 px-2 py-1 rounded text-xs font-semibold",children:d.category||"ทั่วไป"})]}),e.jsxs("div",{className:"p-5",children:[e.jsx("h3",{className:"text-lg font-bold text-blue-900 mb-2 line-clamp-2 h-14",children:d.title}),e.jsx("div",{className:"text-sm text-blue-700 mb-3 line-clamp-3 h-[60px]",children:v(d.description)}),e.jsxs("div",{className:"flex items-center justify-between mb-3 text-sm",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(as,{className:"w-4 h-4 text-blue-400"}),e.jsx("span",{className:"text-blue-900 font-medium",children:d.instructor_name||"อาจารย์"})]}),e.jsxs("div",{className:"flex items-center space-x-1 text-blue-700",children:[e.jsx(Le,{className:"w-4 h-4"}),e.jsx("span",{children:d.enrollment_count||0})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1 text-blue-700 text-sm",children:[e.jsx(re,{className:"w-4 h-4"}),e.jsxs("span",{children:[d.duration_hours||0," ชั่วโมง"]})]}),e.jsx("div",{className:"text-blue-900 font-bold",children:d.price>0?`฿${d.price.toLocaleString()}`:"ฟรี"})]}),e.jsx(_,{className:"w-full mt-4 bg-gradient-to-r from-[#667eea] to-[#764ba2] hover:from-[#5a6fcf] hover:to-[#673f8b] text-gray-800",children:"ดูรายละเอียด"})]})]})},d.id))}),o.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(K,{className:"w-16 h-16 text-slate-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-blue-900 mb-2",children:"ไม่พบคอร์สเรียน"}),e.jsx("p",{className:"text-blue-700 mb-4",children:"ลองปรับเปลี่ยนคำค้นหาหรือหมวดหมู่"}),e.jsx(_,{onClick:()=>{n(""),m("ทั้งหมด")},variant:"outline",className:"text-blue-900 border-blue-300 hover:bg-blue-100",children:"ดูคอร์สทั้งหมด"})]})]})]})})]})},$t=Object.freeze(Object.defineProperty({__proto__:null,default:Fs},Symbol.toStringTag,{value:"Module"})),Ms=async(s=null)=>{var t,a,i;try{let r=s;if(!r){const{data:{user:j},error:c}=await y.auth.getUser();if(c||!j)throw new Error("User not authenticated");r=j}console.log("ensureUserProfile: Checking profile for user:",r.id);const{data:l,error:n}=await y.from("user_profiles").select("user_id, full_name, email, role").eq("user_id",r.id).maybeSingle();if(n)throw console.error("ensureUserProfile: Error checking profile:",n),n;if(l)return console.log("ensureUserProfile: Profile exists:",l),{data:l,error:null,created:!1};console.log("ensureUserProfile: Creating new profile for user:",r.id);const g={user_id:r.id,full_name:((t=r.user_metadata)==null?void 0:t.full_name)||((a=r.user_metadata)==null?void 0:a.name)||((i=r.email)==null?void 0:i.split("@")[0])||"ผู้ใช้ใหม่",email:r.email,role:"student",is_active:!0},{data:m,error:v}=await y.from("user_profiles").insert([g]).select().single();if(v)throw console.error("ensureUserProfile: Error creating profile:",v),v;return console.log("ensureUserProfile: Profile created successfully:",m),{data:m,error:null,created:!0}}catch(r){return console.error("ensureUserProfile: Error:",r),{data:null,error:r,created:!1}}},Rs=async s=>{try{console.log("enrollmentService: Starting enrollment for courseId:",s);const{data:{user:t},error:a}=await y.auth.getUser();if(a||!t)throw console.error("enrollmentService: User authentication error:",a),new Error("User not authenticated");console.log("enrollmentService: User authenticated:",t.id),console.log("enrollmentService: Ensuring user profile exists...");const{data:i,error:r,created:l}=await Ms(t);if(r)throw console.error("enrollmentService: Error ensuring user profile:",r),new Error("ไม่สามารถตรวจสอบหรือสร้างโปรไฟล์ผู้ใช้ได้ กรุณาลองใหม่");l?console.log("enrollmentService: New user profile created for enrollment"):console.log("enrollmentService: User profile confirmed:",i.user_id),console.log("enrollmentService: Checking for existing enrollment...");const{data:n,error:g}=await y.from("enrollments").select("*").eq("user_id",t.id).eq("course_id",s).maybeSingle();if(console.log("enrollmentService: Existing enrollment check:",{existingEnrollment:n,checkError:g}),g)throw console.error("enrollmentService: Error checking existing enrollment:",g),g;if(n)return console.log("enrollmentService: User already enrolled"),{data:null,error:{message:"คุณได้ลงทะเบียนคอร์สนี้แล้ว"}};console.log("enrollmentService: Creating new enrollment...");const m={user_id:t.id,course_id:s,is_active:!0,progress_percentage:0};console.log("enrollmentService: Enrollment data:",m);const{data:v,error:j}=await y.from("enrollments").insert([m]).select(`
        *,
        courses(
          title,
          user_profiles!courses_instructor_id_fkey(full_name)
        )
      `).single();if(console.log("enrollmentService: Enrollment creation result:",{data:v,error:j}),j)throw console.error("enrollmentService: Enrollment creation failed:",j),j;return console.log("enrollmentService: Enrollment created successfully:",v),{data:v,error:null}}catch(t){return console.error("enrollmentService: Error enrolling in course:",t),{data:null,error:t}}},Ze=async s=>{try{console.log("enrollmentService: Checking enrollment for courseId:",s);const{data:{user:t},error:a}=await y.auth.getUser();if(a||!t)return console.log("enrollmentService: No user found or error:",a),{isEnrolled:!1,error:null};console.log("enrollmentService: Checking for user:",t.id);const{data:i,error:r}=await y.from("enrollments").select("id, is_active, enrolled_at, progress_percentage, completed_at").eq("user_id",t.id).eq("course_id",s).maybeSingle();if(console.log("enrollmentService: Database query result:",{data:i,error:r}),r)throw console.error("enrollmentService: Database error:",r),r;const l={isEnrolled:!!i,status:i?{...i,enrollment_id:i.id}:null,error:null};return console.log("enrollmentService: Final result:",l),l}catch(t){return console.error("enrollmentService: Error checking enrollment:",t),{isEnrolled:!1,error:t}}},Bs=async(s,t={})=>{try{const{categoryId:a=null,topicType:i=null,search:r=null,sortBy:l="last_reply_at",sortOrder:n="desc",page:g=1,limit:m=20}=t;let v=y.from("forum_topics").select("*").eq("course_id",s);r&&(v=v.textSearch("search_vector",r)),v=v.order("is_pinned",{ascending:!1}),v=v.order(l,{ascending:n==="asc"});const j=(g-1)*m,c=j+m-1;v=v.range(j,c);const{data:o,error:b,count:x}=await v;if(b)throw b;if(!o||o.length===0)return{data:[],error:null,pagination:{page:g,limit:m,total:0,hasMore:!1}};const d=[...new Set(o.map($=>$.author_id).filter(Boolean))];let h={};if(d.length>0){const{data:$}=await y.from("user_profiles").select("user_id, full_name, avatar_url, role").in("user_id",d);$&&$.forEach(A=>{h[A.user_id]=A})}return{data:o.map($=>({...$,user_profiles:h[$.author_id]||null})),error:null,pagination:{page:g,limit:m,total:x,hasMore:x>c+1}}}catch(a){return console.error("Error fetching course topics:",a),{data:null,error:a,pagination:null}}},Qs=async s=>{try{const{data:t,error:a}=await y.from("forum_topics").select("*").eq("id",s).single();if(a)throw a;let i=null;if(t.author_id){const{data:c}=await y.from("user_profiles").select("user_id, full_name, avatar_url, role").eq("user_id",t.author_id).single();i=c}let r=null,l=null;if(t.course_id){const{data:c}=await y.from("courses").select("id, title").eq("id",t.course_id).single();l=c}const{data:n,error:g}=await y.from("forum_replies").select("*").eq("topic_id",s).order("created_at",{ascending:!0});if(g)throw g;let m={};if(n&&n.length>0){const c=[...new Set(n.map(o=>o.author_id).filter(Boolean))];if(c.length>0){const{data:o}=await y.from("user_profiles").select("user_id, full_name, avatar_url, role").in("user_id",c);o&&o.forEach(b=>{m[b.user_id]=b})}}const v=(n||[]).map(c=>({...c,user_profiles:m[c.author_id]||null}));return await Gs(s),{data:{...t,user_profiles:i,forum_categories:r,courses:l,replies:v},error:null}}catch(t){return console.error("Error fetching topic with replies:",t),{data:null,error:t}}},Is=async s=>{var t;try{const i=(t=(await y.auth.getUser()).data.user)==null?void 0:t.id,{data:r,error:l}=await y.from("forum_topics").insert([{...s,author_id:i}]).select("*").single();if(l)throw l;let n=null;if(i){const{data:v}=await y.from("user_profiles").select("user_id, full_name, avatar_url, role").eq("user_id",i).single();n=v}return{data:{...r,user_profiles:n,forum_categories:null},error:null}}catch(a){return console.error("Error creating topic:",a),{data:null,error:a}}},Vs=async s=>{try{const{error:t}=await y.from("forum_topics").delete().eq("id",s);if(t)throw t;return{error:null}}catch(t){return console.error("Error deleting topic:",t),{error:t}}},Os=async(s,t)=>{try{const{data:a,error:i}=await y.from("forum_topics").update({is_pinned:t}).eq("id",s).select().single();if(i)throw i;return{data:a,error:null}}catch(a){return console.error("Error toggling topic pin:",a),{data:null,error:a}}},Hs=async(s,t)=>{try{const{data:a,error:i}=await y.from("forum_topics").update({is_locked:t}).eq("id",s).select().single();if(i)throw i;return{data:a,error:null}}catch(a){return console.error("Error toggling topic lock:",a),{data:null,error:a}}},Ws=async(s,t=null)=>{try{const{data:a,error:i}=await y.from("forum_topics").update({is_solved:!0,solved_reply_id:t}).eq("id",s).select().single();if(i)throw i;return{data:a,error:null}}catch(a){return console.error("Error marking topic as solved:",a),{data:null,error:a}}},Gs=async s=>{try{const{data:t}=await y.from("forum_topics").select("view_count").eq("id",s).single(),a=(t==null?void 0:t.view_count)||0,{error:i}=await y.from("forum_topics").update({view_count:a+1}).eq("id",s);if(i)throw i;return{error:null}}catch(t){return console.warn("Error incrementing view count:",t),{error:t}}},Ys=async s=>{var t;try{const i=(t=(await y.auth.getUser()).data.user)==null?void 0:t.id,{data:r,error:l}=await y.from("forum_replies").insert([{...s,author_id:i}]).select("*").single();if(l)throw l;let n=null;if(i){const{data:m}=await y.from("user_profiles").select("user_id, full_name, avatar_url, role").eq("user_id",i).single();n=m}return{data:{...r,user_profiles:n},error:null}}catch(a){return console.error("Error creating reply:",a),{data:null,error:a}}},Zs=async(s,t)=>{try{await y.from("forum_replies").update({is_best_answer:!1}).eq("topic_id",t);const{data:a,error:i}=await y.from("forum_replies").update({is_best_answer:!0}).eq("id",s).select().single();if(i)throw i;return await Ws(t,s),{data:a,error:null}}catch(a){return console.error("Error marking reply as best answer:",a),{data:null,error:a}}},Je=async(s,t)=>{var a;try{const i=(a=(await y.auth.getUser()).data.user)==null?void 0:a.id;if(!i)throw new Error("User not authenticated");const{data:r,error:l}=await y.from("forum_likes").select("id").eq("user_id",i).eq("target_type",s).eq("target_id",t).maybeSingle();if(l&&l.code!=="PGRST116")throw l;if(r){const{error:n}=await y.from("forum_likes").delete().eq("id",r.id);if(n)throw n;return{data:{liked:!1},error:null}}else{const{data:n,error:g}=await y.from("forum_likes").insert([{user_id:i,target_type:s,target_id:t}]).select().single();if(g)throw g;return{data:{liked:!0},error:null}}}catch(i){return console.error("Error toggling like:",i),{data:null,error:i}}},Js=async(s,t="all")=>{var a;try{const i=(a=(await y.auth.getUser()).data.user)==null?void 0:a.id;if(!i)throw new Error("User not authenticated");const{data:r,error:l}=await y.from("forum_subscriptions").upsert([{user_id:i,topic_id:s,notification_type:t}]).select().single();if(l)throw l;return{data:r,error:null}}catch(i){return console.error("Error subscribing to topic:",i),{data:null,error:i}}},Xs=async s=>{var t;try{const a=(t=(await y.auth.getUser()).data.user)==null?void 0:t.id;if(!a)throw new Error("User not authenticated");const{error:i}=await y.from("forum_subscriptions").delete().eq("user_id",a).eq("topic_id",s);if(i)throw i;return{error:null}}catch(a){return console.error("Error unsubscribing from topic:",a),{error:a}}},fe=s=>{const t=new Date(s),i=Math.floor((new Date-t)/1e3);return i<60?"เมื่อสักครู่":i<3600?`${Math.floor(i/60)} นาทีที่แล้ว`:i<86400?`${Math.floor(i/3600)} ชั่วโมงที่แล้ว`:i<604800?`${Math.floor(i/86400)} วันที่แล้ว`:t.toLocaleDateString("th-TH",{year:"numeric",month:"short",day:"numeric"})},Xe=s=>({discussion:"การสนทนา",question:"คำถาม",announcement:"ประกาศ",assignment_help:"ความช่วยเหลือเรื่องงาน"})[s]||s,Ke=s=>({discussion:"blue",question:"yellow",announcement:"red",assignment_help:"green"})[s]||"gray",Ks=({topic:s,onTopicClick:t,onLike:a,onPin:i,onLock:r,onDelete:l,onEdit:n,userRole:g="student",currentUserId:m})=>{var R,O,V;const[v,j]=f.useState(!1),[c,o]=f.useState(s.user_liked||!1),[b,x]=f.useState(s.like_count||0),d=m===s.author_id,h=g==="instructor"||g==="admin",D=h,$=d||h,A=d||h,F=Ke(s.topic_type),C={blue:"bg-blue-100 text-blue-800 border-blue-200",yellow:"bg-yellow-100 text-yellow-800 border-yellow-200",red:"bg-red-100 text-red-800 border-red-200",green:"bg-green-100 text-green-800 border-green-200",gray:"bg-gray-100 text-gray-800 border-gray-200"},q=async k=>{k.stopPropagation();try{await a(s.id),o(!c),x(E=>c?E-1:E+1)}catch(E){console.error("Error liking topic:",E)}},I=async k=>{k.stopPropagation();try{await i(s.id,!s.is_pinned)}catch(E){console.error("Error pinning topic:",E)}},w=async k=>{k.stopPropagation();try{await r(s.id,!s.is_locked)}catch(E){console.error("Error locking topic:",E)}},T=k=>{k.stopPropagation(),n(s)},U=async k=>{if(k.stopPropagation(),window.confirm("คุณแน่ใจหรือไม่ที่จะลบหัวข้อนี้?"))try{await l(s.id)}catch(E){console.error("Error deleting topic:",E)}};return e.jsxs(Q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},className:`bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer relative ${s.is_pinned?"ring-2 ring-yellow-200 bg-yellow-50":""}`,onClick:()=>t(s.id),children:[e.jsx("div",{className:"flex items-start justify-between p-6 pb-3",children:e.jsxs("div",{className:"flex items-start space-x-3 flex-1",children:[e.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold text-sm",children:(R=s.user_profiles)!=null&&R.avatar_url?e.jsx("img",{src:s.user_profiles.avatar_url,alt:s.user_profiles.full_name,className:"w-full h-full rounded-full object-cover"}):e.jsx(je,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex-1 pr-4",children:[e.jsx("h3",{className:`text-lg font-semibold text-gray-900 line-clamp-2 ${s.is_locked?"opacity-60":""}`,children:s.title}),e.jsxs("div",{className:"flex items-center space-x-2 mt-2",children:[e.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full border ${C[F]}`,children:Xe(s.topic_type)}),s.forum_categories&&e.jsx("span",{className:"px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700 border border-gray-200",children:s.forum_categories.name}),s.is_pinned&&e.jsxs("span",{className:"flex items-center space-x-1 px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800 border border-yellow-200",children:[e.jsx(Ne,{className:"w-3 h-3"}),e.jsx("span",{children:"ปักหมุด"})]}),s.is_locked&&e.jsxs("span",{className:"flex items-center space-x-1 px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800 border border-red-200",children:[e.jsx(oe,{className:"w-3 h-3"}),e.jsx("span",{children:"ล็อค"})]}),s.is_solved&&e.jsxs("span",{className:"flex items-center space-x-1 px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800 border border-green-200",children:[e.jsx(J,{className:"w-3 h-3"}),e.jsx("span",{children:"แก้ไขแล้ว"})]})]})]}),($||A||D)&&e.jsxs("div",{className:"relative",children:[e.jsx(_,{variant:"ghost",size:"sm",onClick:k=>{k.stopPropagation(),j(!v)},className:"p-1 h-8 w-8",children:e.jsx(is,{className:"w-4 h-4"})}),v&&e.jsxs("div",{className:"absolute right-0 top-8 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-[150px]",children:[$&&e.jsxs("button",{onClick:T,className:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50 flex items-center space-x-2",children:[e.jsx(ls,{className:"w-4 h-4"}),e.jsx("span",{children:"แก้ไข"})]}),D&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:I,className:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50 flex items-center space-x-2",children:[e.jsx(Ne,{className:"w-4 h-4"}),e.jsx("span",{children:s.is_pinned?"ยกเลิกปักหมุด":"ปักหมุด"})]}),e.jsxs("button",{onClick:w,className:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50 flex items-center space-x-2",children:[e.jsx(oe,{className:"w-4 h-4"}),e.jsx("span",{children:s.is_locked?"ปลดล็อค":"ล็อค"})]})]}),A&&e.jsxs("button",{onClick:U,className:"w-full px-3 py-2 text-left text-sm hover:bg-red-50 text-red-600 flex items-center space-x-2",children:[e.jsx(Te,{className:"w-4 h-4"}),e.jsx("span",{children:"ลบ"})]}),e.jsxs("button",{onClick:k=>{k.stopPropagation(),j(!1)},className:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50 flex items-center space-x-2 border-t border-gray-100",children:[e.jsx(ns,{className:"w-4 h-4"}),e.jsx("span",{children:"รายงาน"})]})]})]})]}),e.jsx("p",{className:"text-gray-600 text-sm line-clamp-2 mb-3",children:s.content}),e.jsxs("div",{className:"flex items-center text-xs text-gray-500 space-x-3",children:[e.jsx("span",{className:"font-medium",children:((O=s.user_profiles)==null?void 0:O.full_name)||"ผู้ใช้ไม่ระบุตัวตน"}),e.jsxs("span",{className:"flex items-center space-x-1",children:[e.jsx(re,{className:"w-3 h-3"}),e.jsx("span",{children:fe(s.created_at)})]}),((V=s.user_profiles)==null?void 0:V.role)==="instructor"&&e.jsx("span",{className:"px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full text-xs font-medium",children:"ผู้สอน"})]})]})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6 py-3 border-t border-gray-100 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center space-x-4 text-sm text-gray-500",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(he,{className:"w-4 h-4"}),e.jsx("span",{children:s.reply_count||0})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ie,{className:"w-4 h-4"}),e.jsx("span",{children:s.view_count||0})]})]}),e.jsxs("button",{onClick:q,className:`flex items-center space-x-1 px-3 py-1.5 rounded-full transition-all duration-200 ${c?"bg-red-100 text-red-600 hover:bg-red-200":"bg-gray-100 text-gray-500 hover:bg-gray-200"}`,children:[e.jsx(_e,{className:`w-4 h-4 ${c?"fill-current":""}`}),e.jsx("span",{className:"text-sm font-medium",children:b})]})]}),v&&e.jsx("div",{className:"fixed inset-0 z-0",onClick:()=>j(!1)})]})},ae={maxFileSize:50*1024*1024,allowedTypes:{"image/jpeg":{icon:"🖼️",preview:!0},"image/png":{icon:"🖼️",preview:!0},"image/gif":{icon:"🖼️",preview:!0},"image/webp":{icon:"🖼️",preview:!0},"application/pdf":{icon:"📄",preview:!1},"text/plain":{icon:"📝",preview:!1},"application/msword":{icon:"📘",preview:!1},"application/vnd.openxmlformats-officedocument.wordprocessingml.document":{icon:"📘",preview:!1},"application/vnd.ms-excel":{icon:"📊",preview:!1},"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":{icon:"📊",preview:!1},"application/zip":{icon:"🗜️",preview:!1},"application/x-zip-compressed":{icon:"🗜️",preview:!1}}},es=s=>{const t=[];return s.size>ae.maxFileSize&&t.push(`ไฟล์มีขนาดใหญ่เกินไป (สูงสุด ${ae.maxFileSize/1024/1024}MB)`),ae.allowedTypes[s.type]||t.push(`ประเภทไฟล์ไม่รองรับ: ${s.type}`),s.name.length>255&&t.push("ชื่อไฟล์ยาวเกินไป (สูงสุด 255 ตัวอักษร)"),{isValid:t.length===0,errors:t}},et=(s,t,a,i)=>{const r=Date.now(),l=Math.random().toString(36).substring(2);i.split(".").pop();const n=i.replace(/[^a-zA-Z0-9._-]/g,"_");return`${s}/${t}/${a}/${r}_${l}_${n}`},st=async(s,t,a)=>{try{const i=es(s);if(!i.isValid)throw new Error(i.errors.join(", "));const{data:{user:r},error:l}=await y.auth.getUser();if(l||!r)throw new Error("ผู้ใช้ไม่ได้เข้าสู่ระบบ");const n=et(r.id,t,a,s.name),{data:g,error:m}=await y.storage.from("content-attachments").upload(n,s,{cacheControl:"3600",upsert:!1});if(m)throw m;const{data:v,error:j}=await y.from("attachments").insert([{entity_type:t,entity_id:a,filename:s.name,file_url:g.path,file_size:s.size,mime_type:s.type,uploaded_by:r.id}]).select("*").single();if(j)throw await y.storage.from("content-attachments").remove([g.path]),j;return{data:v,error:null}}catch(i){return console.error("Error uploading file:",i),{data:null,error:i}}},tt=async(s,t,a)=>{try{const i=await Promise.allSettled(s.map(n=>st(n,t,a))),r=[],l=[];return i.forEach((n,g)=>{var m;n.status==="fulfilled"&&n.value.data?r.push(n.value.data):l.push({file:s[g].name,error:n.reason||((m=n.value)==null?void 0:m.error)})}),{data:{successful:r,failed:l},error:l.length>0?`${l.length} ไฟล์อัปโหลดไม่สำเร็จ`:null}}catch(i){return console.error("Error uploading multiple files:",i),{data:null,error:i}}},rt=async(s,t)=>{try{const{data:a,error:i}=await y.from("attachments").select("*").eq("entity_type",s).eq("entity_id",t).order("created_at",{ascending:!0});if(i)throw i;let r={};if(a&&a.length>0){const n=[...new Set(a.map(g=>g.uploaded_by).filter(Boolean))];if(n.length>0){const{data:g}=await y.from("user_profiles").select("user_id, full_name, avatar_url").in("user_id",n);g&&g.forEach(m=>{r[m.user_id]=m})}}return{data:a.map(n=>({...n,config:ae.allowedTypes[n.mime_type]||{icon:"📎",preview:!1},formattedSize:ss(n.file_size),uploader:r[n.uploaded_by]||null,publicUrl:null})),error:null}}catch(a){return console.error("Error getting attachments:",a),{data:[],error:a}}},at=async s=>{try{const{data:t}=y.storage.from("content-attachments").getPublicUrl(s);return t.publicUrl}catch(t){return console.error("Error getting file URL:",t),null}},it=async s=>{try{const{data:t,error:a}=await y.from("attachments").select("*").eq("id",s).single();if(a)throw a;const{data:i,error:r}=await y.storage.from("content-attachments").download(t.file_url);if(r)throw r;const l=URL.createObjectURL(i),n=document.createElement("a");return n.href=l,n.download=t.filename,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(l),{error:null}}catch(t){return console.error("Error downloading file:",t),{error:t}}},lt=async s=>{try{const{data:t,error:a}=await y.from("attachments").select("*").eq("id",s).single();if(a)throw a;const{data:{user:i}}=await y.auth.getUser();if(!i||i.id!==t.uploaded_by)throw new Error("คุณไม่มีสิทธิ์ลบไฟล์นี้");const{error:r}=await y.storage.from("content-attachments").remove([t.file_url]);r&&console.warn("Error deleting from storage:",r);const{error:l}=await y.from("attachments").delete().eq("id",s);if(l)throw l;return{error:null}}catch(t){return console.error("Error deleting attachment:",t),{error:t}}},nt=async s=>new Promise(t=>{if(!s.type.startsWith("image/")){t(null);return}const a=document.createElement("canvas"),i=a.getContext("2d"),r=new Image;r.onload=()=>{const n=Math.min(200/r.width,200/r.height);a.width=r.width*n,a.height=r.height*n,i.drawImage(r,0,0,a.width,a.height),a.toBlob(t,"image/jpeg",.8)},r.onerror=()=>t(null),r.src=URL.createObjectURL(s)}),ss=s=>{if(s===0)return"0 Bytes";const t=1024,a=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(s)/Math.log(t));return parseFloat((s/Math.pow(t,i)).toFixed(2))+" "+a[i]},Se=s=>{var t;return((t=ae.allowedTypes[s])==null?void 0:t.icon)||"📎"},Ee=s=>{var t;return((t=ae.allowedTypes[s])==null?void 0:t.preview)||!1},ot=({targetType:s,targetId:t,currentUserId:a,userRole:i="student",onAttachmentDeleted:r})=>{const[l,n]=f.useState([]),[g,m]=f.useState(!0),[v,j]=f.useState(null),[c,o]=f.useState(null),{toast:b}=X(),x=i==="instructor"||i==="admin";f.useEffect(()=>{d()},[s,t]);const d=async()=>{m(!0);try{const{data:C,error:q}=await rt(s,t);if(q)throw q;n(C||[])}catch(C){console.error("Error loading attachments:",C),b({title:"เกิดข้อผิดพลาด",description:"ไม่สามารถโหลดไฟล์แนบได้",variant:"destructive"})}m(!1)},h=async C=>{try{const{error:q}=await it(C.id);if(q)throw q;b({title:"ดาวน์โหลดสำเร็จ",description:`ดาวน์โหลดไฟล์ ${C.file_name} เรียบร้อยแล้ว`})}catch{b({title:"เกิดข้อผิดพลาด",description:"ไม่สามารถดาวน์โหลดไฟล์ได้",variant:"destructive"})}},D=async C=>{if(!(a===C.uploaded_by||x)){b({title:"ไม่มีสิทธิ์",description:"คุณไม่สามารถลบไฟล์นี้ได้",variant:"destructive"});return}if(confirm(`คุณแน่ใจหรือไม่ที่จะลบไฟล์ "${C.file_name}"?`))try{const{error:I}=await lt(C.id);if(I)throw I;n(w=>w.filter(T=>T.id!==C.id)),r==null||r(C),b({title:"ลบไฟล์สำเร็จ",description:`ลบไฟล์ ${C.file_name} เรียบร้อยแล้ว`})}catch{b({title:"เกิดข้อผิดพลาด",description:"ไม่สามารถลบไฟล์ได้",variant:"destructive"})}},$=async C=>{if(!Ee(C.file_type)){h(C);return}try{const q=await at(C.file_url);j(q),o(C)}catch{b({title:"เกิดข้อผิดพลาด",description:"ไม่สามารถแสดงตัวอย่างไฟล์ได้",variant:"destructive"})}},A=()=>{j(null),o(null)},F=C=>new Date(C).toLocaleDateString("th-TH",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});return g?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"})}):l.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("div",{className:"text-4xl mb-2",children:"📎"}),e.jsx("p",{children:"ยังไม่มีไฟล์แนบ"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx(se,{children:l.map(C=>{var I,w;const q=a===C.uploaded_by||x;return C.file_type.startsWith("image/"),e.jsx(Q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center text-xl",children:Se(C.file_type)})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 truncate",children:C.file_name}),e.jsxs("div",{className:"flex items-center space-x-4 mt-1 text-xs text-gray-500",children:[e.jsx("span",{children:C.formattedSize}),e.jsxs("span",{className:"flex items-center space-x-1",children:[e.jsx(je,{className:"w-3 h-3"}),e.jsx("span",{children:((w=(I=C.uploader)==null?void 0:I.user_profiles)==null?void 0:w.full_name)||"ผู้ใช้ไม่ระบุตัวตน"})]}),e.jsxs("span",{className:"flex items-center space-x-1",children:[e.jsx(Oe,{className:"w-3 h-3"}),e.jsx("span",{children:F(C.created_at)})]}),C.download_count>0&&e.jsxs("span",{children:["ดาวน์โหลด ",C.download_count," ครั้ง"]})]})]}),e.jsxs("div",{className:"flex items-center space-x-1 ml-3",children:[Ee(C.file_type)&&e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>$(C),className:"p-2",title:"ดูตัวอย่าง",children:e.jsx(ie,{className:"w-4 h-4"})}),e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>h(C),className:"p-2",title:"ดาวน์โหลด",children:e.jsx(pe,{className:"w-4 h-4"})}),q&&e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>D(C),className:"p-2 text-red-600 hover:text-red-700 hover:bg-red-50",title:"ลบไฟล์",children:e.jsx(Te,{className:"w-4 h-4"})})]})]})})]})},C.id)})}),e.jsx(se,{children:v&&c&&e.jsx(Q.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4",onClick:A,children:e.jsxs(Q.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},className:"bg-white rounded-lg max-w-4xl max-h-[90vh] overflow-hidden",onClick:C=>C.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:c.file_name}),e.jsx("p",{className:"text-sm text-gray-500",children:c.formattedSize})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(_,{variant:"outline",size:"sm",onClick:()=>h(c),children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),"ดาวน์โหลด"]}),e.jsx(_,{variant:"ghost",size:"sm",onClick:A,children:"✕"})]})]}),e.jsx("div",{className:"p-4 max-h-[70vh] overflow-auto",children:c.file_type.startsWith("image/")?e.jsx("img",{src:v,alt:c.file_name,className:"max-w-full h-auto rounded"}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"text-6xl mb-4",children:Se(c.file_type)}),e.jsx("p",{className:"text-gray-600",children:"ไม่สามารถแสดงตัวอย่างไฟล์ประเภทนี้ได้"}),e.jsxs(_,{onClick:()=>h(c),className:"mt-4",children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),"ดาวน์โหลดเพื่อดู"]})]})})]})})})]})},ct=({topicId:s,onBack:t,currentUserId:a,userRole:i="student"})=>{var O,V,k,E;const[r,l]=f.useState(null),[n,g]=f.useState([]),[m,v]=f.useState(!0),[j,c]=f.useState(!1),[o,b]=f.useState(""),[x,d]=f.useState(null),[h,D]=f.useState(!1),{toast:$}=X(),F=i==="instructor"||i==="admin";f.useEffect(()=>{C()},[s]);const C=async()=>{try{v(!0);const{data:S,error:B}=await Qs(s);if(B)throw B;l(S),g(S.replies||[])}catch(S){console.error("Error loading topic:",S),$({title:"เกิดข้อผิดพลาด",description:"ไม่สามารถโหลดข้อมูลหัวข้อได้",variant:"destructive"})}finally{v(!1)}},q=async S=>{if(S.preventDefault(),!!o.trim())try{c(!0);const{data:B,error:P}=await Ys({topic_id:s,content:o,parent_reply_id:(x==null?void 0:x.id)||null});if(P)throw P;g(H=>[...H,B]),b(""),d(null),l(H=>({...H,reply_count:(H.reply_count||0)+1})),$({title:"ส่งความคิดเห็นสำเร็จ",description:"ความคิดเห็นของคุณถูกเพิ่มแล้ว"})}catch(B){console.error("Error creating reply:",B),$({title:"เกิดข้อผิดพลาด",description:"ไม่สามารถส่งความคิดเห็นได้",variant:"destructive"})}finally{c(!1)}},I=async(S,B)=>{try{const{data:P,error:H}=await Je(S,B);if(H)throw H;S==="topic"?l(G=>({...G,like_count:P.liked?(G.like_count||0)+1:Math.max((G.like_count||0)-1,0),user_liked:P.liked})):g(G=>G.map(z=>z.id===B?{...z,like_count:P.liked?(z.like_count||0)+1:Math.max((z.like_count||0)-1,0),user_liked:P.liked}:z))}catch(P){console.error("Error toggling like:",P)}},w=async S=>{try{const{error:B}=await Zs(S,s);if(B)throw B;g(P=>P.map(H=>({...H,is_best_answer:H.id===S}))),l(P=>({...P,is_solved:!0,solved_reply_id:S})),$({title:"เลือกคำตอบที่ดีที่สุดแล้ว",description:"หัวข้อนี้ถูกทำเครื่องหมายว่าแก้ไขแล้ว"})}catch(B){console.error("Error marking best answer:",B),$({title:"เกิดข้อผิดพลาด",description:"ไม่สามารถเลือกคำตอบที่ดีที่สุดได้",variant:"destructive"})}},T=async()=>{try{h?(await Xs(s),D(!1),$({title:"ยกเลิกการติดตามแล้ว",description:"คุณจะไม่ได้รับการแจ้งเตือนจากหัวข้อนี้อีก"})):(await Js(s),D(!0),$({title:"ติดตามหัวข้อแล้ว",description:"คุณจะได้รับการแจ้งเตือนเมื่อมีความคิดเห็นใหม่"}))}catch(S){console.error("Error toggling subscription:",S)}};if(m)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"})});if(!r)return e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-gray-500",children:"ไม่พบหัวข้อที่ต้องการ"}),e.jsxs(_,{onClick:t,className:"mt-4",children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"กลับ"]})]});const U=Ke(r.topic_type),R={blue:"bg-blue-100 text-blue-800 border-blue-200",yellow:"bg-yellow-100 text-yellow-800 border-yellow-200",red:"bg-red-100 text-red-800 border-red-200",green:"bg-green-100 text-green-800 border-green-200",gray:"bg-gray-100 text-gray-800 border-gray-200"};return e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(_,{variant:"ghost",onClick:t,className:"flex items-center space-x-2",children:[e.jsx(ce,{className:"w-4 h-4"}),e.jsx("span",{children:"กลับไปรายการหัวข้อ"})]}),e.jsx(_,{variant:"outline",onClick:T,className:"flex items-center space-x-2",children:h?e.jsxs(e.Fragment,{children:[e.jsx(os,{className:"w-4 h-4"}),e.jsx("span",{children:"ยกเลิกติดตาม"})]}):e.jsxs(e.Fragment,{children:[e.jsx(cs,{className:"w-4 h-4"}),e.jsx("span",{children:"ติดตาม"})]})})]}),e.jsxs(Q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"bg-white border border-gray-200 rounded-xl shadow-sm",children:[e.jsx("div",{className:"p-6 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-start space-x-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold",children:(O=r.user_profiles)!=null&&O.avatar_url?e.jsx("img",{src:r.user_profiles.avatar_url,alt:r.user_profiles.full_name,className:"w-full h-full rounded-full object-cover"}):e.jsx(je,{className:"w-6 h-6"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx("span",{className:`px-3 py-1 text-sm font-medium rounded-full border ${R[U]}`,children:Xe(r.topic_type)}),r.forum_categories&&e.jsx("span",{className:"px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-700 border border-gray-200",children:r.forum_categories.name}),r.is_pinned&&e.jsxs("span",{className:"flex items-center space-x-1 px-3 py-1 text-sm font-medium rounded-full bg-yellow-100 text-yellow-800 border border-yellow-200",children:[e.jsx(Ne,{className:"w-4 h-4"}),e.jsx("span",{children:"ปักหมุด"})]}),r.is_locked&&e.jsxs("span",{className:"flex items-center space-x-1 px-3 py-1 text-sm font-medium rounded-full bg-red-100 text-red-800 border border-red-200",children:[e.jsx(oe,{className:"w-4 h-4"}),e.jsx("span",{children:"ล็อค"})]}),r.is_solved&&e.jsxs("span",{className:"flex items-center space-x-1 px-3 py-1 text-sm font-medium rounded-full bg-green-100 text-green-800 border border-green-200",children:[e.jsx(J,{className:"w-4 h-4"}),e.jsx("span",{children:"แก้ไขแล้ว"})]})]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-3",children:r.title}),e.jsxs("div",{className:"flex items-center text-sm text-gray-500 space-x-4",children:[e.jsx("span",{className:"font-medium",children:((V=r.user_profiles)==null?void 0:V.full_name)||"ผู้ใช้ไม่ระบุตัวตน"}),e.jsxs("span",{className:"flex items-center space-x-1",children:[e.jsx(re,{className:"w-4 h-4"}),e.jsx("span",{children:fe(r.created_at)})]}),((k=r.user_profiles)==null?void 0:k.role)==="instructor"&&e.jsx("span",{className:"px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium",children:"ผู้สอน"})]})]})]})}),e.jsxs("div",{className:"p-6 border-b border-gray-100",children:[e.jsx("div",{className:"prose max-w-none",children:e.jsx("p",{className:"text-gray-700 whitespace-pre-wrap",children:r.content})}),e.jsx("div",{className:"mt-6",children:e.jsx(ot,{targetType:"topic",targetId:r.id,currentUserId:a,userRole:i})})]}),e.jsxs("div",{className:"flex items-center justify-between p-6 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center space-x-6 text-sm text-gray-500",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(he,{className:"w-4 h-4"}),e.jsxs("span",{children:[r.reply_count||0," ความคิดเห็น"]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ie,{className:"w-4 h-4"}),e.jsxs("span",{children:[r.view_count||0," ครั้ง"]})]})]}),e.jsxs("button",{onClick:()=>I("topic",r.id),className:`flex items-center space-x-1 px-4 py-2 rounded-full transition-all duration-200 ${r.user_liked?"bg-red-100 text-red-600 hover:bg-red-200":"bg-gray-100 text-gray-500 hover:bg-gray-200"}`,children:[e.jsx(_e,{className:`w-4 h-4 ${r.user_liked?"fill-current":""}`}),e.jsx("span",{className:"font-medium",children:r.like_count||0})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h2",{className:"text-xl font-semibold text-gray-900 flex items-center",children:[e.jsx(he,{className:"w-5 h-5 mr-2"}),"ความคิดเห็น (",n.length,")"]}),!r.is_locked&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-6",children:[x&&e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-blue-800",children:["ตอบกลับ: ",(E=x.user_profiles)==null?void 0:E.full_name]}),e.jsx("button",{onClick:()=>d(null),className:"text-blue-600 hover:text-blue-800",children:"✕"})]}),e.jsx("p",{className:"text-sm text-blue-700 line-clamp-2",children:x.content})]}),e.jsxs("form",{onSubmit:q,className:"space-y-4",children:[e.jsx("textarea",{value:o,onChange:S=>b(S.target.value),placeholder:"เขียนความคิดเห็น...",className:"w-full p-4 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none",rows:4,required:!0}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-500",children:x?"ตอบกลับความคิดเห็น":"ความคิดเห็นใหม่"}),e.jsxs(_,{type:"submit",disabled:j||!o.trim(),className:"flex items-center space-x-2",children:[e.jsx(He,{className:"w-4 h-4"}),e.jsx("span",{children:j?"กำลังส่ง...":"ส่งความคิดเห็น"})]})]})]})]}),e.jsx(se,{children:n.map((S,B)=>{var P,H,G;return e.jsxs(Q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:B*.1},className:`bg-white border border-gray-200 rounded-xl p-6 ${S.is_best_answer?"ring-2 ring-green-200 bg-green-50":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold text-sm",children:(P=S.user_profiles)!=null&&P.avatar_url?e.jsx("img",{src:S.author.user_profiles.profile_image_url,alt:S.author.user_profiles.full_name,className:"w-full h-full rounded-full object-cover"}):e.jsx(je,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx("span",{className:"font-semibold text-gray-900",children:((H=S.user_profiles)==null?void 0:H.full_name)||"ผู้ใช้ไม่ระบุตัวตน"}),((G=S.user_profiles)==null?void 0:G.role)==="instructor"&&e.jsx("span",{className:"px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full text-xs font-medium",children:"ผู้สอน"}),S.is_best_answer&&e.jsxs("span",{className:"flex items-center space-x-1 px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs font-medium",children:[e.jsx(be,{className:"w-3 h-3"}),e.jsx("span",{children:"คำตอบที่ดีที่สุด"})]})]}),e.jsx("span",{className:"text-sm text-gray-500",children:fe(S.created_at)})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[F&&!S.is_best_answer&&r.topic_type==="question"&&e.jsxs(_,{variant:"outline",size:"sm",onClick:()=>w(S.id),className:"flex items-center space-x-1",children:[e.jsx(be,{className:"w-4 h-4"}),e.jsx("span",{children:"เลือกเป็นคำตอบที่ดีที่สุด"})]}),e.jsxs(_,{variant:"ghost",size:"sm",onClick:()=>d(S),className:"flex items-center space-x-1",children:[e.jsx(ds,{className:"w-4 h-4"}),e.jsx("span",{children:"ตอบกลับ"})]})]})]}),e.jsx("div",{className:"mb-4",children:e.jsx("p",{className:"text-gray-700 whitespace-pre-wrap",children:S.content})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-500",children:S.updated_at!==S.created_at&&e.jsxs("span",{children:["แก้ไขเมื่อ ",fe(S.updated_at)]})}),e.jsxs("button",{onClick:()=>I("reply",S.id),className:`flex items-center space-x-1 px-3 py-1.5 rounded-full transition-all duration-200 ${S.user_liked?"bg-red-100 text-red-600 hover:bg-red-200":"bg-gray-100 text-gray-500 hover:bg-gray-200"}`,children:[e.jsx(_e,{className:`w-4 h-4 ${S.user_liked?"fill-current":""}`}),e.jsx("span",{className:"text-sm font-medium",children:S.like_count||0})]})]})]},S.id)})}),n.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(he,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"ยังไม่มีความคิดเห็น"}),e.jsx("p",{className:"text-sm",children:"เป็นคนแรกที่แสดงความคิดเห็นในหัวข้อนี้"})]})]})]})},dt=({targetType:s,targetId:t,onFilesUploaded:a,maxFiles:i=5,disabled:r=!1})=>{const[l,n]=f.useState([]),[g,m]=f.useState(!1),[v,j]=f.useState(!1),[c,o]=f.useState({}),b=f.useRef(null),{toast:x}=X(),d=w=>{w.preventDefault(),r||m(!0)},h=w=>{w.preventDefault(),m(!1)},D=w=>{if(w.preventDefault(),m(!1),r)return;const T=Array.from(w.dataTransfer.files);A(T)},$=w=>{const T=Array.from(w.target.files);A(T)},A=async w=>{if(l.length+w.length>i){x({title:"ไฟล์เกินจำนวนที่กำหนด",description:`สามารถอัปโหลดได้สูงสุด ${i} ไฟล์`,variant:"destructive"});return}const T=[],U=[];for(const R of w){const O=es(R);O.isValid?T.push({file:R,id:Math.random().toString(36),status:"pending",error:null}):U.push({name:R.name,errors:O.errors})}if(U.length>0&&x({title:"ไฟล์บางไฟล์ไม่ถูกต้อง",description:U.map(R=>`${R.name}: ${R.errors.join(", ")}`).join(`
`),variant:"destructive"}),T.length>0){n(R=>[...R,...T]);for(const R of T)if(Ee(R.file.type)){const O=await nt(R.file);O&&o(V=>({...V,[R.id]:URL.createObjectURL(O)}))}}},F=w=>{n(T=>T.filter(U=>U.id!==w)),o(T=>{const U={...T};return U[w]&&(URL.revokeObjectURL(U[w]),delete U[w]),U})},C=async()=>{if(l.length!==0){j(!0);try{const w=l.filter(U=>U.status==="pending").map(U=>U.file),T=await tt(w,s,t);if(T.data){const{successful:U,failed:R}=T.data;n(O=>O.map(V=>{const k=U.find(S=>S.file_name===V.file.name),E=R.find(S=>S.file===V.file.name);return k?{...V,status:"completed"}:E?{...V,status:"error",error:E.error}:V})),U.length>0&&(x({title:"อัปโหลดสำเร็จ",description:`อัปโหลดไฟล์สำเร็จ ${U.length} ไฟล์`}),a==null||a(U)),R.length>0&&x({title:"อัปโหลดบางไฟล์ไม่สำเร็จ",description:`${R.length} ไฟล์อัปโหลดไม่สำเร็จ`,variant:"destructive"})}}catch{x({title:"เกิดข้อผิดพลาด",description:"ไม่สามารถอัปโหลดไฟล์ได้",variant:"destructive"})}j(!1)}},q=()=>{const w=l.filter(T=>T.status==="completed").map(T=>T.id);w.forEach(T=>{c[T]&&URL.revokeObjectURL(c[T])}),n(T=>T.filter(U=>U.status!=="completed")),o(T=>{const U={...T};return w.forEach(R=>delete U[R]),U})},I=(w,T)=>{switch(w){case"completed":return e.jsx(ms,{className:"w-4 h-4 text-green-600"});case"error":return e.jsx($e,{className:"w-4 h-4 text-red-600"});default:return null}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:`relative border-2 border-dashed rounded-lg p-6 text-center transition-all duration-200 ${g?"border-indigo-500 bg-indigo-50":r?"border-gray-200 bg-gray-50 cursor-not-allowed":"border-gray-300 hover:border-gray-400 cursor-pointer"}`,onDragOver:d,onDragLeave:h,onDrop:D,onClick:()=>{var w;return!r&&((w=b.current)==null?void 0:w.click())},children:[e.jsx("input",{ref:b,type:"file",multiple:!0,className:"hidden",onChange:$,disabled:r}),e.jsx(De,{className:`w-8 h-8 mx-auto mb-3 ${r?"text-gray-400":"text-gray-600"}`}),e.jsx("p",{className:`text-sm font-medium ${r?"text-gray-400":"text-gray-700"}`,children:g?"วางไฟล์ที่นี่":"คลิกหรือลากไฟล์มาวางที่นี่"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"รองรับ: รูปภาพ, PDF, เอกสาร (สูงสุด 50MB ต่อไฟล์)"})]}),e.jsx(se,{children:l.length>0&&e.jsx(Q.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"space-y-2",children:l.map(w=>e.jsxs(Q.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},className:`flex items-center space-x-3 p-3 bg-gray-50 rounded-lg ${w.status==="error"?"border border-red-200":""}`,children:[e.jsx("div",{className:"flex-shrink-0",children:c[w.id]?e.jsx("img",{src:c[w.id],alt:w.file.name,className:"w-10 h-10 object-cover rounded"}):e.jsx("div",{className:"w-10 h-10 bg-gray-200 rounded flex items-center justify-center text-lg",children:Se(w.file.type)})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:w.file.name}),e.jsx("p",{className:"text-xs text-gray-500",children:ss(w.file.size)}),w.error&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:w.error.message||"เกิดข้อผิดพลาด"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[I(w.status,w.error),w.status==="pending"&&e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>F(w.id),className:"p-1 h-auto",children:e.jsx(we,{className:"w-4 h-4"})})]})]},w.id))})}),l.length>0&&e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t",children:[e.jsxs("span",{className:"text-sm text-gray-600",children:[l.length," ไฟล์ (",l.filter(w=>w.status==="pending").length," รอการอัปโหลด)"]}),e.jsxs("div",{className:"flex space-x-2",children:[l.some(w=>w.status==="completed")&&e.jsx(_,{variant:"outline",size:"sm",onClick:q,disabled:v,children:"ล้างไฟล์ที่เสร็จแล้ว"}),e.jsx(_,{onClick:C,disabled:v||l.filter(w=>w.status==="pending").length===0,size:"sm",className:"bg-indigo-600 hover:bg-indigo-700",children:v?e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"w-4 h-4 mr-2 animate-spin"}),"กำลังอัปโหลด..."]}):e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"w-4 h-4 mr-2"}),"อัปโหลด (",l.filter(w=>w.status==="pending").length,")"]})})]})]})]})},mt=({isOpen:s,onClose:t,courseId:a,onTopicCreated:i})=>{const[r,l]=f.useState({title:"",content:""}),[n,g]=f.useState(!1),{toast:m}=X();f.useEffect(()=>{s&&l({title:"",content:""})},[s]);const v=async c=>{if(c.preventDefault(),!r.title.trim()||!r.content.trim()){m({title:"ข้อมูลไม่ครบถ้วน",description:"กรุณากรอกชื่อหัวข้อและเนื้อหา",variant:"destructive"});return}try{g(!0);const o={course_id:a,title:r.title.trim(),content:r.content.trim()},{data:b,error:x}=await Is(o);if(x)throw x;m({title:"สร้างหัวข้อสำเร็จ",description:"หัวข้อของคุณถูกเพิ่มในฟอรัมแล้ว"}),i(b),t()}catch(o){console.error("Error creating topic:",o),m({title:"เกิดข้อผิดพลาด",description:o.message||"ไม่สามารถสร้างหัวข้อได้",variant:"destructive"})}finally{g(!1)}},j=(c,o)=>{l(b=>({...b,[c]:o}))};return s?e.jsx(se,{children:e.jsx(Q.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",onClick:t,children:e.jsxs(Q.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},className:"bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col",onClick:c=>c.stopPropagation(),children:[e.jsx("div",{className:"bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-white/20 p-2 rounded-lg",children:e.jsx(ge,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"สร้างหัวข้อใหม่"}),e.jsx("p",{className:"text-indigo-100 mt-1",children:"แบ่งปันความคิดเห็นหรือถามคำถาม"})]})]}),e.jsx(_,{variant:"ghost",size:"icon",onClick:t,className:"text-white hover:bg-white/20 rounded-lg",children:e.jsx(we,{className:"w-6 h-6"})})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("form",{onSubmit:v,className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-semibold text-gray-800 mb-3",children:"ชื่อหัวข้อ *"}),e.jsx("input",{type:"text",value:r.title,onChange:c=>j("title",c.target.value),placeholder:"เช่น วิธีการใช้ React Hooks อย่างมีประสิทธิภาพ",className:"w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-lg",maxLength:200,required:!0}),e.jsxs("div",{className:"flex justify-between mt-2",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"ชื่อหัวข้อที่ดึงดูดความสนใจ"}),e.jsxs("span",{className:"text-sm text-gray-400",children:[r.title.length,"/200"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-semibold text-gray-800 mb-3",children:"เนื้อหา *"}),e.jsx("textarea",{value:r.content,onChange:c=>j("content",c.target.value),placeholder:"แบ่งปันความคิดเห็น ประสบการณ์ หรือข้อมูลที่น่าสนใจ...",className:"w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none",rows:8,maxLength:5e3,required:!0}),e.jsxs("div",{className:"flex justify-between mt-2",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"รองรับ Markdown สำหรับการจัดรูปแบบข้อความ"}),e.jsxs("span",{className:"text-sm text-gray-400",children:[r.content.length,"/5000"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-semibold text-gray-800 mb-3",children:"แนบไฟล์ (ไม่บังคับ)"}),e.jsx(dt,{targetType:"topic",targetId:null,onFilesUploaded:c=>{console.log("Files uploaded:",c)},maxFiles:5,disabled:n})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-semibold text-blue-800 mb-2",children:"💡 คำแนะนำการใช้ฟอรัม"}),e.jsxs("ul",{className:"text-sm text-blue-700 space-y-1",children:[e.jsx("li",{children:"• ใช้ชื่อหัวข้อที่ชัดเจนและเข้าใจง่าย"}),e.jsx("li",{children:"• เขียนเนื้อหาที่มีประโยชน์และเกี่ยวข้องกับคอร์ส"}),e.jsx("li",{children:"• หากเป็นคำถาม ให้ระบุรายละเอียดครบถ้วน"}),e.jsx("li",{children:"• เคารพความคิดเห็นของผู้อื่นและใช้ภาษาที่สุภาพ"}),e.jsx("li",{children:"• ค้นหาก่อนสร้างหัวข้อใหม่ เผื่อมีคนถามแล้ว"})]})]})]})}),e.jsx("div",{className:"bg-gray-50 px-6 py-4 border-t border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"* ฟิลด์ที่จำเป็นต้องกรอก"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(_,{type:"button",variant:"outline",onClick:t,disabled:n,className:"px-6",children:"ยกเลิก"}),e.jsxs(_,{type:"button",onClick:v,disabled:n||!r.title.trim()||!r.content.trim(),className:"px-6 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white",children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),n?"กำลังสร้าง...":"สร้างหัวข้อ"]})]})]})})]})})}):null},ut=()=>{var H,G;const{courseId:s}=We(),{toast:t}=X(),{user:a}=Ge(),i=z=>z?z.split(`
`).map((p,u)=>e.jsxs(Ve.Fragment,{children:[p,u<z.split(`
`).length-1&&e.jsx("br",{})]},u)):"",[r,l]=f.useState(null),[n,g]=f.useState(!0),[m,v]=f.useState({isEnrolled:!1,status:null}),[j,c]=f.useState(!1),[o,b]=f.useState("forum"),[x,d]=f.useState([]),[h,D]=f.useState(null),[$,A]=f.useState(!1),[F,C]=f.useState(!1),q=f.useCallback(async()=>{g(!0),console.log("Loading course with ID:",s);const{data:z,error:p}=await Ye(s);console.log("Course data:",z,"Error:",p),p?(console.error("Course loading error:",p),t({title:"ข้อผิดพลาดในการโหลดข้อมูล",description:p.message,variant:"destructive"})):l(z),g(!1)},[s,t]),I=f.useCallback(async()=>{if(!a)return;console.log("CourseDetailPage: Checking enrollment status for user:",a==null?void 0:a.id,"course:",s);const{isEnrolled:z,status:p,error:u}=await Ze(s);console.log("CourseDetailPage: Enrollment check result:",{isEnrolled:z,status:p,error:u}),u?console.error("CourseDetailPage: Enrollment check error:",u):(v({isEnrolled:z,status:p}),console.log("CourseDetailPage: Enrollment status updated:",{isEnrolled:z,status:p}))},[s,a]);f.useEffect(()=>{q(),a&&I()},[q,I,a]),f.useEffect(()=>{o==="forum"&&m.isEnrolled&&T()},[o,m.isEnrolled]);const w=async()=>{if(!a){t({title:"กรุณาเข้าสู่ระบบก่อน",description:"คุณต้องเข้าสู่ระบบก่อนลงทะเบียนเรียน",variant:"destructive"});return}console.log("CourseDetailPage: Starting enrollment for user:",a.id,"course:",s),c(!0);const{data:z,error:p}=await Rs(s);console.log("CourseDetailPage: Enrollment result:",{data:z,error:p}),p?(console.error("CourseDetailPage: Enrollment failed:",p),t({title:"ไม่สามารถลงทะเบียนได้",description:p.message,variant:"destructive"})):(console.log("CourseDetailPage: Enrollment successful, updating state"),t({title:"ลงทะเบียนสำเร็จ!",description:`คุณได้ลงทะเบียนคอร์ส "${r==null?void 0:r.title}" เรียบร้อยแล้ว`}),v({isEnrolled:!0,status:"active"}),console.log("CourseDetailPage: Enrollment status set to:",{isEnrolled:!0,status:"active"}),setTimeout(()=>{console.log("CourseDetailPage: Re-checking enrollment status after enrollment"),I()},1e3)),c(!1)},T=async()=>{try{C(!0);const{data:z,error:p}=await Bs(s,{sortBy:"last_reply_at",sortOrder:"desc",limit:50});if(p)throw p;d(z||[])}catch(z){console.error("Error loading forum topics:",z),t({title:"เกิดข้อผิดพลาด",description:"ไม่สามารถโหลดหัวข้อฟอรัมได้",variant:"destructive"})}finally{C(!1)}},U=z=>{D(z)},R=()=>{D(null),T()},O=z=>{d(p=>[z,...p]),t({title:"สร้างหัวข้อสำเร็จ",description:"หัวข้อของคุณถูกเพิ่มในฟอรัมแล้ว"})},V=async z=>{try{await Je("topic",z),d(p=>p.map(u=>u.id===z?{...u,like_count:u.user_liked?(u.like_count||0)-1:(u.like_count||0)+1,user_liked:!u.user_liked}:u))}catch(p){console.error("Error liking topic:",p)}},k=async(z,p)=>{try{await Os(z,p),d(u=>u.map(N=>N.id===z?{...N,is_pinned:p}:N)),t({title:p?"ปักหมุดหัวข้อแล้ว":"ยกเลิกปักหมุดแล้ว",description:"สถานะหัวข้อถูกอัปเดตแล้ว"})}catch(u){console.error("Error pinning topic:",u)}},E=async(z,p)=>{try{await Hs(z,p),d(u=>u.map(N=>N.id===z?{...N,is_locked:p}:N)),t({title:p?"ล็อคหัวข้อแล้ว":"ปลดล็อคหัวข้อแล้ว",description:"สถานะหัวข้อถูกอัปเดตแล้ว"})}catch(u){console.error("Error locking topic:",u)}},S=async z=>{try{await Vs(z),d(p=>p.filter(u=>u.id!==z)),t({title:"ลบหัวข้อแล้ว",description:"หัวข้อถูกลบออกจากฟอรัมแล้ว"})}catch(p){console.error("Error deleting topic:",p)}},B={initial:{opacity:0,y:20},in:{opacity:1,y:0},out:{opacity:0,y:-20}},P={type:"tween",ease:"anticipate",duration:.5};return n?e.jsx("div",{className:"container mx-auto px-4 py-12",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-[#667eea] mx-auto mb-4"}),e.jsx("p",{className:"text-emerald-700",children:"กำลังโหลดข้อมูลคอร์ส..."})]})}):r?e.jsxs(Q.div,{initial:"initial",animate:"in",exit:"out",variants:B,transition:P,className:"container mx-auto px-4 py-12",children:[e.jsxs(Pe,{children:[e.jsxs("title",{children:[r.title," - Login Learning"]}),e.jsx("meta",{name:"description",content:r.description})]}),e.jsx("div",{className:"mb-8",children:e.jsxs(te,{to:"/courses",className:"flex items-center text-emerald-700 hover:text-emerald-900 transition-colors",children:[e.jsx(ce,{className:"w-5 h-5 mr-2"}),"กลับไปหน้าคอร์สเรียนทั้งหมด"]})}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs(Q.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.1},className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"glass-effect p-6 sm:p-8 rounded-xl shadow-xl",children:[e.jsx("h1",{className:"text-3xl sm:text-4xl font-bold text-emerald-900 mb-4",children:r.title}),e.jsx("div",{className:"text-emerald-800 text-lg leading-relaxed mb-6",children:i(r.description)}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{className:"w-5 h-5 text-[#667eea]"}),e.jsxs("span",{className:"text-emerald-800",children:["สอนโดย: ",r.instructor_name||"ไม่ระบุ"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(re,{className:"w-5 h-5 text-[#667eea]"}),e.jsxs("span",{className:"text-emerald-800",children:["ระยะเวลา: ",r.duration_hours||0," ชั่วโมง"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Le,{className:"w-5 h-5 text-[#667eea]"}),e.jsxs("span",{className:"text-emerald-800",children:["ผู้เรียน: ",r.enrollment_count||0," คน"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(be,{className:"w-5 h-5 text-[#667eea]"}),e.jsxs("span",{className:"text-emerald-800",children:["ระดับ: ",r.level||"ไม่ระบุ"]})]})]}),e.jsx("img",{className:"w-full h-64 sm:h-96 object-cover rounded-lg mb-6 shadow-md",alt:r.title,src:r.image_url||"https://images.unsplash.com/photo-1635251595512-dc52146d5ae8",onError:z=>{z.target.src="https://images.unsplash.com/photo-1635251595512-dc52146d5ae8"}})]}),e.jsxs("div",{className:"glass-effect p-6 sm:p-8 rounded-xl shadow-xl",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("h2",{className:"text-2xl font-semibold text-emerald-900 flex items-center",children:[e.jsx(ge,{className:"w-6 h-6 mr-2"}),"ฟอรัมสนทนา"]})}),m.isEnrolled?e.jsx("div",{children:h?e.jsx(ct,{topicId:h,onBack:R,currentUserId:a==null?void 0:a.id,userRole:((H=a==null?void 0:a.user_profiles)==null?void 0:H.role)||"student"}):e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center justify-end mb-6",children:e.jsxs(_,{onClick:()=>A(!0),className:"bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white",children:[e.jsx(ke,{className:"w-4 h-4 mr-2"}),"สร้างหัวข้อใหม่"]})}),F?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"})}):x.length>0?e.jsx("div",{className:"space-y-4",children:x.map(z=>{var p;return e.jsx(Ks,{topic:z,onTopicClick:U,onLike:V,onPin:k,onLock:E,onDelete:S,onEdit:u=>{console.log("Edit topic:",u)},userRole:((p=a==null?void 0:a.user_profiles)==null?void 0:p.role)||"student",currentUserId:a==null?void 0:a.id},z.id)})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ge,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-600 mb-2",children:"ยังไม่มีหัวข้อสนทนา"}),e.jsx("p",{className:"text-gray-500 mb-6",children:"เป็นคนแรกที่เริ่มการสนทนาในคอร์สนี้"}),e.jsxs(_,{onClick:()=>A(!0),className:"bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white",children:[e.jsx(ke,{className:"w-4 h-4 mr-2"}),"สร้างหัวข้อแรก"]})]})]})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ge,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-600 mb-2",children:"ลงทะเบียนเพื่อเข้าถึงฟอรัมสนทนา"}),e.jsx("p",{className:"text-gray-500 mb-6",children:"เข้าร่วมการสนทนาและแลกเปลี่ยนความคิดเห็นกับเพื่อนนักเรียนและอาจารย์"}),e.jsx("p",{className:"text-sm text-gray-400",children:"กรุณาลงทะเบียนคอร์สก่อนเพื่อเข้าถึงฟอรัมสนทนา"})]})]})]}),e.jsxs(Q.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{delay:.2},className:"lg:col-span-1 space-y-6",children:[e.jsxs("div",{className:"glass-effect p-6 sm:p-8 rounded-xl shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h2",{className:"text-3xl font-bold text-emerald-900",children:["฿",((G=r.price)==null?void 0:G.toLocaleString())||"0"]}),e.jsxs("div",{className:"flex items-center",children:[[...Array(5)].map((z,p)=>e.jsx(us,{className:"w-5 h-5 text-yellow-400 fill-current"},p)),e.jsx("span",{className:"ml-2 text-sm text-emerald-800",children:"(5.0)"})]})]}),e.jsx("p",{className:"text-sm text-emerald-700 mb-6",children:"ราคาพิเศษสำหรับนักเรียน Login Learning"}),m.isEnrolled&&e.jsxs("div",{className:"flex items-center space-x-2 mb-4 p-3 bg-green-500/20 rounded-lg border border-green-500/30",children:[e.jsx(xs,{className:"w-5 h-5 text-green-400"}),e.jsx("span",{className:"text-green-400 font-medium",children:"คุณได้ลงทะเบียนคอร์สนี้แล้ว"})]}),m.isEnrolled?e.jsx(te,{to:`/courses/${s}/learn`,className:"block w-full",children:e.jsxs(_,{size:"lg",className:"w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white text-lg py-3",children:[e.jsx(K,{className:"w-5 h-5 mr-2"}),"เริ่มเรียน"]})}):e.jsxs(_,{size:"lg",className:"w-full bg-gradient-to-r from-[#667eea] to-[#764ba2] hover:from-[#5a6fcf] hover:to-[#673f8b] text-gray-800 text-lg py-3",onClick:w,disabled:j,children:[e.jsx(hs,{className:"w-5 h-5 mr-2"}),j?"กำลังลงทะเบียน...":"ลงทะเบียนเรียนเลย"]}),e.jsx("p",{className:"text-xs text-slate-500 mt-4 text-center",children:"รับประกันความพึงพอใจ คืนเงินภายใน 7 วัน"})]}),e.jsxs("div",{className:"glass-effect p-6 sm:p-8 rounded-xl shadow-xl",children:[e.jsx("h3",{className:"text-xl font-semibold text-emerald-900 mb-3",children:"สิ่งที่คุณจะได้รับ"}),e.jsx("ul",{className:"space-y-2 text-emerald-800 text-sm list-disc list-inside",children:r.learning_outcomes&&r.learning_outcomes.length>0?(()=>{try{return(typeof r.learning_outcomes=="string"?JSON.parse(r.learning_outcomes):r.learning_outcomes).filter(p=>p.trim()!=="").map((p,u)=>e.jsx("li",{children:p},u))}catch(z){return console.warn("Error parsing learning outcomes:",z),[e.jsx("li",{children:"ความรู้และทักษะทางวิศวกรรมที่แข็งแกร่ง"},"default-1"),e.jsx("li",{children:"ประสบการณ์ทำโปรเจกต์จริง"},"default-2"),e.jsx("li",{children:"ใบประกาศนียบัตรเมื่อเรียนจบ"},"default-3"),e.jsx("li",{children:"คำแนะนำจากผู้เชี่ยวชาญ"},"default-4"),e.jsx("li",{children:"โอกาสในการสร้างเครือข่าย"},"default-5")]}})():e.jsxs(e.Fragment,{children:[e.jsx("li",{children:"ความรู้และทักษะทางวิศวกรรมที่แข็งแกร่ง"}),e.jsx("li",{children:"ประสบการณ์ทำโปรเจกต์จริง"}),e.jsx("li",{children:"ใบประกาศนียบัตรเมื่อเรียนจบ"}),e.jsx("li",{children:"คำแนะนำจากผู้เชี่ยวชาญ"}),e.jsx("li",{children:"โอกาสในการสร้างเครือข่าย"})]})})]}),r.tools_required&&(()=>{try{const p=(typeof r.tools_required=="string"?JSON.parse(r.tools_required):r.tools_required).filter(u=>u.trim()!=="");if(p.length>0)return e.jsxs("div",{className:"glass-effect p-6 sm:p-8 rounded-xl shadow-xl",children:[e.jsx("h3",{className:"text-xl font-semibold text-emerald-900 mb-3",children:"เครื่องมือที่ใช้"}),e.jsx("ul",{className:"space-y-2 text-emerald-800 text-sm list-disc list-inside",children:p.map((u,N)=>e.jsx("li",{children:u},N))})]})}catch(z){console.warn("Error parsing tools required:",z)}return null})()]})]}),e.jsx(mt,{isOpen:$,onClose:()=>A(!1),courseId:s,onTopicCreated:O})]}):e.jsx("div",{className:"container mx-auto px-4 py-12",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx($e,{className:"w-16 h-16 text-red-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-emerald-900 mb-2",children:"ไม่พบข้อมูลคอร์ส"}),e.jsx("p",{className:"text-emerald-700 mb-4",children:"คอร์สที่คุณกำลังมองหาไม่มีอยู่ในระบบ"}),e.jsx(te,{to:"/courses",children:e.jsx(_,{variant:"outline",className:"text-emerald-900 border-emerald-300 hover:bg-emerald-100",children:"กลับไปหน้าคอร์สทั้งหมด"})})]})})},Dt=Object.freeze(Object.defineProperty({__proto__:null,default:ut},Symbol.toStringTag,{value:"Module"})),xt=s=>{if(!s)return"unknown";const t=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,/youtube\.com\/v\/([a-zA-Z0-9_-]{11})/];for(const r of t){const l=s.match(r);if(l)return{type:"youtube",id:l[1]}}return[".mp4",".webm",".ogg",".mov",".avi"].some(r=>s.toLowerCase().includes(r))||s.startsWith("blob:")||s.startsWith("data:")?{type:"direct",url:s}:{type:"unknown"}},ht=(s,t=!1)=>{const a=new URLSearchParams({enablejsapi:"1",origin:window.location.origin,autoplay:t?"1":"0",rel:"0",modestbranding:"1",iv_load_policy:"3",cc_load_policy:"0",disablekb:"1",fs:"1",playsinline:"1"});return`https://www.youtube.com/embed/${s}?${a.toString()}`},pt=({src:s,contentId:t,title:a,autoPlay:i=!1,initialTime:r=0,onComplete:l})=>{const n=f.useRef(null),g=f.useRef(null),m=xt(s),v=m.type==="youtube",j=m.type==="direct",[c,o]=f.useState(!1),[b,x]=f.useState(r),[d,h]=f.useState(0),[D,$]=f.useState(1),[A,F]=f.useState(!1),[C,q]=f.useState(!1),[I,w]=f.useState(!0),[T,U]=f.useState(!0),[R,O]=f.useState(1);f.useEffect(()=>{const p=n.current;if(!p||!j)return;r>0&&(p.currentTime=r);const u=()=>{h(p.duration),w(!1)},N=()=>{x(p.currentTime)},L=()=>{o(!0)},M=()=>{o(!1)},W=()=>{o(!1)},Z=()=>{$(p.volume),F(p.muted)},Y=()=>w(!0),de=()=>w(!1);return p.addEventListener("loadedmetadata",u),p.addEventListener("timeupdate",N),p.addEventListener("play",L),p.addEventListener("pause",M),p.addEventListener("ended",W),p.addEventListener("volumechange",Z),p.addEventListener("waiting",Y),p.addEventListener("canplay",de),()=>{p.removeEventListener("loadedmetadata",u),p.removeEventListener("timeupdate",N),p.removeEventListener("play",L),p.removeEventListener("pause",M),p.removeEventListener("ended",W),p.removeEventListener("volumechange",Z),p.removeEventListener("waiting",Y),p.removeEventListener("canplay",de)}},[r,j]),f.useEffect(()=>{if(!j)return;let p;const u=()=>{U(!0),clearTimeout(p),p=setTimeout(()=>{c&&U(!1)},3e3)},N=g.current;return N&&(N.addEventListener("mousemove",u),N.addEventListener("mouseleave",()=>{c&&U(!1)})),()=>{clearTimeout(p),N&&N.removeEventListener("mousemove",u)}},[c,j]);const V=()=>{if(!j)return;const p=n.current;p&&p.paused?p.play():p&&p.pause()},k=p=>{if(!j)return;const u=n.current;if(!u)return;const N=p.currentTarget.getBoundingClientRect(),L=(p.clientX-N.left)/N.width;u.currentTime=L*d},E=()=>{if(!j)return;const p=n.current;p&&(p.muted=!p.muted)},S=p=>{if(!j)return;const u=n.current;if(!u)return;const N=parseFloat(p.target.value);u.volume=N,$(N),F(N===0)},B=()=>{const p=g.current;document.fullscreenElement?document.exitFullscreen().then(()=>{q(!1)}):p.requestFullscreen().then(()=>{q(!0)})},P=p=>{if(!j)return;const u=n.current;u&&(u.currentTime=Math.max(0,Math.min(d,u.currentTime+p)))},H=p=>{if(!j)return;const u=n.current;u&&(u.playbackRate=p,O(p))},G=p=>{const u=Math.floor(p/60),N=Math.floor(p%60);return`${u}:${N.toString().padStart(2,"0")}`},z=j&&d>0?b/d*100:0;return m.type==="unknown"?e.jsx("div",{className:"relative bg-gray-900 rounded-lg overflow-hidden p-8 text-center",children:e.jsxs("div",{className:"text-white",children:[e.jsx(Ae,{className:"w-16 h-16 mx-auto mb-4 opacity-50"}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"ไม่รองรับประเภทวิดีโอนี้"}),e.jsx("p",{className:"text-gray-300 mb-4",children:"กรุณาใช้ YouTube URL หรือไฟล์วิดีโอที่รองรับ (.mp4, .webm, .ogg)"}),e.jsx("p",{className:"text-xs text-gray-400 break-all",children:s}),s&&e.jsxs("a",{href:s,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors",children:[e.jsx(Ae,{className:"w-4 h-4 mr-2"}),"เปิดในแท็บใหม่"]})]})}):e.jsxs("div",{ref:g,className:"relative bg-black rounded-lg overflow-hidden group cursor-pointer",onClick:j?V:void 0,children:[v&&e.jsxs(e.Fragment,{children:[e.jsx("iframe",{src:ht(m.id,i),className:"w-full h-[400px] lg:h-[500px]",frameBorder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen",allowFullScreen:!0,sandbox:"allow-scripts allow-same-origin",onLoad:()=>{console.log("🎬 Iframe loaded"),w(!1)}}),e.jsx("div",{className:"absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded",children:"YouTube"})]}),j&&e.jsx("video",{ref:n,src:s,className:"w-full h-auto max-h-[500px] object-contain",autoPlay:i,preload:"metadata",onClick:p=>p.stopPropagation()}),j&&I&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/50",children:e.jsx(ve,{className:"w-12 h-12 text-white animate-spin"})}),j&&!c&&!I&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/30",children:e.jsx(Q.div,{initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},className:"bg-white/20 backdrop-blur-sm rounded-full p-4",children:e.jsx(Ue,{className:"w-16 h-16 text-white ml-2"})})}),j&&e.jsxs(Q.div,{initial:{opacity:1},animate:{opacity:T?1:0},transition:{duration:.3},className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4",onClick:p=>p.stopPropagation(),children:[e.jsx("div",{className:"mb-4",children:e.jsx("div",{className:"w-full h-2 bg-white/20 rounded-full cursor-pointer",onClick:k,children:e.jsx("div",{className:"h-full bg-blue-500 rounded-full relative",style:{width:`${z}%`},children:e.jsx("div",{className:"absolute right-0 top-1/2 transform -translate-y-1/2 w-4 h-4 bg-blue-500 rounded-full -mr-2"})})})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(_,{variant:"ghost",size:"icon",className:"text-white hover:bg-white/20",onClick:V,children:c?e.jsx(ps,{className:"w-6 h-6"}):e.jsx(Ue,{className:"w-6 h-6"})}),e.jsx(_,{variant:"ghost",size:"icon",className:"text-white hover:bg-white/20",onClick:()=>P(-10),children:e.jsx(gs,{className:"w-5 h-5"})}),e.jsx(_,{variant:"ghost",size:"icon",className:"text-white hover:bg-white/20",onClick:()=>P(10),children:e.jsx(fs,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(_,{variant:"ghost",size:"icon",className:"text-white hover:bg-white/20",onClick:E,children:A||D===0?e.jsx(js,{className:"w-5 h-5"}):e.jsx(bs,{className:"w-5 h-5"})}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:A?0:D,onChange:S,className:"w-20 h-1 bg-white/20 rounded-lg appearance-none slider"})]}),e.jsxs("span",{className:"text-white text-sm font-mono",children:[G(b)," / ",G(d)]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("select",{value:R,onChange:p=>H(parseFloat(p.target.value)),className:"bg-transparent text-white text-sm border border-white/20 rounded px-2 py-1",children:[e.jsx("option",{value:"0.5",className:"bg-black",children:"0.5x"}),e.jsx("option",{value:"0.75",className:"bg-black",children:"0.75x"}),e.jsx("option",{value:"1",className:"bg-black",children:"1x"}),e.jsx("option",{value:"1.25",className:"bg-black",children:"1.25x"}),e.jsx("option",{value:"1.5",className:"bg-black",children:"1.5x"}),e.jsx("option",{value:"2",className:"bg-black",children:"2x"})]}),e.jsx(_,{variant:"ghost",size:"icon",className:"text-white hover:bg-white/20",onClick:B,children:e.jsx(vs,{className:"w-5 h-5"})})]})]})]}),a&&e.jsx(Q.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:`absolute top-4 left-4 right-4 ${v?"z-10":""}`,children:e.jsx("h3",{className:"text-white text-lg font-semibold bg-black/50 backdrop-blur-sm rounded px-3 py-2",children:a})}),t&&l&&e.jsx(Q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"absolute bottom-20 right-4 z-20",children:e.jsxs(_,{onClick:()=>l(t),className:"bg-green-600 hover:bg-green-700 text-white shadow-lg",size:"sm",children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"ผ่านเนื้อหานี้"]})})]})},ze=async s=>{try{const{data:t,error:a}=await y.from("quizzes").select("*").eq("content_id",s).eq("is_active",!0).order("id",{ascending:!1}).limit(1);if(a)throw a;return{data:t&&t.length>0?t[0]:null,error:null}}catch(t){return console.error("Error fetching quiz:",t),{data:null,error:t}}},gt=async s=>{try{const{data:{user:t},error:a}=await y.auth.getUser();if(a||!t)return{data:[],error:null};const{data:i,error:r}=await y.from("quiz_attempts").select("*").eq("user_id",t.id).eq("quiz_id",s).order("started_at",{ascending:!1});if(r)throw r;return{data:i||[],error:null}}catch(t){return console.error("Error fetching quiz attempts:",t),{data:[],error:t}}},ft=async s=>{try{const{data:{user:t},error:a}=await y.auth.getUser();if(a||!t)throw new Error("User not authenticated");const{data:i,error:r}=await y.from("quizzes").select("*").eq("id",s).single();if(r)throw r;const{data:l,error:n}=await gt(s);if(n)throw n;const g=Date.now(),{data:m,error:v}=await y.from("quiz_attempts").insert([{user_id:t.id,quiz_id:s,answers:{},score:0,started_at:new Date().toISOString()}]).select().single();if(v)throw v;return{data:{...m,quiz:i},error:null}}catch(t){return console.error("Error starting quiz attempt:",t),{data:null,error:t}}},jt=async(s,t)=>{try{const{data:{user:a},error:i}=await y.auth.getUser();if(i||!a)throw new Error("User not authenticated");const{data:r,error:l}=await y.from("quiz_attempts").select("*").eq("id",s).eq("user_id",a.id).single();if(l)throw l;const{data:n,error:g}=await y.from("quizzes").select("*").eq("id",r.quiz_id).single();if(g)throw g;const m=bt(n.questions,t),v=m.percentage>=n.passing_score,j=new Date().toISOString(),c=new Date(r.started_at),o=new Date(j),b=Math.round((o-c)/(1e3*60)),{data:x,error:d}=await y.from("quiz_attempts").update({answers:t,score:m.percentage,completed_at:j}).eq("id",s).eq("user_id",a.id).select("*").single();if(d)throw d;return{data:{...x,score_details:m},error:null}}catch(a){return console.error("Error submitting quiz attempt:",a),{data:null,error:a}}},bt=(s,t)=>{let a=0;const i={};s.forEach((l,n)=>{const g=l.id||n.toString(),m=t[g],v=vt(l,m);v&&a++,i[g]={is_correct:v,correct_answer:wt(l),user_answer:m,explanation:l.explanation||null}});const r=s.length>0?Math.round(a/s.length*100):0;return{correct_count:a,total_questions:s.length,percentage:r,feedback:i}},vt=(s,t)=>{switch(s.type){case"multiple_choice":return t===s.correct_answer;case"true_false":return t===s.correct_answer;case"fill_blank":return(Array.isArray(s.correct_answer)?s.correct_answer:[s.correct_answer]).some(l=>(t==null?void 0:t.toLowerCase().trim())===l.toLowerCase().trim());case"multiple_select":if(!Array.isArray(t)||!Array.isArray(s.correct_answer))return!1;const i=new Set(t.sort()),r=new Set(s.correct_answer.sort());return i.size===r.size&&[...i].every(l=>r.has(l));default:return!1}},wt=s=>{switch(s.type){case"multiple_choice":case"true_false":return s.correct_answer;case"fill_blank":return Array.isArray(s.correct_answer)?s.correct_answer[0]:s.correct_answer;case"multiple_select":return s.correct_answer;default:return null}},yt=async(s,t,a)=>{try{const{data:{user:i},error:r}=await y.auth.getUser();if(r||!i)throw new Error("User not authenticated");if((await ze(s)).data)throw new Error("แบบทดสอบสำหรับเนื้อหานี้มีอยู่แล้ว");const n={title:a.title,description:a.description||"",questions:a.questions,is_active:!0};try{n.content_id=s;const{data:g,error:m}=await y.from("quizzes").insert([n]).select().single();if(m)throw m;return{data:g,error:null}}catch{console.log("content_id column not found, using course_id fallback"),delete n.content_id,n.course_id=t;const{data:m,error:v}=await y.from("quizzes").insert([n]).select().single();if(v)throw v;return{data:m,error:null}}}catch(i){return console.error("Error creating quiz for content:",i),{data:null,error:i}}},Nt=({quiz:s,onComplete:t,onClose:a})=>{var O,V,k;const{toast:i}=X(),[r,l]=f.useState(null),[n,g]=f.useState(0),[m,v]=f.useState({}),[j,c]=f.useState(0),[o,b]=f.useState(!1),[x,d]=f.useState(null),[h,D]=f.useState(!1),$=f.useCallback(async()=>{if(!r)return;D(!0);const{data:E,error:S}=await jt(r.id,m);if(S){i({title:"ไม่สามารถส่งแบบทดสอบได��",description:S.message,variant:"destructive"}),D(!1);return}d(E),b(!0),D(!1),i({title:E.is_passed?"ผ่านแบบทดสอบ! 🎉":"ไม่ผ่านแบบทดสอบ",description:`คะแนนที่ได้: ${E.score}/${E.max_score} (${E.score}%)`,variant:E.is_passed?"default":"destructive"}),t==null||t(E)},[r,m,i,t]),A=f.useCallback(async()=>{D(!0);const{data:E,error:S}=await ft(s.id);if(S){i({title:"ไม่สามารถเริ่มแบบทดสอบได้",description:S.message,variant:"destructive"}),a==null||a();return}l(E),s.time_limit>0&&c(s.time_limit*60),D(!1)},[s.id,s.time_limit,i,a]);f.useEffect(()=>{A()},[A]),f.useEffect(()=>{if(j>0&&!o){const E=setTimeout(()=>{c(j-1)},1e3);return()=>clearTimeout(E)}else j===0&&s.time_limit>0&&!o&&$()},[j,o,s.time_limit,$]);const F=(E,S)=>{v(B=>({...B,[E]:S}))},C=()=>{n<s.questions.length-1&&g(n+1)},q=()=>{n>0&&g(n-1)},I=E=>{const S=Math.floor(E/60),B=E%60;return`${S}:${B.toString().padStart(2,"0")}`},w=()=>Object.keys(m).length;if(h&&!r)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-700",children:"กำลังเตรียมแบบทดสอบ..."})]})});if(o&&x)return e.jsxs(Q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-6",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:`mx-auto w-16 h-16 rounded-full flex items-center justify-center ${x.is_passed?"bg-green-500/20 text-green-400":"bg-red-500/20 text-red-400"}`,children:x.is_passed?e.jsx(ws,{className:"w-8 h-8"}):e.jsx(qe,{className:"w-8 h-8"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-900 mb-2",children:x.is_passed?"ยินดีด้วย! คุณผ่านแบบทดสอบ":"เสียใจด้วย คุณไม่ผ่านแบบทดสอบ"}),e.jsxs("p",{className:"text-gray-700",children:["คะแนนที่ได้: ",x.score,"% | ต้องการ: ",s.passing_score,"%"]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 shadow-sm p-6 rounded-xl",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900 mb-4",children:"รายละเอียดคะแนน"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-400",children:((O=x.score_details)==null?void 0:O.correct_count)||0}),e.jsx("div",{className:"text-sm text-gray-700",children:"ตอบถูก"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-slate-300",children:((V=x.score_details)==null?void 0:V.total_questions)||0}),e.jsx("div",{className:"text-sm text-gray-700",children:"ทั้งหมด"})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-green-400",children:[x.score,"%"]}),e.jsx("div",{className:"text-sm text-gray-700",children:"คะแนนรวม"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-400",children:x.time_spent_minutes||0}),e.jsx("div",{className:"text-sm text-gray-700",children:"นาที"})]})]})]}),s.show_correct_answers&&((k=x.score_details)==null?void 0:k.feedback)&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:"ตรวจสอบคำตอบ"}),s.questions.map((E,S)=>{const B=E.id||S.toString(),P=x.score_details.feedback[B];return e.jsx(Q.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:S*.1},className:`bg-white border border-gray-200 shadow-sm p-4 rounded-lg border-l-4 ${P!=null&&P.is_correct?"border-green-500":"border-red-500"}`,children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:`mt-1 ${P!=null&&P.is_correct?"text-green-400":"text-red-400"}`,children:P!=null&&P.is_correct?e.jsx(J,{className:"w-5 h-5"}):e.jsx(qe,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-gray-900 font-medium mb-2",children:E.question}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-700",children:"คำตอบของคุณ: "}),e.jsx("span",{className:P!=null&&P.is_correct?"text-green-400":"text-red-400",children:Array.isArray(P==null?void 0:P.user_answer)?P.user_answer.join(", "):(P==null?void 0:P.user_answer)||"ไม่ได้ตอบ"})]}),!(P!=null&&P.is_correct)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-700",children:"คำตอบที่ถูก: "}),e.jsx("span",{className:"text-green-400",children:Array.isArray(P==null?void 0:P.correct_answer)?P.correct_answer.join(", "):P==null?void 0:P.correct_answer})]}),(P==null?void 0:P.explanation)&&e.jsxs("div",{className:"mt-2 p-2 bg-blue-500/10 rounded text-blue-300",children:[e.jsx("strong",{children:"คำอธิบาย:"})," ",P.explanation]})]})]})]})},B)})]}),e.jsxs("div",{className:"flex justify-center space-x-4",children:[e.jsx(_,{onClick:a,variant:"outline",children:"ปิด"}),!x.is_passed&&(r==null?void 0:r.attempt_number)<s.max_attempts&&e.jsxs(_,{onClick:()=>{b(!1),d(null),g(0),v({}),A()},className:"bg-blue-500 hover:bg-blue-600",children:[e.jsx(ys,{className:"w-4 h-4 mr-2"}),"ลองใหม่"]})]})]});const T=s.questions[n],U=T.id||n.toString(),R=m[U];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:s.title}),e.jsxs("p",{className:"text-gray-700",children:["คำถามที่ ",n+1," จาก ",s.questions.length]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[s.time_limit>0&&e.jsxs("div",{className:`flex items-center space-x-2 ${j<300?"text-red-400":"text-gray-700"}`,children:[e.jsx(re,{className:"w-4 h-4"}),e.jsx("span",{className:"font-mono",children:I(j)})]}),e.jsxs("div",{className:"text-gray-700 text-sm",children:["ตอบแล้ว: ",w(),"/",s.questions.length]})]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-500 h-2 rounded-full transition-all duration-300",style:{width:`${(n+1)/s.questions.length*100}%`}})}),e.jsx(se,{mode:"wait",children:e.jsx(Q.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},transition:{duration:.3},className:"bg-white border border-gray-200 shadow-sm p-6 rounded-xl",children:e.jsx(_t,{question:T,questionId:U,userAnswer:R,onAnswerChange:F})},n)}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(_,{onClick:q,disabled:n===0,variant:"outline",children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"ก่อนหน้า"]}),e.jsx("div",{className:"flex items-center space-x-2",children:n===s.questions.length-1?e.jsx(_,{onClick:$,disabled:h||w()===0,className:"bg-green-500 hover:bg-green-600",children:h?"กำลังส่ง...":"ส่งคำตอบ"}):e.jsxs(_,{onClick:C,children:["ถัดไป",e.jsx(Ns,{className:"w-4 h-4 ml-2"})]})})]}),w()<s.questions.length&&e.jsxs("div",{className:"flex items-center space-x-2 text-amber-400 text-sm",children:[e.jsx($e,{className:"w-4 h-4"}),e.jsxs("span",{children:["คุณยังตอบคำถามไม่ครบ (",s.questions.length-w()," ข้อ)"]})]})]})},_t=({question:s,questionId:t,userAnswer:a,onAnswerChange:i})=>{const r=()=>{switch(s.type){case"multiple_choice":return e.jsx("div",{className:"space-y-3",children:s.options.map((l,n)=>e.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-gray-100 transition-colors bg-gray-50 border border-gray-200",children:[e.jsx("input",{type:"radio",name:t,value:l,checked:a===l,onChange:g=>i(t,g.target.value),className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-gray-900",children:l})]},n))});case"multiple_select":return e.jsx("div",{className:"space-y-3",children:s.options.map((l,n)=>e.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-gray-100 transition-colors bg-gray-50 border border-gray-200",children:[e.jsx("input",{type:"checkbox",value:l,checked:Array.isArray(a)&&a.includes(l),onChange:g=>{const m=Array.isArray(a)?a:[];g.target.checked?i(t,[...m,l]):i(t,m.filter(v=>v!==l))},className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-gray-900",children:l})]},n))});case"true_false":return e.jsx("div",{className:"space-y-3",children:[!0,!1].map(l=>e.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-gray-100 transition-colors bg-gray-50 border border-gray-200",children:[e.jsx("input",{type:"radio",name:t,value:l,checked:a===l,onChange:n=>i(t,n.target.value==="true"),className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-gray-900",children:l?"ถูก":"ผิด"})]},l.toString()))});case"fill_blank":return e.jsx("input",{type:"text",value:a||"",onChange:l=>i(t,l.target.value),placeholder:"พิมพ์คำตอบของคุณ...",className:"w-full p-3 bg-white border border-gray-300 rounded-lg text-gray-900 focus:border-blue-500 focus:outline-none"});default:return e.jsx("p",{className:"text-red-400",children:"ไม่รองรับประเภทคำถามนี้"})}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:s.question}),s.image&&e.jsx("img",{src:s.image,alt:"Question",className:"max-w-full h-auto rounded-lg"}),r(),s.hint&&e.jsxs("div",{className:"text-sm text-blue-300 bg-blue-500/10 p-3 rounded-lg",children:[e.jsx("strong",{children:"คำแนะนำ:"})," ",s.hint]})]})},kt=({contentId:s,assignment:t,onComplete:a,onClose:i})=>{const{toast:r}=X(),l=k=>k?k.graded_at&&k.score!==null?"graded":k.submitted_at?"submitted":"draft":"draft",[n,g]=f.useState(!0),[m,v]=f.useState(t),[j,c]=f.useState([]),[o,b]=f.useState(null),[x,d]=f.useState(""),[h,D]=f.useState([]),[$,A]=f.useState(!1),[F,C]=f.useState(!1),[q,I]=f.useState("submit"),w=f.useCallback(async()=>{g(!0);try{let k=m;if(!k){const{data:E,error:S}=await Ce(s);if(S)throw S;v(E),k=E}if(k!=null&&k.id){const{data:E,error:S}=await Ds(k.id);if(S)throw S;if(c(E),E.length>0){const B=E[0];b(B),d(B.submission_text||""),D([]),B.submitted_at||l(B)==="submitted"||l(B)==="graded"?I("view"):I("edit")}}}catch(k){console.error("Error loading assignment data:",k),r({title:"ไ���่สามารถโหลดข้อมูลงานได้",description:k.message,variant:"destructive"})}finally{g(!1)}},[s,m,r]);f.useEffect(()=>{w()},[w]);const T=async()=>{if(m){A(!0);try{const k={text:x};let E;if(o&&!o.submitted_at?E=await Re(o.id,k):E=await Be(m.id,k),E.error)throw E.error;b(E.data),r({title:"บันทึกแบบร่างแล้ว",description:"งานของคุณได้รับการบันทึกเป็นแบบร่างแล้ว"}),w()}catch(k){console.error("Error saving draft:",k),r({title:"ไม่สามารถบันทึกได้",description:k.message,variant:"destructive"})}finally{A(!1)}}},U=async()=>{if(m){if(!x.trim()){r({title:"กรุณาเพิ่มเนื้อหา",description:"กรุณาเขียนคำตอบหรือเนื้อหางาน",variant:"destructive"});return}C(!0);try{const k={text:x};let E;if(o&&!o.submitted_at?(await Re(o.id,k),E=await Qe(o.id)):(E=await Be(m.id,k),E.error||(E=await Qe(E.data.id))),E.error)throw E.error;r({title:"ส่งงานสำเร็จ! 🎉",description:"งานของคุณได้รับการส่งเรียบร้อยแล้ว"}),a==null||a(E.data),I("view"),w()}catch(k){console.error("Error submitting assignment:",k),r({title:"ไม่สามารถส่งงานได้",description:k.message,variant:"destructive"})}finally{C(!1)}}},R=(m==null?void 0:m.due_date)&&new Date>new Date(m.due_date),O=q==="submit"||q==="edit",V=(o==null?void 0:o.submitted_at)||l(o)==="submitted"||l(o)==="graded";return n?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-700",children:"กำลังโหลดงานมอบหมาย..."})]})}):m?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:m.title}),e.jsx("p",{className:"text-gray-800",children:m.description})]}),e.jsxs("div",{className:"flex items-center space-x-2 ml-4",children:[V&&e.jsxs("div",{className:"flex items-center space-x-1 text-green-400 text-sm",children:[e.jsx(_s,{className:"w-4 h-4"}),e.jsx("span",{children:"ส่งแล้ว"})]}),R&&!V&&e.jsxs("div",{className:"flex items-center space-x-1 text-red-400 text-sm",children:[e.jsx(Fe,{className:"w-4 h-4"}),e.jsx("span",{children:"เกินกำหนด"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 p-4 bg-white border border-gray-300/30 rounded-lg",children:[m.due_date&&e.jsxs("div",{className:"flex items-center space-x-2 text-sm",children:[e.jsx(Oe,{className:"w-4 h-4 text-blue-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-700",children:"กำหนดส่ง"}),e.jsx("p",{className:"text-gray-900",children:new Date(m.due_date).toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 text-sm",children:[e.jsx(be,{className:"w-4 h-4 text-yellow-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-700",children:"คะแนนเต็ม"}),e.jsxs("p",{className:"text-gray-900",children:[m.max_score||100," คะแนน"]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 text-sm",children:[e.jsx(ee,{className:"w-4 h-4 text-purple-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-700",children:"จำนวนไฟล์สูงสุด"}),e.jsxs("p",{className:"text-gray-900",children:[m.max_files||5," ไฟล์"]})]})]})]})]}),m.instructions&&e.jsxs("div",{className:"glass-effect p-4 rounded-lg",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900 mb-2",children:"คำแนะนำ"}),e.jsx("div",{className:"text-gray-800 whitespace-pre-wrap leading-relaxed",children:m.instructions})]}),j.length>0&&e.jsxs("div",{className:"glass-effect p-4 rounded-lg",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900 mb-3",children:"ประวัติการส่งงาน"}),e.jsx("div",{className:"space-y-2",children:j.map((k,E)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-white border border-gray-300/30 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-gray-800",children:"ส่งเมื่อ"}),e.jsx("span",{className:"ml-2 text-xs text-gray-700",children:k.submitted_at?new Date(k.submitted_at).toLocaleDateString("th-TH"):"ยังไม่ส่ง"})]}),e.jsxs("div",{className:`px-2 py-1 rounded text-xs ${l(k)==="submitted"?"bg-green-500/20 text-green-400":l(k)==="graded"?"bg-blue-500/20 text-blue-400":"bg-yellow-500/20 text-yellow-400"}`,children:[l(k)==="submitted"&&"ส่งแล้ว",l(k)==="graded"&&`ให้คะแนนแล้ว (${k.score}/${(m==null?void 0:m.max_score)||100})`,l(k)==="draft"&&"แบบร่าง"]})]}),e.jsx(_,{size:"sm",variant:"ghost",onClick:()=>{b(k),d(k.submission_text||""),D([]),I("view")},children:e.jsx(ie,{className:"w-4 h-4"})})]},k.id))})]}),e.jsx(se,{mode:"wait",children:e.jsxs(Q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"glass-effect rounded-lg overflow-hidden",children:[o&&e.jsx("div",{className:"border-b border-white/10 p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(_,{size:"sm",variant:q==="view"?"default":"ghost",onClick:()=>I("view"),children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"ดูงาน"]}),!V&&e.jsxs(_,{size:"sm",variant:q==="edit"?"default":"ghost",onClick:()=>I("edit"),children:[e.jsx(ks,{className:"w-4 h-4 mr-2"}),"แก้ไข"]})]})}),e.jsx("div",{className:"p-6",children:q==="view"?e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:"งานที่ส่ง"}),(o==null?void 0:o.submission_text)&&e.jsxs("div",{children:[e.jsx("h5",{className:"text-sm font-medium text-gray-700 mb-2",children:"ข้อความ"}),e.jsx("div",{className:"p-4 bg-white border border-gray-300/30 rounded-lg text-gray-900 whitespace-pre-wrap",children:o.submission_text})]}),(o==null?void 0:o.feedback)&&e.jsxs("div",{children:[e.jsx("h5",{className:"text-sm font-medium text-gray-700 mb-2",children:"ความคิดเห็นจากอาจารย์"}),e.jsx("div",{className:"p-4 bg-blue-500/10 border border-blue-500/20 rounded-lg text-blue-800",children:o.feedback})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:o?"แก้ไขงาน":"ส่งงานมอบหมาย"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ข้อความ/คำตอบ"}),e.jsx("textarea",{value:x,onChange:k=>d(k.target.value),disabled:!O,rows:8,className:"w-full p-3 bg-white border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:outline-none resize-none",placeholder:"เขียนคำตอบหรือคำอธิบายงานของคุณที่นี่..."})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"หมายเหตุ: การอัปโหลดไฟล์จะเพิ่มเติมในเวอร์ชันถัดไป ตอนนี้ใช้ข้อความเท่านั้น"}),O&&e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-white/10",children:[e.jsx("div",{className:"text-xs text-gray-500",children:R&&e.jsxs("div",{className:"flex items-center space-x-1 text-amber-400",children:[e.jsx(Fe,{className:"w-3 h-3"}),e.jsx("span",{children:"การส่งงานหลังกำหนดอาจมีผลต่อคะแนน"})]})}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(_,{variant:"outline",onClick:T,disabled:$||F,children:$?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2"}),"กำลังบันทึก..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"บันทึกแบบร่าง"]})}),e.jsx(_,{onClick:U,disabled:$||F,className:"bg-green-500 hover:bg-green-600",children:F?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2"}),"กำลังส่ง..."]}):e.jsxs(e.Fragment,{children:[e.jsx(He,{className:"w-4 h-4 mr-2"}),"ส่งงาน"]})})]})]})]})})]},q)})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ee,{className:"w-16 h-16 text-gray-700 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ไม่พบงานมอบหมาย"}),e.jsx("p",{className:"text-gray-700",children:"ไม่สามารถโหลดข้อมูลงานมอบหมายได้"})]})},Ct=({isOpen:s,onClose:t,contentId:a,courseId:i})=>{const{toast:r}=X(),[l,n]=f.useState({title:"",description:"",time_limit:30,passing_score:70,questions:[{id:1,question:"",type:"multiple_choice",options:["","","",""],correct_answer:0}]}),g=()=>{const o={id:Date.now(),question:"",type:"multiple_choice",options:["","","",""],correct_answer:0};n(b=>({...b,questions:[...b.questions,o]}))},m=o=>{n(b=>({...b,questions:b.questions.filter(x=>x.id!==o)}))},v=(o,b,x)=>{n(d=>({...d,questions:d.questions.map(h=>h.id===o?{...h,[b]:x}:h)}))},j=(o,b,x)=>{n(d=>({...d,questions:d.questions.map(h=>h.id===o?{...h,options:h.options.map((D,$)=>$===b?x:D)}:h)}))},c=async()=>{try{if(!l.title.trim()){r({title:"กรุณาใส่ชื่อแบบทดสอบ",variant:"destructive"});return}for(const x of l.questions){if(!x.question.trim()){r({title:"กรุณาใส่คำถาม",variant:"destructive"});return}if(x.options.some(d=>!d.trim())){r({title:"กรุณาใส่ตัวเลือกให้ครบ",variant:"destructive"});return}}const{data:o,error:b}=await yt(a,i,l);if(b)throw b;r({title:"บันทึกแบบทดสอบสำเร็จ",description:`แบบทดสอบ "${l.title}" ถูกสร้างแล้ว`}),t()}catch(o){console.error("Error saving quiz:",o),r({title:"เกิดข้อผิดพลาดในการบันทึก",description:o.message||"ไม่สามารถบันทึกแบบทดสอบได้",variant:"destructive"})}};return s?e.jsx(Q.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",onClick:t,children:e.jsxs(Q.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden",onClick:o=>o.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"ตั้งค่าแบบทดสอบ"}),e.jsx(_,{variant:"ghost",size:"sm",onClick:t,children:e.jsx(we,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-140px)]",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"ชื่อแบบทดสอบ"}),e.jsx("input",{type:"text",value:l.title,onChange:o=>n(b=>({...b,title:o.target.value})),className:"w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"ใส่ชื่อแบบทดสอบ"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"เวลาทำ (นาที)"}),e.jsx("input",{type:"number",value:l.time_limit,onChange:o=>n(b=>({...b,time_limit:parseInt(o.target.value)})),className:"w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:"1"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"คำอธิบาย"}),e.jsx("textarea",{value:l.description,onChange:o=>n(b=>({...b,description:o.target.value})),className:"w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",rows:"3",placeholder:"คำอธิบายเกี่ยวกับแบบทดสอบ"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"คะแนนขั้นต่ำที่ผ่าน (%)"}),e.jsx("input",{type:"number",value:l.passing_score,onChange:o=>n(b=>({...b,passing_score:parseInt(o.target.value)})),className:"w-32 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:"0",max:"100"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"คำถาม"}),e.jsxs(_,{onClick:g,size:"sm",children:[e.jsx(ke,{className:"w-4 h-4 mr-2"}),"เพิ่มคำถาม"]})]}),e.jsx("div",{className:"space-y-6",children:l.questions.map((o,b)=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h4",{className:"font-medium",children:["คำถามที่ ",b+1]}),l.questions.length>1&&e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>m(o.id),className:"text-red-600 hover:text-red-700",children:e.jsx(Te,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"คำถาม"}),e.jsx("textarea",{value:o.question,onChange:x=>v(o.id,"question",x.target.value),className:"w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",rows:"2",placeholder:"ใส่คำถาม"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"ตัวเลือก"}),e.jsx("div",{className:"space-y-2",children:o.options.map((x,d)=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"radio",name:`correct-${o.id}`,checked:o.correct_answer===d,onChange:()=>v(o.id,"correct_answer",d),className:"text-blue-600"}),e.jsx("input",{type:"text",value:x,onChange:h=>j(o.id,d,h.target.value),className:"flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:`ตัวเลือกที่ ${d+1}`})]},d))}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"เลือกวงกลมเพื่อกำหนดคำตอบที่ถูกต้อง"})]})]})]},o.id))})]})]})}),e.jsxs("div",{className:"flex items-center justify-end space-x-3 p-6 border-t",children:[e.jsx(_,{variant:"outline",onClick:t,children:"ยกเลิก"}),e.jsxs(_,{onClick:c,children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"บันทึกแบบทดสอบ"]})]})]})}):null},St=({isOpen:s,onClose:t,contentId:a,courseId:i})=>{const{toast:r}=X(),[l,n]=f.useState({title:"",description:"",instructions:"",due_date:"",max_score:100,submission_type:"file",allowed_file_types:[".pdf",".doc",".docx"],max_file_size:10,allow_late_submission:!0,late_penalty:10}),g=[{value:"file",label:"อัพโหลดไฟล์"},{value:"text",label:"ข้อความ"},{value:"url",label:"ลิงก์"},{value:"both",label:"ไฟล์และข้อความ"}],m=[".pdf",".doc",".docx",".txt",".rtf",".jpg",".jpeg",".png",".gif",".zip",".rar",".7z",".ppt",".pptx",".xls",".xlsx"],v=c=>{n(o=>({...o,allowed_file_types:o.allowed_file_types.includes(c)?o.allowed_file_types.filter(b=>b!==c):[...o.allowed_file_types,c]}))},j=async()=>{try{if(!l.title.trim()){r({title:"กรุณาใส่ชื่องานมอบหมาย",variant:"destructive"});return}if(!l.description.trim()){r({title:"กรุณาใส่คำอธิบายงาน",variant:"destructive"});return}if(!l.due_date){r({title:"กรุณากำหนดวันที่ส่งงาน",variant:"destructive"});return}if(new Date(l.due_date)<=new Date){r({title:"วันที่ส่งงานต้องเป็นอนาคต",variant:"destructive"});return}const{data:b,error:x}=await As(a,i,l);if(x)throw x;r({title:"บันทึกงานมอบหมายสำเร็จ",description:`งาน "${l.title}" ถูกสร้างแล้ว`}),t()}catch(c){console.error("Error saving assignment:",c),r({title:"เกิดข้อผิดพลาดในการบันทึก",description:c.message||"ไม่สามารถบันทึกงานมอบหมายได้",variant:"destructive"})}};return s?e.jsx(Q.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",onClick:t,children:e.jsxs(Q.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"ตั้งค่างานมอบหมาย"}),e.jsx(_,{variant:"ghost",size:"sm",onClick:t,children:e.jsx(we,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-140px)]",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"ชื่องานมอบหมาย"}),e.jsx("input",{type:"text",value:l.title,onChange:c=>n(o=>({...o,title:c.target.value})),className:"w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"ใส่ชื่องานมอบหมาย"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"วันที่ส่งงาน"}),e.jsx("input",{type:"datetime-local",value:l.due_date,onChange:c=>n(o=>({...o,due_date:c.target.value})),className:"w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"คะแนนเต็ม"}),e.jsx("input",{type:"number",value:l.max_score,onChange:c=>n(o=>({...o,max_score:parseInt(c.target.value)})),className:"w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:"1"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"คำอธิบายงาน"}),e.jsx("textarea",{value:l.description,onChange:c=>n(o=>({...o,description:c.target.value})),className:"w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",rows:"3",placeholder:"อธิบายงานที่มอบหมาย"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"คำแนะนำการทำงาน"}),e.jsx("textarea",{value:l.instructions,onChange:c=>n(o=>({...o,instructions:c.target.value})),className:"w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",rows:"4",placeholder:"ใส่คำแนะนำและขั้นตอนการทำงาน"})]}),e.jsxs("div",{className:"border-t pt-6",children:[e.jsx("h3",{className:"text-lg font-medium mb-4",children:"การส่งงาน"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"ประเภทการส่งงาน"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:g.map(c=>e.jsxs("label",{className:"flex items-center space-x-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50",children:[e.jsx("input",{type:"radio",name:"submission_type",value:c.value,checked:l.submission_type===c.value,onChange:o=>n(b=>({...b,submission_type:o.target.value})),className:"text-blue-600"}),e.jsx("span",{className:"text-sm",children:c.label})]},c.value))})]}),(l.submission_type==="file"||l.submission_type==="both")&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"ประเภทไฟล์ที่อนุญาต"}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2",children:m.map(c=>e.jsxs("label",{className:"flex items-center space-x-1 text-xs",children:[e.jsx("input",{type:"checkbox",checked:l.allowed_file_types.includes(c),onChange:()=>v(c),className:"text-blue-600"}),e.jsx("span",{children:c})]},c))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"ขนาดไฟล์สูงสุด (MB)"}),e.jsx("input",{type:"number",value:l.max_file_size,onChange:c=>n(o=>({...o,max_file_size:parseInt(c.target.value)})),className:"w-32 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:"1",max:"100"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:l.allow_late_submission,onChange:c=>n(o=>({...o,allow_late_submission:c.target.checked})),className:"text-blue-600"}),e.jsx("span",{className:"text-sm font-medium",children:"อนุญาตให้ส่งงานช้า"})]}),l.allow_late_submission&&e.jsxs("div",{className:"ml-6",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"หักคะแนนการส่งช้า (%)"}),e.jsx("input",{type:"number",value:l.late_penalty,onChange:c=>n(o=>({...o,late_penalty:parseInt(c.target.value)})),className:"w-32 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:"0",max:"100"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"คะแนนที่จะหักต่อวันที่ส่งช้า"})]})]})]})]})]})}),e.jsxs("div",{className:"flex items-center justify-end space-x-3 p-6 border-t",children:[e.jsx(_,{variant:"outline",onClick:t,children:"ยกเลิก"}),e.jsxs(_,{onClick:j,children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"บันทึกงานมอบหมาย"]})]})]})}):null},Et=async(s,t="video")=>{try{const{data:{user:a},error:i}=await y.auth.getUser();if(i||!a)throw new Error("User not authenticated");const{data:r,error:l}=await y.from("course_content").select("course_id").eq("id",s).single();if(l)throw l;if(!r)throw new Error("Content not found");let n=null,g=null;try{const m=await y.from("user_progress").upsert([{user_id:a.id,course_id:r.course_id,content_id:s,completed_at:new Date().toISOString(),is_completed:!0,completion_percentage:100,last_accessed_at:new Date().toISOString()}],{onConflict:"user_id,course_id,content_id"}).select().single();n=m.data,g=m.error}catch(m){console.log("Falling back to basic user_progress structure:",m);const v=await y.from("user_progress").upsert([{user_id:a.id,course_id:r.course_id,content_id:s,completed_at:new Date().toISOString(),time_spent_minutes:0}],{onConflict:"user_id,course_id,content_id"}).select().single();n=v.data,g=v.error}if(g)throw g;return{data:n,error:null}}catch(a){return console.error("Error marking content complete:",a),{data:null,error:a}}},ue=async s=>{try{const{data:{user:t},error:a}=await y.auth.getUser();if(a||!t)return{data:null,error:null};const{data:i,error:r}=await y.from("enrollments").select("id, progress_percentage, completed_at, is_active").eq("user_id",t.id).eq("course_id",s).maybeSingle();if(r)throw r;if(!i)return{data:{enrolled:!1},error:null};const{data:l,error:n}=await y.from("course_content").select("id, title, content_type, order_index").eq("course_id",s).order("order_index");if(n)throw n;const g=l.map(A=>A.id),{data:m,error:v}=await y.from("user_progress").select("content_id, completed_at, is_completed, completion_percentage").eq("user_id",t.id).eq("course_id",s).in("content_id",g);if(v)throw v;const{data:j,error:c}=await y.from("quiz_attempts").select("quiz_id, is_passed, completed_at").eq("user_id",t.id);c&&console.warn("Quiz attempts table not available:",c);const{data:o,error:b}=await y.from("assignment_submissions").select("assignment_id, submitted_at, score, graded_at").eq("user_id",t.id);b&&console.warn("Assignment submissions table not available:",b);const x=new Map((m||[]).map(A=>[A.content_id,A])),d=l.map(A=>{const F=x.get(A.id);let C=!1;if(F&&F.is_completed)C=!0;else switch(A.content_type){case"video":C=!!(F!=null&&F.is_completed);break;case"quiz":C=(j||[]).some(q=>q.is_passed);break;case"assignment":C=(o||[]).some(q=>q.submitted_at!==null);break;default:C=!!(F!=null&&F.is_completed)}return{...A,is_completed:C,completion_percentage:(F==null?void 0:F.completion_percentage)||(C?100:0),completed_at:F==null?void 0:F.completed_at}}),h=d.filter(A=>A.is_completed).length,D=d.length,$=D>0?Math.round(h/D*100):0;return{data:{enrolled:!0,enrollment:i,content_progress:d,completed_count:h,total_count:D,progress_percentage:$,calculated_progress:$},error:null}}catch(t){return console.error("Error fetching course progress:",t),{data:null,error:t}}};async function Ie(s,t){var a,i;try{console.log("🔒 Checking course content accessibility:",{courseId:s,userId:t});const{data:r,error:l}=await y.from("course_content").select(`
        id,
        title,
        order_index,
        content_type,
        lock_enabled,
        requires_previous_completion,
        lock_message
      `).eq("course_id",s).order("order_index",{ascending:!0});if(l)return console.error("Error fetching course contents:",l),{error:l};const{data:n}=await y.from("enrollments").select("id").eq("user_id",t).eq("course_id",s).single();if(!n){console.log("❌ User not enrolled in course");const c={};return r.forEach((o,b)=>{c[o.id]={isAccessible:b===0||o.content_type==="video",reason:b===0?"First content available":o.content_type==="video"?"Video content freely accessible":"User not enrolled"}}),{accessibility:c}}let g=null,m=null;try{const c=await y.from("user_progress").select("content_id, is_completed, completed_at").eq("user_id",t);g=c.data,m=c.error}catch(c){console.log("Falling back to completed_at only check for all progress:",c);const o=await y.from("user_progress").select("content_id, completed_at").eq("user_id",t);g=((a=o.data)==null?void 0:a.map(b=>({content_id:b.content_id,is_completed:!!b.completed_at,completed_at:b.completed_at})))||[],m=o.error}console.log("📊 All progress records:",{progressRecords:g,progressError:m});const v=new Set(((i=g==null?void 0:g.filter(c=>c.is_completed))==null?void 0:i.map(c=>c.content_id))||[]);console.log("✅ Completed content IDs:",Array.from(v));const j={};for(let c=0;c<r.length;c++){const o=r[c];if(o.content_type==="video"){j[o.id]={isAccessible:!0,reason:"Video content freely accessible"};continue}if(!o.lock_enabled||!o.requires_previous_completion){j[o.id]={isAccessible:!0,reason:"Content lock disabled"};continue}if(c===0){j[o.id]={isAccessible:!0,reason:"First content"};continue}const b=r[c-1];b&&v.has(b.id)?j[o.id]={isAccessible:!0,reason:"Previous content completed"}:j[o.id]={isAccessible:!1,reason:o.lock_message||"คุณต้องทำเนื้อหาก่อนหน้าให้เสร็จก่อน",blockingContent:b}}return console.log("🔒 Content accessibility results:",j),{accessibility:j}}catch(r){return console.error("Error checking course content accessibility:",r),{error:r}}}const xe=({contentId:s,className:t=""})=>{const{toast:a}=X(),[i,r]=f.useState([]),[l,n]=f.useState(!0),[g,m]=f.useState(null),v=x=>{const d=x==null?void 0:x.toLowerCase();return["jpg","jpeg","png","gif","webp","svg"].includes(d)?e.jsx(Ss,{className:"w-5 h-5 text-blue-500"}):["mp4","avi","mov","wmv","flv"].includes(d)?e.jsx(Es,{className:"w-5 h-5 text-purple-500"}):["zip","rar","7z","tar","gz"].includes(d)?e.jsx(zs,{className:"w-5 h-5 text-orange-500"}):["pdf"].includes(d)?e.jsx(ee,{className:"w-5 h-5 text-red-500"}):["doc","docx"].includes(d)?e.jsx(ee,{className:"w-5 h-5 text-blue-600"}):["ppt","pptx"].includes(d)?e.jsx(ee,{className:"w-5 h-5 text-orange-600"}):["xls","xlsx"].includes(d)?e.jsx(ee,{className:"w-5 h-5 text-green-600"}):e.jsx(Ps,{className:"w-5 h-5 text-slate-500"})},j=x=>{if(x===0)return"0 Bytes";const d=1024,h=["Bytes","KB","MB","GB"],D=Math.floor(Math.log(x)/Math.log(d));return parseFloat((x/Math.pow(d,D)).toFixed(2))+" "+h[D]};f.useEffect(()=>{(async()=>{if(s){n(!0);try{console.log("Loading attachments for content:",s);const{data:d,error:h}=await Us(s);if(h){console.error("Error loading attachments:",h),a({title:"ไม่สามารถโหลดไฟล์แนบได้",description:"มีข้อผิดพลาดในการโหลดไฟล์แนบ",variant:"destructive"});return}console.log("Loaded attachments:",d),r(d||[])}catch(d){console.error("Error in loadAttachments:",d),a({title:"เกิดข้อผิดพลาด",description:"ไม่สามารถโหลดไฟล์แนบได้",variant:"destructive"})}finally{n(!1)}}})()},[s,a]);const c=async x=>{m(x.id);try{if(console.log("Downloading file:",x),x.file_url){const d=document.createElement("a");d.href=x.file_url,d.download=x.original_filename||x.filename,d.target="_blank",document.body.appendChild(d),d.click(),document.body.removeChild(d),a({title:"เริ่มดาวน์โหลด",description:`กำลังดาวน์โหลดไฟล์ ${x.original_filename||x.filename}`})}else throw new Error("ไม่พบ URL ของไฟล์")}catch(d){console.error("Download error:",d),a({title:"ไม่สามารถดาวน์โหลดได้",description:d.message||"เกิดข้อผิดพลาดในการดาวน์โหลดไฟล์",variant:"destructive"})}finally{m(null)}},o=x=>{x.file_url&&window.open(x.file_url,"_blank")},b=(x,d)=>{const h=["application/pdf","image/jpeg","image/png","image/gif","image/webp","text/plain"],D=["pdf","jpg","jpeg","png","gif","webp","txt"];return h.includes(x)||D.includes(d==null?void 0:d.toLowerCase())};return l?e.jsxs("div",{className:`flex items-center justify-center p-8 ${t}`,children:[e.jsx(ve,{className:"w-6 h-6 animate-spin text-gray-400"}),e.jsx("span",{className:"ml-2 text-sm text-gray-500",children:"กำลังโหลดไฟล์แนบ..."})]}):!i||i.length===0?null:e.jsxs("div",{className:`bg-white rounded-lg border border-gray-200 p-6 ${t}`,children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(Cs,{className:"w-5 h-5 text-orange-500"}),e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["ไฟล์แนบเอกสาร (",i.length,")"]})]}),e.jsx("div",{className:"space-y-3",children:i.map(x=>e.jsxs(Q.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-100 hover:bg-gray-100 transition-colors",children:[e.jsxs("div",{className:"flex items-center space-x-3 flex-1 min-w-0",children:[e.jsx("div",{className:"flex-shrink-0",children:v(x.file_extension)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:x.original_filename||x.filename}),e.jsxs("div",{className:"flex items-center space-x-4 text-xs text-gray-500",children:[e.jsx("span",{children:j(x.file_size)}),x.file_extension&&e.jsx("span",{className:"uppercase",children:x.file_extension}),x.download_count>0&&e.jsxs("span",{children:["ดาวน์โหลด ",x.download_count," ครั้ง"]})]}),x.description&&e.jsx("p",{className:"text-xs text-gray-600 mt-1 line-clamp-2",children:x.description})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[b(x.mime_type,x.file_extension)&&e.jsx(_,{size:"sm",variant:"outline",onClick:()=>o(x),className:"text-blue-600 border-blue-200 hover:bg-blue-50",title:"ดูตัวอย่าง",children:e.jsx(ie,{className:"w-4 h-4"})}),e.jsx(_,{size:"sm",onClick:()=>c(x),disabled:g===x.id,className:"bg-green-600 hover:bg-green-700 text-white",title:"ดาวน์โหลด",children:g===x.id?e.jsx(ve,{className:"w-4 h-4 animate-spin"}):e.jsx(pe,{className:"w-4 h-4"})})]})]},x.id))}),e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200",children:e.jsx("p",{className:"text-xs text-gray-500 text-center",children:"💡 คลิกปุ่มดาวน์โหลดเพื่อบันทึกไฟล์ลงเครื่องของคุณ"})})]})},zt=()=>{const{courseId:s}=We(),{user:t,isAdmin:a}=Ge(),{toast:i}=X(),[r,l]=f.useState(null),[n,g]=f.useState(!0),[m,v]=f.useState({isEnrolled:!1}),[j,c]=f.useState(null),[o,b]=f.useState(null),[x,d]=f.useState({}),[h,D]=f.useState(null),[$,A]=f.useState(null),[F,C]=f.useState(!1),[q,I]=f.useState(null),[w,T]=f.useState(!1),[U,R]=f.useState(!1),[O,V]=f.useState(!1),k=f.useCallback(async()=>{if(t)try{console.log("Checking enrollment for user:",t==null?void 0:t.id,"course:",s);const{isEnrolled:u,status:N,error:L}=await Ze(s);if(console.log("Enrollment result:",{isEnrolled:u,status:N,error:L}),L){console.error("Enrollment check error:",L),i({title:"ไม่สามารถตรวจสอบการลงทะเบียนได้",description:L.message,variant:"destructive"}),v({isEnrolled:!1,status:null});return}if(v({isEnrolled:u,status:N}),N!=null&&N.enrollment_id?(b(N.enrollment_id),console.log("Enrollment ID set:",N.enrollment_id)):N!=null&&N.id&&(b(N.id),console.log("Enrollment ID set from status.id:",N.id)),u){console.log("User is enrolled, loading progress...");const{data:M}=await ue(s);console.log("Course progress data:",M),c(M);const{data:W}=await qs(s);if(W&&W.length>0){console.log("Loading course content",W.length,"items");const{accessibility:Z,error:Y}=await Ie(s,t.id);Y?console.error("Error loading content accessibility:",Y):(console.log("🔒 Content accessibility loaded:",Z),d(Z))}}else console.log("User is not enrolled")}catch(u){console.error("Error in checkEnrollmentAndProgress:",u),i({title:"เกิดข้อผิดพลาดในการตรวจสอบ",description:u.message,variant:"destructive"})}},[t,s,i]),E=f.useCallback(async()=>{g(!0),console.log("CourseLearningPage: Loading course with ID:",s);const u=setTimeout(()=>{console.error("CourseLearningPage: Course loading timeout after 10 seconds"),g(!1),i({title:"การโหลดใช้เวลานานเกินไป",description:"กรุณาลองรีเฟรชหน้าใหม่หรือตรวจสอบการเชื่อมต่ออินเทอร์เน็ต",variant:"destructive"})},1e4);try{const{data:N,error:L}=await Ye(s);clearTimeout(u),console.log("CourseLearningPage: Course data received:",N,"Error:",L),L?(console.error("CourseLearningPage: Course loading error:",L),i({title:"ข้อผิดพลาดในการโหลดข้อมูล",description:L.message,variant:"destructive"})):N?(l(N),console.log("CourseLearningPage: Course set successfully:",N),N!=null&&N.content&&N.content.length>0?(console.log("CourseLearningPage: Auto-selecting first content:",N.content[0]),D(N.content[0])):(console.log("CourseLearningPage: No content found in course"),console.log("CourseLearningPage: Course data structure:",N),console.log("CourseLearningPage: Content array:",N==null?void 0:N.content))):(console.log("CourseLearningPage: No course data returned"),i({title:"ไม่พบข้อมูลคอร์ส",description:"คอร์สนี้อาจไม่มีอยู่ในระบบ",variant:"destructive"}))}catch(N){clearTimeout(u),console.error("CourseLearningPage: Unexpected error loading course:",N),i({title:"เกิดข้อผิดพลาดที่ไม่คาดคิด",description:N.message,variant:"destructive"})}finally{g(!1)}},[s,i]);f.useEffect(()=>{E()},[s]),f.useEffect(()=>{t&&r&&(console.log("useEffect: Checking enrollment and progress",{user:t==null?void 0:t.id,courseId:r==null?void 0:r.id}),k())},[t,r==null?void 0:r.id]);const S=async u=>{const N=r.content.findIndex(L=>L.id===u.id);if(p(u,N)){const L=x[u.id],M=(L==null?void 0:L.reason)||"กรุณาผ่านเนื้อหาก่อนหน้านี้ก่อน",W=L==null?void 0:L.blockingContent;i({title:"เนื้อหายังไม่เปิดให้เรียน",description:W?`กรุณาผ่าน "${W.title}" ก่อน`:M,variant:"destructive"});return}if(D(u),C(!1),A(null),T(!1),I(null),u.content_type==="quiz"){const{data:L}=await ze(u.id);L&&(A(L),C(!0))}if(u.content_type==="assignment")try{const{data:L,error:M}=await Ce(u.id);L&&!M&&(I(L),T(!0))}catch{console.log(`ไม่พบงานมอบหมายสำหรับเนื้อหา: ${u.title}`)}},B=u=>{i({title:u.is_passed?"ยินดีด้วย! ผ่านแบบทดสอบ 🎉":"ไม่ผ่านแบบทดสอบ",description:`คะแนน: ${u.score}%`,variant:u.is_passed?"default":"destructive"}),t&&r&&(async()=>{try{const{data:L}=await ue(s);c(L)}catch(L){console.error("Error refreshing progress:",L)}})(),C(!1)},P=u=>{i({title:"ส่งงานสำเร็จ! 🎉",description:"งานของคุณได้รับการส่งเรียบร้อยแล้ว"}),t&&r&&(async()=>{try{const{data:L}=await ue(s);c(L)}catch(L){console.error("Error refreshing progress:",L)}})(),T(!1)},H=async(u,N="general")=>{var L;try{const M=(L=r==null?void 0:r.content)==null?void 0:L.find(Z=>Z.id===u),W=(M==null?void 0:M.content_type)==="video"?"วิดีโอ":(M==null?void 0:M.content_type)==="text"?"เนื้อหา":(M==null?void 0:M.content_type)==="quiz"?"แบบทดสอบ":(M==null?void 0:M.content_type)==="assignment"?"งาน":"เนื้อหา";if(i({title:`${W}เสร็จสิ้น! 🎉`,description:`คุณได้ทำ${W}นี้เสร็จเรียบร้อยแล้ว`}),t&&u){const{data:Z,error:Y}=await Et(u,N);Y?console.error("Error marking content as completed:",Y):console.log("Content marked as completed:",Z)}t&&r&&(async()=>{try{const{data:Y}=await ue(s);c(Y);const{accessibility:de,error:ts}=await Ie(s,t.id);ts||d(de)}catch(Y){console.error("Error refreshing progress:",Y)}})()}catch(M){console.error("Error in handleContentComplete:",M),i({title:"เกิดข้อผิดพลาด",description:"ไม่สามารถบันทึกความคืบหน้าได้",variant:"destructive"})}},G=u=>H(u,"video"),z=u=>{if(console.log("🎯 getContentProgress called for:",u.content_type,u.id),console.log("📋 Current courseProgress:",j),!(j!=null&&j.content_progress))return console.log("📋 No courseProgress.content_progress found"),0;const N=j.content_progress.find(M=>M.id===u.id),L=N!=null&&N.is_completed?100:0;return console.log("📄 Content progress:",L),L},p=(u,N)=>{if(x.hasOwnProperty(u.id)){const W=x[u.id];return console.log("🔒 Content lock check:",{contentId:u.id,accessInfo:W,isAccessible:W==null?void 0:W.isAccessible}),!(W!=null&&W.isAccessible)}if(N===0)return!1;const L=r.content[N-1];return z(L)<100};return n?e.jsx("div",{className:"container mx-auto px-4 py-12",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-[#667eea] mx-auto mb-4"}),e.jsx("p",{className:"text-teal-700",children:"กำลังโหลดเนื้อหาคอร์ส..."}),e.jsxs("p",{className:"text-teal-700 text-sm mt-2",children:["Course ID: ",s]})]})}):r?m.isEnrolled?e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-[#0a192f] to-[#172a46]",children:[e.jsx(Pe,{children:e.jsxs("title",{children:[r.title," - เรียน | Login Learning"]})}),e.jsx("div",{className:"bg-black/20 backdrop-blur-sm border-b border-white/10",children:e.jsx("div",{className:"container mx-auto px-4 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(te,{to:`/courses/${s}`,children:e.jsx(_,{variant:"ghost",size:"icon",className:"text-teal-900",children:e.jsx(ce,{className:"w-5 h-5"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-teal-900",children:r.title}),j&&e.jsxs("div",{className:"flex items-center space-x-4 text-sm text-teal-800",children:[e.jsxs("span",{children:["ความคืบหน้า: ",j.progress_percentage,"%"]}),e.jsx("span",{children:"•"}),e.jsxs("span",{children:[j.completed_count,"/",j.total_count," เนื้อหา"]})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 text-teal-800",children:[e.jsx(Le,{className:"w-4 h-4"}),e.jsxs("span",{children:[r.enrollment_count||0," คน"]})]})]})})}),e.jsx("div",{className:"container mx-auto px-4 py-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl border border-gray-100 p-6 sticky top-24",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-indigo-600 p-3 rounded-xl mr-4",children:e.jsx(K,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-800",children:"เนื้อหาคอร์ส"}),e.jsx("p",{className:"text-sm text-gray-600",children:"เลือกเนื้อหาที่ต้องการเรียน"})]})]}),j&&e.jsxs("div",{className:"mb-6 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-200",children:[e.jsxs("div",{className:"flex justify-between text-sm font-semibold text-gray-700 mb-3",children:[e.jsx("span",{children:"🎯 ความคืบหน้าทั้งหมด"}),e.jsxs("span",{className:"text-indigo-600",children:[j.progress_percentage,"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3 shadow-inner",children:e.jsx("div",{className:"bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 h-3 rounded-full transition-all duration-500 shadow-sm",style:{width:`${j.progress_percentage}%`}})}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-600 mt-2",children:[e.jsx("span",{children:"เริ่มต้น"}),e.jsx("span",{children:"เสร็จสิ้น"})]})]}),e.jsx("div",{className:"space-y-3",children:r!=null&&r.content&&r.content.length>0?r.content.map((u,N)=>{var Z,Y;const L=z(u),M=p(u,N),W=(h==null?void 0:h.id)===u.id;return e.jsx(Q.div,{whileHover:M?{}:{scale:1.02,y:-2},className:`group relative overflow-hidden rounded-xl border-2 transition-all duration-300 cursor-pointer ${W?"border-blue-500 bg-blue-50 shadow-md":M?"border-gray-200 bg-gray-50 opacity-60":"border-gray-200 bg-white hover:border-blue-300 hover:shadow-md"}`,onClick:()=>!M&&S(u),children:e.jsx("div",{className:"relative p-4",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ${M?"bg-gray-300":L>=100?"bg-gradient-to-r from-green-500 to-emerald-500":W?"bg-gradient-to-r from-blue-500 to-indigo-500":"bg-gradient-to-r from-gray-400 to-gray-500"}`,children:M?e.jsx(oe,{className:"w-5 h-5 text-white"}):L>=100?e.jsx(J,{className:"w-5 h-5 text-white"}):u.content_type==="video"?e.jsx(Me,{className:"w-5 h-5 text-white"}):u.content_type==="quiz"?e.jsx(me,{className:"w-5 h-5 text-white"}):u.content_type==="assignment"?e.jsx(K,{className:"w-5 h-5 text-white"}):e.jsx(ee,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:`text-sm font-bold mb-1 line-clamp-2 ${M?"text-gray-500":W?"text-blue-800":"text-gray-800"}`,children:u.title}),e.jsxs("div",{className:"flex items-center justify-between text-xs mb-2",children:[e.jsx("span",{className:`${M?"text-gray-400":"text-gray-600"}`,children:u.content_type==="video"?"📹 วิดีโอ":u.content_type==="quiz"?"📝 แบบทดสอบ":u.content_type==="assignment"?"📋 งานมอบหมาย":"📄 เอกสาร"}),u.duration_minutes&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(re,{className:"w-3 h-3"}),e.jsxs("span",{children:[u.duration_minutes," นาที"]})]})]}),M?e.jsxs("div",{className:"text-xs text-red-600 bg-red-50 border border-red-200 rounded-md p-2 mt-2",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(oe,{className:"w-3 h-3"}),e.jsx("span",{className:"font-medium",children:"เนื้อหาถูกล็อค"})]}),e.jsx("div",{className:"mt-1 text-gray-600",children:((Z=x[u.id])==null?void 0:Z.reason)||"กรุณาผ่านเนื้อหาก่อนหน้าก่อน"}),((Y=x[u.id])==null?void 0:Y.blockingContent)&&e.jsxs("div",{className:"mt-1 text-blue-600",children:['ต้องผ่าน: "',x[u.id].blockingContent.title,'"']})]}):e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:`h-2 rounded-full transition-all duration-300 ${L>=100?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-blue-500 to-indigo-500"}`,style:{width:`${Math.min(L,100)}%`}})})]})]})})},u.id)}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(ee,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"ยังไม่มีเนื้อหาในคอร์สนี้"})]})})]})}),e.jsx("div",{className:"lg:col-span-3",children:h?e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-indigo-600 p-6 text-white",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"bg-white/20 p-3 rounded-xl backdrop-blur-sm",children:[h.content_type==="video"&&e.jsx(Me,{className:"w-6 h-6 text-white"}),h.content_type==="text"&&e.jsx(ee,{className:"w-6 h-6 text-white"}),h.content_type==="quiz"&&e.jsx(me,{className:"w-6 h-6 text-white"}),h.content_type==="assignment"&&e.jsx(K,{className:"w-6 h-6 text-white"})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:h.title}),e.jsxs("div",{className:"flex items-center text-blue-100 mt-1",children:[e.jsx(re,{className:"w-4 h-4 mr-1"}),e.jsxs("span",{children:[h.duration_minutes||0," นาที"]})]})]})]})})}),e.jsxs("div",{className:"p-6",children:[h.content_type==="video"&&(h.content_url||h.video_url)&&e.jsxs("div",{children:[e.jsx(pt,{src:h.content_url||h.video_url,contentId:h.id,title:h.title,autoPlay:!1,onComplete:G}),e.jsxs("div",{className:"mt-6 border-t pt-6",children:[z(h)>=100?e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-lg",children:[e.jsx(J,{className:"w-5 h-5 mr-2"}),"วิดีโอนี้ดูเสร็จสิ้นแล้ว"]})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsxs("div",{className:"text-center p-4 border border-blue-200 rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-2",children:"ความคืบหน้าการดู"}),e.jsx("div",{className:"text-sm text-gray-600",children:"สามารถเข้าถึงเนื้อหาได้ทั้งหมด"})]})}),a&&e.jsxs("div",{className:"border-t pt-4 mt-4",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"การตั้งค่าสำหรับผู้ดูแล"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(_,{variant:"outline",size:"sm",className:"bg-red-500 text-white border-red-500 hover:bg-red-600 hover:border-red-600 font-medium",onClick:()=>{navigator.clipboard.writeText(`${window.location.origin}/admin/courses/${r.id}/content`),i({title:"คัดลอก link แล้ว",description:"ส่ง link นี้ให้ admin อื่นเพื่อจัดการเนื้อหา"})},children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"แก้ไขวิดีโอ"]}),e.jsxs(_,{variant:"outline",size:"sm",className:"bg-purple-500 text-white border-purple-500 hover:bg-purple-600 hover:border-purple-600 font-medium",onClick:()=>{navigator.clipboard.writeText(window.location.href),i({title:"คัดลอก link แล้ว",description:"แชร์ link นี้ให้นักเรียนเพื่อดูวิดีโอ"})},children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"แชร์วิดีโอ"]})]})]})]})]}),h.content_type==="text"&&e.jsxs("div",{children:[e.jsx("div",{className:"prose max-w-none mb-8",children:e.jsx("div",{dangerouslySetInnerHTML:{__html:h.content||"ไม่มีเนื้อหา"}})}),e.jsx(xe,{contentId:h.id,className:"mb-8"}),e.jsxs("div",{className:"border-t pt-6",children:[z(h)>=100?e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-lg",children:[e.jsx(J,{className:"w-5 h-5 mr-2"}),"เนื้อหานี้เสร็จสิ้นแล้ว"]})}):e.jsx("div",{className:"text-center",children:e.jsxs(_,{onClick:()=>H(h.id,"text"),className:"bg-green-600 hover:bg-green-700 text-white",size:"lg",children:[e.jsx(J,{className:"w-5 h-5 mr-2"}),"ผ่านเนื้อหานี้"]})}),a&&e.jsxs("div",{className:"border-t pt-4 mt-4",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"การตั้งค่าสำหรับผู้ดูแล"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(_,{variant:"outline",size:"sm",className:"bg-indigo-500 text-white border-indigo-500 hover:bg-indigo-600 hover:border-indigo-600 font-medium",onClick:()=>{navigator.clipboard.writeText(`${window.location.origin}/admin/courses/${r.id}/content`),i({title:"คัดลอก link แล้ว",description:"ส่ง link นี้ให้ admin อื่นเพื่อจัดการเนื้อหา"})},children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"แก้ไขเนื้อหา"]}),e.jsxs(_,{variant:"outline",size:"sm",className:"bg-purple-500 text-white border-purple-500 hover:bg-purple-600 hover:border-purple-600 font-medium",onClick:()=>{navigator.clipboard.writeText(window.location.href),i({title:"คัดลอก link แล้ว",description:"แชร์ link นี้ให้นักเรียนเพื่ออ่านเนื้อหา"})},children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"แชร์เนื้อหา"]})]})]})]})]}),h.content_type==="quiz"&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-center py-12",children:[e.jsx(me,{className:"w-16 h-16 text-blue-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"แบบทดสอบ"}),e.jsx("p",{className:"text-gray-600 mb-6",children:h.content||"คลิกปุ่มด้านล่างเพื่อเริ่มทำแบบทดสอบ"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(_,{className:"bg-blue-500 hover:bg-blue-600 text-white",onClick:async()=>{const{data:u}=await ze(h.id);u?(A(u),C(!0)):i({title:"ไม่พบแบบทดสอบ",description:"ไม่มีแบบทดสอบสำหรับเนื้อหานี้",variant:"destructive"})},children:[e.jsx(me,{className:"w-4 h-4 mr-2"}),"เริ่มทำแบบทดสอบ"]}),z(h)<100&&e.jsx("div",{children:e.jsxs(_,{variant:"outline",className:"bg-green-600 hover:bg-green-700 text-white border-green-600",onClick:()=>H(h.id,"quiz"),children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"ผ่านเนื้อหานี้"]})}),a&&e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"การตั้งค่าสำหรับผู้ดูแล"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(_,{variant:"outline",size:"sm",className:"bg-blue-500 text-white border-blue-500 hover:bg-blue-600 hover:border-blue-600 font-medium",onClick:()=>R(!0),children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"ตั้งค่าแบบทดสอบ"]}),e.jsxs(_,{variant:"outline",size:"sm",className:"bg-purple-500 text-white border-purple-500 hover:bg-purple-600 hover:border-purple-600 font-medium",onClick:()=>{navigator.clipboard.writeText(`${window.location.origin}/admin/courses/${r.id}/content`),i({title:"คัดลอก link แล้ว",description:"ส่ง link นี้ให้ admin อื่นเพื่อจัดการเนื้อหา"})},children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"แชร์การจัดการ"]})]})]})]})]}),e.jsx(xe,{contentId:h.id,className:"mt-8"})]}),h.content_type==="assignment"&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-center py-12",children:[e.jsx(K,{className:"w-16 h-16 text-green-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"งานมอบหมาย"}),e.jsx("p",{className:"text-gray-600 mb-6",children:h.content||"คลิกปุ่มด้านล่างเพื่อดูงานมอบหมาย"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(_,{className:"bg-green-500 hover:bg-green-600 text-white",onClick:async()=>{const{data:u}=await Ce(h.id);u?(I(u),T(!0)):i({title:"ไม่พบงานมอบหมาย",description:"ไม่มีงานมอบหมายสำหรับเนื้อหานี้",variant:"destructive"})},children:[e.jsx(K,{className:"w-4 h-4 mr-2"}),"ดูงานมอบหมาย"]}),z(h)<100&&e.jsx("div",{children:e.jsxs(_,{variant:"outline",className:"bg-green-600 hover:bg-green-700 text-white border-green-600",onClick:()=>H(h.id,"assignment"),children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"ผ่านเนื้อหานี้"]})}),a&&e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"การตั้งค่าสำหรับผู้ดูแล"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs(_,{variant:"outline",size:"sm",className:"bg-orange-500 text-white border-orange-500 hover:bg-orange-600 hover:border-orange-600 font-medium",onClick:()=>V(!0),children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"ตั้งค่างานมอบหมาย"]}),e.jsxs(_,{variant:"outline",size:"sm",className:"bg-green-500 text-white border-green-500 hover:bg-green-600 hover:border-green-600 font-medium",onClick:()=>{i({title:"เปิดการให้คะแนน",description:"ฟีเจอร์นี้จะพร้อมใช้งานเร็วๆ นี้"})},children:[e.jsx(Ls,{className:"w-4 h-4 mr-2"}),"ให้คะแนนงาน"]}),e.jsxs(_,{variant:"outline",size:"sm",className:"bg-purple-500 text-white border-purple-500 hover:bg-purple-600 hover:border-purple-600 font-medium",onClick:()=>{navigator.clipboard.writeText(`${window.location.origin}/admin/courses/${r.id}/content`),i({title:"คัดลอก link แล้ว",description:"ส่ง link นี้ให้ admin อื่นเพื่อจัดการเนื้อหา"})},children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"แชร์การจัดการ"]})]})]})]})]}),e.jsx(xe,{contentId:h.id,className:"mt-8"})]}),(h.content_type==="document"||h.content_type==="lesson")&&e.jsxs("div",{children:[h.content&&e.jsx("div",{className:"prose max-w-none mb-8",children:e.jsx("div",{dangerouslySetInnerHTML:{__html:h.content}})}),e.jsx(xe,{contentId:h.id,className:"mb-8"}),e.jsxs("div",{className:"border-t pt-6",children:[z(h)>=100?e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-lg",children:[e.jsx(J,{className:"w-5 h-5 mr-2"}),"เนื้อหานี้เสร็จสิ้นแล้ว"]})}):e.jsx("div",{className:"text-center",children:e.jsxs(_,{onClick:()=>H(h.id,h.content_type),className:"bg-green-600 hover:bg-green-700 text-white",size:"lg",children:[e.jsx(J,{className:"w-5 h-5 mr-2"}),"ผ่านเนื้อหานี้"]})}),a&&e.jsxs("div",{className:"border-t pt-4 mt-4",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"การตั้งค่าสำหรับผู้ดูแล"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(_,{variant:"outline",size:"sm",className:"bg-teal-500 text-white border-teal-500 hover:bg-teal-600 hover:border-teal-600 font-medium",onClick:()=>{navigator.clipboard.writeText(`${window.location.origin}/admin/courses/${r.id}/content`),i({title:"คัดลอก link แล้ว",description:"ส่ง link นี้ให้ admin อื่นเพื่อจัดการเนื้อหา"})},children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"แก้ไขเอกสาร"]}),e.jsxs(_,{variant:"outline",size:"sm",className:"bg-purple-500 text-white border-purple-500 hover:bg-purple-600 hover:border-purple-600 font-medium",onClick:()=>{navigator.clipboard.writeText(window.location.href),i({title:"คัดลอก link แล้ว",description:"แชร์ link นี้ให้นักเรียนเพื่ออ่านเอกสาร"})},children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"แชร์เอกสาร"]})]})]})]})]})]})]}):e.jsx("div",{className:"bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden",children:e.jsxs("div",{className:"p-12 text-center",children:[e.jsx(K,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"เลือกเนื้อหาที่ต้องการเรียน"}),e.jsx("p",{className:"text-gray-600",children:"กรุณาเลือกเนื้อหาจากรายการด้านซ้ายเพื่อเริ่มเรียน"})]})})})]})}),e.jsx(se,{children:F&&$&&e.jsx(Q.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",onClick:()=>C(!1),children:e.jsx(Q.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},className:"bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden",onClick:u=>u.stopPropagation(),children:e.jsx("div",{className:"p-6",children:e.jsx(Nt,{quiz:$,onComplete:B,onClose:()=>C(!1)})})})})}),e.jsx(se,{children:w&&q&&e.jsx(Q.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",onClick:()=>T(!1),children:e.jsx(Q.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},className:"bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden",onClick:u=>u.stopPropagation(),children:e.jsx("div",{className:"p-6",children:e.jsx(kt,{contentId:h==null?void 0:h.id,assignment:q,onComplete:P,onClose:()=>T(!1)})})})})}),e.jsx(Ct,{isOpen:U,onClose:()=>R(!1),contentId:h==null?void 0:h.id,courseId:s}),e.jsx(St,{isOpen:O,onClose:()=>V(!1),contentId:h==null?void 0:h.id,courseId:s})]}):e.jsx("div",{className:"container mx-auto px-4 py-12",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("h2",{className:"text-2xl font-bold text-teal-900 mb-2",children:"คุณยังไม่ได้ลงทะเบียนคอร์สนี้"}),e.jsx("p",{className:"text-teal-700 mb-4",children:"กรุณาลงทะเบียนก่อนเรียน"}),e.jsxs("div",{className:"text-teal-700 text-sm mb-4",children:[e.jsxs("p",{children:["Course: ",r==null?void 0:r.title]}),e.jsxs("p",{children:["User: ",t==null?void 0:t.email]}),e.jsxs("p",{children:["Enrollment Status: ",JSON.stringify(m)]})]}),e.jsx(te,{to:`/courses/${s}`,children:e.jsx(_,{children:"ไปหน้าลงทะเบียน"})})]})}):e.jsx("div",{className:"container mx-auto px-4 py-12",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("h2",{className:"text-2xl font-bold text-teal-900 mb-2",children:"ไม่พบข้อมูลคอร์ส"}),e.jsxs("p",{className:"text-teal-700 mb-4",children:["Course ID: ",s]}),e.jsxs("p",{className:"text-teal-700 text-sm mb-4",children:["Loading: ",n?"true":"false"]}),e.jsx(te,{to:"/courses",children:e.jsx(_,{variant:"outline",children:"กลับไปหน้าคอร์สทั้งหมด"})})]})})},At=Object.freeze(Object.defineProperty({__proto__:null,default:zt},Symbol.toStringTag,{value:"Module"}));export{$t as C,Dt as a,At as b};
