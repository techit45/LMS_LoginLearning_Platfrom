<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö CRUD Operations</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #7dd3fc;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö CRUD Operations - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</h1>
    
    <div class="test-container">
        <h2>üìã ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
        <button onclick="runAllTests()" id="runBtn">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button onclick="testFrontendIntegration()">üñ•Ô∏è ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Frontend Service</button>
        <button onclick="testRealTimeFeatures()">‚ö° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Real-time</button>
        <div id="results"></div>
    </div>

    <div class="test-container">
        <h2>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
        <div id="stats">
            <div>‚úÖ ‡∏ú‡πà‡∏≤‡∏ô: <span id="passCount">0</span></div>
            <div>‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: <span id="failCount">0</span></div>
            <div>‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalTime">0</span>ms</div>
        </div>
    </div>

    <script type="module">
        // Import Supabase
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
        
        const supabase = createClient(
            'https://vuitwzisazvikrhtfthh.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1aXR3emlzYXp2aWtyaHRmdGhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzOTU4ODIsImV4cCI6MjA2Njk3MTg4Mn0.VXCqythCUualJ7S9jVvnQUYe9BKnfMvbihtZT5c3qyE'
        )

        let passCount = 0
        let failCount = 0
        let startTime = 0
        
        function logResult(message, success = true) {
            const resultsDiv = document.getElementById('results')
            const div = document.createElement('div')
            div.className = `test-result ${success ? 'success' : 'error'}`
            div.innerHTML = `${success ? '‚úÖ' : '‚ùå'} ${message}`
            resultsDiv.appendChild(div)
            resultsDiv.scrollTop = resultsDiv.scrollHeight
            
            if (success) passCount++
            else failCount++
            
            updateStats()
        }
        
        function logInfo(message) {
            const resultsDiv = document.getElementById('results')
            const div = document.createElement('div')
            div.className = 'test-result info'
            div.innerHTML = `‚ÑπÔ∏è ${message}`
            resultsDiv.appendChild(div)
            resultsDiv.scrollTop = resultsDiv.scrollHeight
        }
        
        function updateStats() {
            document.getElementById('passCount').textContent = passCount
            document.getElementById('failCount').textContent = failCount
            document.getElementById('totalTime').textContent = Date.now() - startTime
        }
        
        async function runAllTests() {
            startTime = Date.now()
            passCount = 0
            failCount = 0
            document.getElementById('results').innerHTML = ''
            document.getElementById('runBtn').disabled = true
            document.getElementById('runBtn').className = 'loading'
            
            try {
                logInfo('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™Ÿà‡∏ö CRUD Operations ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...')
                
                // Test 1: Read existing data
                await testReadOperations()
                
                // Test 2: Create operations
                await testCreateOperations()
                
                // Test 3: Update operations  
                await testUpdateOperations()
                
                // Test 4: Real-time features
                await testRealTimeFeatures()
                
                // Test 5: Error handling
                await testErrorHandling()
                
                logInfo(`‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡∏ú‡πà‡∏≤‡∏ô: ${passCount}, ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: ${failCount}`)
                
            } catch (error) {
                logResult(`‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, false)
            } finally {
                document.getElementById('runBtn').disabled = false
                document.getElementById('runBtn').className = ''
            }
        }
        
        async function testReadOperations() {
            logInfo('1Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (READ)...')
            
            try {
                // Test reading courses
                const { data: courses, error: coursesError } = await supabase
                    .from('teaching_courses')
                    .select('*')
                    .limit(5)
                
                if (coursesError) throw coursesError
                
                logResult(`‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™: ‡∏û‡∏ö ${courses?.length || 0} ‡∏Ñ‡∏≠‡∏£‡πå‡∏™`)
                
                // Test reading schedules with JOIN
                const { data: schedules, error: schedulesError } = await supabase
                    .from('teaching_schedules')
                    .select(`
                        *,
                        teaching_courses(id, name, company_color)
                    `)
                    .limit(3)
                
                if (schedulesError) throw schedulesError
                
                logResult(`‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á + JOIN: ‡∏û‡∏ö ${schedules?.length || 0} ‡∏ï‡∏≤‡∏£‡∏≤‡∏á`)
                
                // Test specific week query
                const weekStart = getWeekStartDate(new Date())
                const { data: weekSchedules, error: weekError } = await supabase
                    .from('teaching_schedules')
                    .select('*')
                    .eq('week_start_date', weekStart)
                    .eq('company', 'login')
                
                if (weekError) throw weekError
                
                logResult(`‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ: ‡∏û‡∏ö ${weekSchedules?.length || 0} ‡∏ï‡∏≤‡∏£‡∏≤‡∏á`)
                
            } catch (error) {
                logResult(`‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, false)
            }
        }
        
        async function testCreateOperations() {
            logInfo('2Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (CREATE)...')
            
            try {
                // Need to be authenticated to create
                const { data: { user } } = await supabase.auth.getUser()
                
                if (!user) {
                    logResult('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á', false)
                    return
                }
                
                // Test create course
                const testCourse = {
                    name: `‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏£‡πå‡∏™ ${Date.now()}`,
                    company: 'Login Learning',
                    location: '‡∏®‡∏£‡∏µ‡∏£‡∏≤‡∏ä‡∏≤',
                    company_color: '#6366f1',
                    duration_hours: 2,
                    description: '‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å UI'
                }
                
                const { data: newCourse, error: createError } = await supabase
                    .from('teaching_courses')
                    .insert(testCourse)
                    .select()
                    .single()
                
                if (createError) throw createError
                
                logResult(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${newCourse.name}`)
                window.testCourseId = newCourse.id
                
                // Test create schedule
                const testSchedule = {
                    week_start_date: getWeekStartDate(new Date()),
                    company: 'login',
                    day_of_week: 1,
                    time_slot_index: 10,
                    duration: 2,
                    course_id: newCourse.id,
                    course_title: newCourse.name,
                    instructor_name: '‡∏Ñ‡∏£‡∏π‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
                    room: '‡∏´‡πâ‡∏≠‡∏á A1',
                    color: '#6366f1'
                }
                
                const { data: newSchedule, error: scheduleError } = await supabase
                    .from('teaching_schedules')
                    .insert(testSchedule)
                    .select()
                    .single()
                
                if (scheduleError) throw scheduleError
                
                logResult(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${newSchedule.course_title}`)
                window.testScheduleId = newSchedule.id
                
            } catch (error) {
                logResult(`‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, false)
            }
        }
        
        async function testUpdateOperations() {
            logInfo('3Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (UPDATE)...')
            
            try {
                if (window.testCourseId) {
                    // Test update course
                    const { data: updatedCourse, error: updateError } = await supabase
                        .from('teaching_courses')
                        .update({
                            name: `‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏£‡πå‡∏™ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß) ${Date.now()}`,
                            duration_hours: 3
                        })
                        .eq('id', window.testCourseId)
                        .select()
                        .single()
                    
                    if (updateError) throw updateError
                    
                    logResult(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${updatedCourse.name}`)
                }
                
                if (window.testScheduleId) {
                    // Test move schedule
                    const { data: movedSchedule, error: moveError } = await supabase
                        .from('teaching_schedules')
                        .update({
                            day_of_week: 2,
                            time_slot_index: 11
                        })
                        .eq('id', window.testScheduleId)
                        .select()
                        .single()
                    
                    if (moveError) throw moveError
                    
                    logResult(`‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏ß‡∏±‡∏ô ${movedSchedule.day_of_week} ‡πÄ‡∏ß‡∏•‡∏≤ ${movedSchedule.time_slot_index}`)
                    
                    // Test resize schedule
                    const { data: resizedSchedule, error: resizeError } = await supabase
                        .from('teaching_schedules')
                        .update({ duration: 3 })
                        .eq('id', window.testScheduleId)
                        .select()
                        .single()
                    
                    if (resizeError) throw resizeError
                    
                    logResult(`‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${resizedSchedule.duration} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`)
                }
                
            } catch (error) {
                logResult(`‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, false)
            }
        }
        
        async function testRealTimeFeatures() {
            logInfo('4Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Real-time Features...')
            
            try {
                // Test subscription setup
                const channel = supabase
                    .channel(`test-schedules-${Date.now()}`)
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'teaching_schedules'
                    }, (payload) => {
                        logResult(`Real-time update ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${payload.eventType}`)
                    })
                
                const subscription = await channel.subscribe()
                
                if (subscription === 'SUBSCRIBED') {
                    logResult('Real-time subscription ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ')
                    
                    // Cleanup
                    setTimeout(() => {
                        supabase.removeChannel(channel)
                    }, 1000)
                } else {
                    logResult('Real-time subscription ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', false)
                }
                
            } catch (error) {
                logResult(`Real-time features ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, false)
            }
        }
        
        async function testErrorHandling() {
            logInfo('5Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î...')
            
            try {
                // Test duplicate insert (should fail)
                if (window.testScheduleId) {
                    const { error } = await supabase
                        .from('teaching_schedules')
                        .insert({
                            week_start_date: getWeekStartDate(new Date()),
                            company: 'login',
                            day_of_week: 2, // Same as updated schedule
                            time_slot_index: 11, // Same as updated schedule  
                            duration: 1,
                            course_title: 'Duplicate Test',
                            instructor_name: 'Test'
                        })
                    
                    if (error) {
                        logResult('Constraint violation ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á')
                    } else {
                        logResult('Constraint validation ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', false)
                    }
                }
                
                // Test invalid foreign key
                const { error: fkError } = await supabase
                    .from('teaching_schedules')
                    .insert({
                        week_start_date: getWeekStartDate(new Date()),
                        company: 'login',
                        day_of_week: 0,
                        time_slot_index: 0,
                        course_id: '00000000-0000-0000-0000-000000000000', // Invalid ID
                        course_title: 'FK Test',
                        instructor_name: 'Test'
                    })
                
                if (fkError) {
                    logResult('Foreign key constraint ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á')
                } else {
                    logResult('Foreign key validation ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', false)
                }
                
            } catch (error) {
                logResult(`‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö error handling: ${error.message}`)
            }
        }
        
        async function testFrontendIntegration() {
            logInfo('üñ•Ô∏è ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Frontend Service Integration...')
            
            try {
                // Test if we can load the teaching schedule service
                const response = await fetch('http://localhost:5174/src/lib/teachingScheduleService.js')
                
                if (response.ok) {
                    logResult('Frontend service accessible')
                } else {
                    logResult('Frontend service ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ', false)
                }
                
                // Test main schedule page
                const pageResponse = await fetch('http://localhost:5174/#/admin/teaching-schedule')
                
                if (pageResponse.ok) {
                    logResult('Teaching schedule page accessible')
                } else {
                    logResult('Teaching schedule page ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ', false)
                }
                
            } catch (error) {
                logResult(`Frontend integration test: ${error.message}`, false)
            }
        }
        
        function getWeekStartDate(date) {
            const d = new Date(date)
            const day = d.getDay()
            const diff = d.getDate() - day + (day === 0 ? -6 : 1)
            const monday = new Date(d.setDate(diff))
            return monday.toISOString().split('T')[0]
        }
        
        // Cleanup function
        async function cleanup() {
            if (window.testScheduleId) {
                await supabase
                    .from('teaching_schedules')
                    .delete()
                    .eq('id', window.testScheduleId)
            }
            
            if (window.testCourseId) {
                await supabase
                    .from('teaching_courses')
                    .delete()
                    .eq('id', window.testCourseId)
            }
        }
        
        // Expose functions to global scope
        window.runAllTests = runAllTests
        window.testFrontendIntegration = testFrontendIntegration
        window.testRealTimeFeatures = testRealTimeFeatures
        window.cleanup = cleanup
        
        // Auto cleanup on page unload
        window.addEventListener('beforeunload', cleanup)
    </script>
</body>
</html>