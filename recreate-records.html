<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recreate Records - Weekly Schedules</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover { background: #2563eb; }
        .btn.danger { background: #dc2626; }
        .btn.danger:hover { background: #b91c1c; }
        .log {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .success { color: #16a34a; }
        .error { color: #dc2626; }
        .warning { color: #ea580c; }
        .info { color: #0ea5e9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Recreate Records with Correct Time Format</h1>
        <p><strong>‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö records ‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ time format ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
        
        <div>
            <button id="checkBtn" class="btn">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°</button>
            <button id="recreateBtn" class="btn danger">üîÑ ‡∏•‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà</button>
            <button id="verifyBtn" class="btn">‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</button>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://vuitwzisazvikrhtfthh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1aXR3emlzYXp2aWtyaHRmdGhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzOTU4ODIsImV4cCI6MjA2Njk3MTg4Mn0.VXCqythCUualJ7S9jVvnQUYe9BKnfMvbihtZT5c3qyE';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);
        
        const logElement = document.getElementById('log');
        let originalRecords = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('th-TH');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        async function checkOriginalRecords() {
            log('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°...', 'info');
            
            try {
                const { data, error } = await supabaseClient
                    .from('weekly_schedules')
                    .select('*')
                    .in('id', [79, 83])
                    .order('id');
                
                if (error) {
                    log(`‚ùå Error: ${error.message}`, 'error');
                    return;
                }
                
                originalRecords = data;
                log('üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:', 'info');
                
                data.forEach(record => {
                    log(`  ID ${record.id}:`, 'info');
                    log(`    Time: ${record.time_slot} ‚Üí ${record.start_time} ‚Üí ${record.end_time}`, 'warning');
                    log(`    Day: ${record.day_of_week}, Duration: ${record.duration}`, 'info');
                    log(`    Course: ${record.course_id}`, 'info');
                    log(`    Instructor: ${record.instructor_id}`, 'info');
                    log(`    `, 'info');
                });
                
            } catch (error) {
                log(`üí• Unexpected error: ${error.message}`, 'error');
            }
        }
        
        async function recreateRecords() {
            if (originalRecords.length === 0) {
                log('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            log('üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£ Delete & Recreate...', 'warning');
            
            try {
                // ‡∏•‡∏ö records ‡πÄ‡∏î‡∏¥‡∏°
                for (const record of originalRecords) {
                    log(`üóëÔ∏è ‡∏•‡∏ö record ID ${record.id}...`, 'warning');
                    
                    const { error: deleteError } = await supabaseClient
                        .from('weekly_schedules')
                        .delete()
                        .eq('id', record.id);
                    
                    if (deleteError) {
                        log(`‚ùå ‡∏•‡∏ö record ${record.id} ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${deleteError.message}`, 'error');
                        continue;
                    }
                    
                    log(`‚úÖ ‡∏•‡∏ö record ${record.id} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á record ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ time format ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                    log(`‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á record ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ID ${record.id}...`, 'info');
                    
                    const newRecord = {
                        year: record.year,
                        week_number: record.week_number,
                        schedule_type: record.schedule_type,
                        instructor_id: record.instructor_id,
                        course_id: record.course_id,
                        day_of_week: record.day_of_week,
                        time_slot: record.time_slot === '8:00' ? '08:00' : record.time_slot,
                        start_time: record.start_time === '8:00' ? '08:00' : record.start_time,
                        end_time: record.end_time === '9:00' ? '09:00' : record.end_time,
                        duration: record.duration,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString(),
                        created_by: record.created_by
                    };
                    
                    const { data: newData, error: insertError } = await supabaseClient
                        .from('weekly_schedules')
                        .insert(newRecord)
                        .select()
                        .single();
                    
                    if (insertError) {
                        log(`‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á record ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${insertError.message}`, 'error');
                    } else {
                        log(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á record ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ID ${newData.id} (‡πÄ‡∏î‡∏¥‡∏°: ${record.id})`, 'success');
                        log(`    ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà: ${newData.time_slot} ‚Üí ${newData.start_time} ‚Üí ${newData.end_time}`, 'success');
                    }
                    
                    // ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                log('üéâ ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£ Recreate ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!', 'success');
                
            } catch (error) {
                log(`üí• Unexpected error: ${error.message}`, 'error');
            }
        }
        
        async function verifyResults() {
            log('üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå...', 'info');
            
            try {
                // ‡∏´‡∏≤ records ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ï‡πà time format ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                const { data, error } = await supabaseClient
                    .from('weekly_schedules')
                    .select('id, time_slot, start_time, end_time, day_of_week, duration, course_id')
                    .eq('day_of_week', 1) // Monday (‡∏à‡∏≤‡∏Å records ‡πÄ‡∏î‡∏¥‡∏°)
                    .eq('time_slot', '08:00')
                    .limit(10);
                
                if (error) {
                    log(`‚ùå Error: ${error.message}`, 'error');
                    return;
                }
                
                log('üìä Records ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ time format ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:', 'success');
                data.forEach(record => {
                    log(`  ID ${record.id}: ${record.time_slot} ‚Üí ${record.start_time} ‚Üí ${record.end_time} ‚úÖ`, 'success');
                });
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ records ‡∏ó‡∏µ‡πà‡∏°‡∏µ time format ‡∏ú‡∏¥‡∏î‡πÑ‡∏´‡∏°
                const { data: allData, error: allError } = await supabaseClient
                    .from('weekly_schedules')
                    .select('id, time_slot, start_time')
                    .limit(100);
                
                if (allError) {
                    log(`‚ùå Error checking all records: ${allError.message}`, 'error');
                    return;
                }
                
                const problematicRecords = allData.filter(record => 
                    !record.time_slot.match(/^[0-9]{2}:[0-9]{2}$/) || 
                    !record.start_time.match(/^[0-9]{2}:[0-9]{2}$/)
                );
                
                if (problematicRecords.length > 0) {
                    log(`‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡∏û‡∏ö records ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ time format: ${problematicRecords.length} records`, 'warning');
                    problematicRecords.forEach(record => {
                        log(`  ID ${record.id}: ${record.time_slot} ‚Üí ${record.start_time}`, 'warning');
                    });
                } else {
                    log('‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö records ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ time format ‡∏≠‡∏µ‡∏Å‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                }
                
            } catch (error) {
                log(`üí• Unexpected error: ${error.message}`, 'error');
            }
        }
        
        // Event listeners
        document.getElementById('checkBtn').addEventListener('click', checkOriginalRecords);
        document.getElementById('recreateBtn').addEventListener('click', recreateRecords);
        document.getElementById('verifyBtn').addEventListener('click', verifyResults);
        
        // Auto check on page load
        log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Recreate Records Tool', 'info');
        log('‚ö†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö records ‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà', 'warning');
        log('üí° ‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'info');
    </script>
</body>
</html>